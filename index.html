<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IPS Tracker">
    <meta name="theme-color" content="#0d1b2a">
    <meta name="application-name" content="IPS Tracker">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK (Compat mode — works without build tools) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <title>IPS Fluid Tracker</title>
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1b2838; color: #e0e0e0; min-height: 100vh; }
        
        /* Header - Compact */
        .well-name-banner { background: #060e18; padding: 8px 16px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #1a3050; cursor: pointer; min-height: 32px; }
        .well-name-banner-text { font-size: 15px; font-weight: 700; color: #ffd54f; letter-spacing: 0.5px; text-transform: uppercase; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90vw; }
        .well-name-banner-text.empty { font-size: 12px; color: rgba(255,213,79,0.4); font-weight: 500; letter-spacing: 0; text-transform: none; }
        .app-header { background: linear-gradient(135deg, #0d1b2a, #1b2838); padding: 8px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #2d4a6f; }
        .app-logo { height: 30px; width: auto; }
        .app-title { color: #e0e0e0; flex: 1; }
        .app-title h1 { font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
        .app-title p { font-size: 9px; opacity: 0.7; }
        .header-actions { display: flex; gap: 6px; }
        .header-btn { background: #2d4a6f; border: none; color: #4fc3f7; padding: 6px 10px; border-radius: 6px; font-size: 14px; cursor: pointer; }
        
        /* Master Tabs */
        .master-tabs { display: flex; background: #060e18; border-bottom: 1px solid #1a3050; }
        .master-tab { flex: 1; padding: 14px 4px; border: none; background: transparent; font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.3); cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: all 0.2s; position: relative; }
        .master-tab.active { color: #4fc3f7; background: #0d1b2a; }
        .master-tab.active::after { content: ''; position: absolute; bottom: 0; left: 15%; right: 15%; height: 3px; background: #4fc3f7; border-radius: 3px 3px 0 0; }
        .master-section { display: none; }
        .master-section.active { display: block; }

        /* Sub Tabs (Fluids) */
        .main-tabs { display: flex; background: #0d1b2a; border-bottom: 2px solid #2d4a6f; position: relative; padding: 0 2px; }
        .main-tab { flex: 1; padding: 12px 4px; border: 2px solid transparent; background: transparent; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.4); cursor: pointer; position: relative; margin-bottom: -2px; border-radius: 8px 8px 0 0; transition: all 0.15s; }
        .main-tab.active { background: #1b2838; color: #4fc3f7; border-color: #2d4a6f; border-bottom-color: #1b2838; }

        /* Sub Tabs (Wellbore) */
        .wb-tabs { display: flex; background: #0d1b2a; border-bottom: 2px solid #2d4a6f; position: relative; padding: 0 2px; }
        .wb-tab { flex: 1; padding: 12px 4px; border: 2px solid transparent; background: transparent; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.4); cursor: pointer; position: relative; margin-bottom: -2px; border-radius: 8px 8px 0 0; transition: all 0.15s; }
        .wb-tab.active { background: #1b2838; color: #4fc3f7; border-color: #2d4a6f; border-bottom-color: #1b2838; }
        .wb-content { display: none; }
        .wb-content.active { display: block; }
        .plug-container { padding: 12px; padding-bottom: 80px; }
        .plug-header-banner { background: linear-gradient(135deg, #1a365d, #243447); border-radius: 10px; padding: 14px; margin-bottom: 14px; border: 1px solid #2d4a6f; display: flex; justify-content: space-between; align-items: center; }
        .plug-header-item { text-align: center; flex: 1; }
        .plug-header-label { font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .plug-header-value { font-size: 20px; font-weight: 700; color: #4fc3f7; }
        .plug-header-value .plug-total { font-size: 13px; color: #888; font-weight: 400; }
        .plug-header-divider { width: 1px; height: 36px; background: #2d4a6f; }
        .wb-placeholder { text-align: center; padding: 60px 20px; color: #556; }
        .wb-placeholder svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
        .wb-placeholder h3 { font-size: 16px; color: #8899aa; margin-bottom: 8px; }
        .wb-placeholder p { font-size: 12px; color: #556; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Controls */
        .controls { display: flex; gap: 8px; padding: 10px; background: #243447; border-bottom: 1px solid #2d4a6f; }
        .ctrl-btn { flex: 1; border: none; padding: 10px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .ctrl-btn.green { background: #2e7d32; color: white; }
        .ctrl-btn.blue { background: #1565c0; color: white; }
        
        /* Side Toggle */
        .side-toggle, .modal-tabs { display: flex; background: #0d1b2a; border-radius: 8px; padding: 4px; margin: 10px; }
        .side-tab, .modal-tab { flex: 1; padding: 10px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: #888; border-radius: 6px; cursor: pointer; }
        .side-tab.active, .modal-tab.active { background: #2d4a6f; color: #4fc3f7; }
        
        /* Tank Cards */
        .tanks-container { padding: 8px; display: none; }
        .tanks-container.active { display: block; }
        .tank-card { background: #243447; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid #546e7a; box-shadow: 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.06); position: relative; overflow: hidden; }
        .tank-card.border-brine10 { border-left-color: #42a5f5; }
        .tank-card.border-brine119 { border-left-color: #1e88e5; }
        .tank-card.border-aphron { border-left-color: #8d6e63; }
        .tank-card.border-recirc { border-left-color: #ab47bc; }
        .tank-card.border-freshwater { border-left-color: #26a69a; }
        .tank-card.border-mud { border-left-color: #8d6e63; }
        .tank-card.border-mixed { border-left-color: #78909c; }
        .tank-card.border-trash { border-left-color: #ef5350; }
        .tank-card.border-sandcat { border-left-color: #ffa726; }
        .tank-card.border-processed { border-left-color: #ab47bc; }
        .tank-card.border-packer { border-left-color: #ff7043; }
        .tank-card.border-other { border-left-color: #78909c; }
        
        .tank-header { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; margin-bottom: 10px; padding-right: 28px; }
        .tank-header-top { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .tank-header-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .tank-name { font-size: 15px; font-weight: 700; color: #e0e0e0; letter-spacing: 0.3px; }
        .tank-name.color-brine10 { color: #42a5f5; }
        .tank-name.color-brine119 { color: #1e88e5; }
        .tank-name.color-aphron { color: #a1887f; }
        .tank-name.color-recirc { color: #ba68c8; }
        .tank-name.color-freshwater { color: #4db6ac; }
        .tank-name.color-mud { color: #a1887f; }
        .tank-name.color-mixed { color: #90a4ae; }
        .tank-name.color-trash { color: #ef5350; }
        .tank-name.color-sandcat { color: #ffa726; }
        .tank-name.color-processed { color: #ba68c8; }
        .tank-name.color-packer { color: #ff7043; }
        .tank-name.color-return { color: #ffd54f; }
        
        .tank-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.3); }
        .badge-brine10 { background: rgba(66,165,245,0.2); color: #42a5f5; }
        .badge-brine119 { background: rgba(30,136,229,0.2); color: #1e88e5; }
        .badge-aphron { background: rgba(141,110,99,0.2); color: #a1887f; }
        .badge-recirc { background: rgba(171,71,188,0.2); color: #ba68c8; }
        .badge-freshwater { background: rgba(38,166,154,0.2); color: #4db6ac; }
        .badge-mud { background: rgba(141,110,99,0.2); color: #a1887f; }
        .badge-mixed { background: rgba(120,144,156,0.2); color: #90a4ae; }
        .badge-trash { background: rgba(239,83,80,0.2); color: #ef5350; }
        .badge-sandcat { background: rgba(255,167,38,0.2); color: #ffa726; }
        .badge-processed { background: rgba(171,71,188,0.2); color: #ba68c8; }
        .badge-packer { background: rgba(255,112,67,0.2); color: #ff7043; }
        .badge-other { background: rgba(120,144,156,0.2); color: #90a4ae; }
        .badge-estimated { background: rgba(255,167,38,0.3); color: #ffa726; border: 1px dashed #ffa726; }
        .badge-treated { background: rgba(76,175,80,0.25); color: #66bb6a; border: 1px solid rgba(102,187,106,0.4); }
        .badge-untreated { background: rgba(239,83,80,0.25); color: #ef5350; border: 1px solid rgba(239,83,80,0.4); }
        .badge-strap { background: rgba(102,187,106,0.2); color: #66bb6a; font-size: 9px; margin-left: auto; white-space: nowrap; border: 1px solid rgba(102,187,106,0.3); }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ffffff; font-size: 18px; cursor: pointer; text-shadow: 0 0 3px rgba(255,255,255,0.15); }
        
        .tank-inputs { display: flex; gap: 10px; align-items: flex-end; }
        .input-group { flex: 0 0 auto; }
        .input-group.inches-group { flex: 0 0 85px; }
        .inches-label-row { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
        .inches-label-row label { font-size: 10px; color: #888; text-transform: uppercase; text-shadow: 0 0 3px rgba(255,255,255,0.1); margin-bottom: 0; }
        .inches-est-badge { padding: 1px 5px; border-radius: 3px; font-size: 8px; font-weight: 700; background: rgba(255,167,38,0.3); color: #ffa726; border: 1px dashed #ffa726; text-transform: uppercase; line-height: 1.2; }
        .input-group.contains-group { flex: 0 0 100px; }
        .input-group label { display: block; font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 4px; text-shadow: 0 0 3px rgba(255,255,255,0.1); }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #2d4a6f; border-radius: 6px; font-size: 16px; background: #1b2838; color: #ffffff; box-shadow: 0 0 0 1px rgba(255,255,255,0.06); }
        .input-group input.estimated { background: rgba(255,167,38,0.15); border-color: #ffa726; }
        
        .bbl-mic-group { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .bbl-display { text-align: right; min-width: 60px; }
        .bbl-label { font-size: 10px; color: #888; text-transform: uppercase; text-shadow: 0 0 3px rgba(255,255,255,0.1); }
        .bbl-value { font-size: 28px; font-weight: 800; color: #ffffff; }
        
        .full-btn { position: absolute; top: 6px; left: 50%; transform: translateX(-50%); background: #ff9800; color: white; border: none; padding: 4px 14px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; z-index: 2; }
        
        /* Jet Section - Matching dark aesthetic */
        .jet-section { background: #243447; padding: 12px; margin: 8px; border-radius: 8px; border: 1px solid #2d4a6f; }
        .jet-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #4fc3f7; text-transform: uppercase; letter-spacing: 0.5px; }
        .jet-toggle { display: flex; background: #0d1b2a; border-radius: 6px; padding: 3px; margin-bottom: 10px; }
        .jet-toggle-btn { flex: 1; padding: 8px; border: none; background: transparent; font-size: 12px; font-weight: 600; color: #888; border-radius: 4px; cursor: pointer; }
        .jet-toggle-btn.active.out { background: #c62828; color: white; }
        .jet-toggle-btn.active.in { background: #2e7d32; color: white; }
        .jet-toggle-btn.active.build { background: #6d4c41; color: white; }
        .jet-row { display: flex; gap: 8px; align-items: center; }
        .jet-row select, .jet-row input { flex: 1; padding: 8px; border: 1px solid #2d4a6f; border-radius: 6px; font-size: 14px; background: #1b2838; color: #e0e0e0; }
        .jet-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; }
        .jet-btn.out { background: #c62828; }
        .jet-btn.in { background: #2e7d32; }
        .jet-btn.build { background: #6d4c41; }
        
        /* Totals Bar */
        .totals-bar { display: flex; justify-content: space-around; padding: 10px 8px; background: #243447; border-bottom: 1px solid #2d4a6f; flex-wrap: wrap; gap: 6px; }
        .total-item { text-align: center; padding: 6px 8px; border-radius: 6px; min-width: 48px; background: #1b2838; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .total-item:active { transform: scale(0.95); }
        .total-item.filter-active { border-color: currentColor; background: rgba(255,255,255,0.08); }
        .total-label { font-size: 8px; color: #888; text-transform: uppercase; font-weight: 600; }
        .total-item.filter-active .total-label { color: #ccc; }
        .total-value { font-size: 15px; font-weight: 700; }
        .total-value.brine { color: #42a5f5; }
        .total-value.packer { color: #ff7043; }
        .total-value.mud { color: #a1887f; }
        .total-value.recirc { color: #ba68c8; }
        .total-value.freshwater { color: #4db6ac; }
        .total-value.other { color: #90a4ae; }
        
        /* System Totals */
        .system-totals { display: flex; justify-content: space-around; padding: 12px; background: #0d1b2a; align-items: center; gap: 10px; }
        .system-total { text-align: center; }
        .system-total-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .system-total-value { font-size: 20px; font-weight: 700; color: #e0e0e0; }
        .system-total-value.jetted { color: #ffa726; }
        .reset-shift-btn { background: #2d4a6f; border: none; color: #e0e0e0; padding: 8px 14px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600; }
        
        .report-btn { display: block; width: calc(100% - 24px); margin: 12px; padding: 14px; background: #1565c0; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        /* Gain/Loss Bar */
        .gain-loss-bar { display: flex; gap: 8px; padding: 8px 10px; background: #243447; }
        .gl-box { flex: 1; background: #1b2838; border-radius: 6px; padding: 6px; text-align: center; }
        .gl-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .gl-value { font-size: 14px; font-weight: 700; }
        .gl-value.gain { color: #4caf50; }
        .gl-value.loss { color: #ef5350; }
        .gl-value.neutral { color: #888; }
        .gl-sublabel { font-size: 8px; color: #666; margin-top: 2px; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #666; font-size: 14px; }
        
        /* Titration Styles */
        .titration-container { padding: 12px; padding-bottom: 80px; }
        .tit-card { background: #243447; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .tit-title { font-size: 12px; font-weight: 600; color: #4fc3f7; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #2d4a6f; padding-bottom: 8px; }
        .tit-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #2d4a6f; }
        .tit-row:last-child { border-bottom: none; }
        .tit-label { flex: 1; font-size: 14px; color: #e0e0e0; font-weight: 500; }
        .tit-input { width: 80px; padding: 8px; border: 1px solid #2d4a6f; border-radius: 6px; font-size: 16px; text-align: center; background: #1b2838; color: #e0e0e0; }
        .tit-unit { width: 50px; font-size: 12px; color: #888; text-align: center; }
        .tit-result { min-width: 90px; font-size: 18px; font-weight: 700; color: #4caf50; text-align: right; }
        .tit-result.calculated { background: rgba(76,175,80,0.15); padding: 4px 8px; border-radius: 4px; }
        .tit-note { font-size: 10px; color: #ffa726; margin-top: 6px; font-style: italic; }
        .distilled-warning { background: rgba(255,167,38,0.15); border-left: 3px solid #ffa726; padding: 8px 12px; margin: 8px 0; font-size: 11px; color: #ffa726; border-radius: 0 4px 4px 0; }
        .fluid-select { margin-bottom: 12px; }
        .fluid-select select { width: 100%; padding: 12px; border: 1px solid #2d4a6f; border-radius: 8px; font-size: 16px; font-weight: 600; background: #1b2838; color: #e0e0e0; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0d1b2a; z-index: 100; flex-direction: column; overflow: hidden; }
        .modal.show { display: flex; }
        .modal-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px; padding-bottom: 40px; }
        .modal-title { font-size: 18px; font-weight: 600; color: #4fc3f7; margin-bottom: 16px; text-align: center; }
        .modal-group { margin-bottom: 12px; }
        .modal-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .modal-group select { width: 100%; padding: 10px; border: 1px solid #2d4a6f; border-radius: 6px; font-size: 14px; background: #1b2838; color: #e0e0e0; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 16px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn.cancel { background: #2d4a6f; color: #e0e0e0; }
        .modal-btn.confirm { background: #2e7d32; color: white; }
        
        .equalize-info { background: rgba(255,167,38,0.15); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #ffa726; }
        .equalize-tanks { margin-top: 8px; font-weight: 600; color: #e0e0e0; }
        .equalize-buttons { display: flex; flex-direction: column; gap: 8px; }
        .equalize-btn { padding: 14px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .equalize-btn.yes { background: #4caf50; color: white; }
        .equalize-btn.no { background: #2d4a6f; color: #e0e0e0; }
        .equalize-btn.cancel { background: transparent; color: #888; }
        
        /* Report Screens */
        .report-screen { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1b2838; z-index: 200; overflow-y: auto; }
        .report-screen.show { display: block; }
        .report-header { background: linear-gradient(135deg, #0d1b2a, #1b2838); color: white; padding: 16px; text-align: center; position: relative; border-bottom: 1px solid #2d4a6f; }
        .report-header h1 { font-size: 14px; margin-bottom: 4px; color: #4fc3f7; }
        .report-header p { font-size: 11px; opacity: 0.7; }
        .report-close { position: absolute; top: 10px; right: 10px; background: #2d4a6f; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .report-body { padding: 16px; }
        .report-section { margin-bottom: 16px; }
        .report-section-title { font-size: 11px; font-weight: 600; color: #4fc3f7; text-transform: uppercase; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #2d4a6f; }
        .report-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #2d4a6f; font-size: 13px; }
        .report-row-label { color: #e0e0e0; }
        .report-row-value { font-weight: 600; color: #ffd54f; }
        .report-totals { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .report-total-item { flex: 1; min-width: 70px; padding: 10px; border-radius: 8px; text-align: center; background: #243447; }
        .report-total-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .report-total-value { font-size: 18px; font-weight: 700; }
        .report-system-totals { display: flex; gap: 10px; margin-top: 16px; }
        .report-system-box { flex: 1; padding: 14px; border-radius: 8px; text-align: center; }
        .report-system-box.total { background: #0d1b2a; color: #e0e0e0; }
        .report-system-box.jetted { background: #e65100; color: white; }
        .report-system-label { font-size: 9px; opacity: 0.8; text-transform: uppercase; }
        .report-system-value { font-size: 22px; font-weight: 700; }
        .report-timestamp { text-align: center; font-size: 10px; color: #666; margin-top: 16px; padding-top: 16px; border-top: 1px solid #2d4a6f; }
        .report-logo { text-align: center; margin-bottom: 10px; }
        .report-logo img { height: 40px; }
        .report-company { text-align: center; font-size: 11px; color: #4fc3f7; font-weight: 600; margin-bottom: 14px; }
        
        /* Voice Entry Styles */
        .voice-master-btn, .ble-master-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: #1b2838; border: 2px solid #455a64; color: #455a64;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
        }
        .voice-master-btn svg, .ble-master-btn svg { width: 20px; height: 20px; }
        .voice-master-btn.active, .ble-master-btn.active {
            border-color: #66bb6a; color: #66bb6a;
            background: rgba(46,125,50,0.2); box-shadow: 0 0 8px rgba(102,187,106,0.4);
            animation: pulse 2s infinite;
        }
        .voice-master-btn.heard, .ble-master-btn.heard {
            border-color: #4fc3f7; color: #4fc3f7;
            background: rgba(79,195,247,0.15);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .voice-status {
            position: fixed; top: 60px; left: 10px; right: 10px;
            background: #0d1b2a; border: 1px solid #2d4a6f; border-radius: 8px;
            padding: 12px; text-align: center; z-index: 100; display: none;
        }
        .voice-status.show { display: block; }
        .voice-status-main { font-size: 18px; font-weight: 700; color: #4fc3f7; }
        .voice-status-sub { font-size: 12px; color: #888; margin-top: 4px; }
        
        .ble-status {
            position: fixed; top: 60px; left: 10px; right: 10px;
            background: #0a1628; border: 1px solid #1565c0; border-radius: 8px;
            padding: 12px; text-align: center; z-index: 99; display: none;
        }
        .ble-status.show { display: block; }
        .ble-status-main { font-size: 18px; font-weight: 700; color: #4fc3f7; }
        .ble-status-sub { font-size: 12px; color: #888; margin-top: 4px; }
        
        .tank-mic-btn, .tank-ble-btn {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: #1b2838; border: 2px solid #455a64;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
        }
        .tank-mic-btn svg, .tank-ble-btn svg { width: 16px; height: 16px; }
        .tank-mic-btn.configured { color: #455a64; }
        .tank-mic-btn.inactive, .tank-ble-btn.inactive { color: #455a64; }
        .tank-mic-btn.voice-waiting { border-color: #ff9800; color: #ff9800; background: rgba(255,152,0,0.15); animation: blePulse 1s ease-in-out infinite; }
        .tank-mic-btn.voice-done { border-color: #66bb6a; color: #66bb6a; background: rgba(46,125,50,0.25); box-shadow: 0 0 12px rgba(102,187,106,0.6); }
        .tank-mic-btn:hover, .tank-ble-btn:hover { background: #2d4a6f; }
        .tank-ble-btn.active { border-color: #66bb6a; color: #66bb6a; background: rgba(46,125,50,0.2); box-shadow: 0 0 8px rgba(102,187,106,0.4); }
        .tank-ble-btn.ble-waiting { border-color: #ff9800; color: #ff9800; background: rgba(255,152,0,0.15); animation: blePulse 1s ease-in-out infinite; }
        .tank-ble-btn.ble-done { border-color: #66bb6a; color: #66bb6a; background: rgba(46,125,50,0.25); box-shadow: 0 0 12px rgba(102,187,106,0.6); animation: bleDoneFade 1.5s ease-out forwards; }
        @keyframes bleDoneFade { 0%,40%{border-color:#66bb6a;color:#66bb6a;background:rgba(46,125,50,0.25);box-shadow:0 0 12px rgba(102,187,106,0.6)} 100%{border-color:#455a64;color:#455a64;background:transparent;box-shadow:none} }
        @keyframes blePulse { 0%,100% { opacity: 1; box-shadow: 0 0 4px rgba(255,152,0,0.3); } 50% { opacity: 0.4; box-shadow: 0 0 12px rgba(255,152,0,0.7); } }

        /* Tank Group Bar */
        .filtered-tanks { display: none; padding: 10px; }
        .filtered-tanks.active { display: block; }
        .filtered-side-label { font-size: 10px; color: #4fc3f7; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; padding: 8px 4px 4px; margin-top: 6px; }
        .filtered-side-label:first-child { margin-top: 0; }
        
        /* Settings Dropdown in Profile Modal */
        .profile-divider { border: none; border-top: 1px solid #2d4a6f; margin: 16px 0; }
        .profile-section-label { font-size: 11px; color: #4fc3f7; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600; }
        .profile-action-btn { width: 100%; padding: 12px; border: 1px solid #2d4a6f; border-radius: 6px; background: #1b2838; color: #e0e0e0; font-size: 14px; font-weight: 500; cursor: pointer; text-align: left; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .profile-action-btn:hover { background: #2d4a6f; }
        .profile-action-btn .action-icon { font-size: 18px; }
        /* Collapsible Settings Sections */
        .settings-accordion { margin-bottom: 8px; border: 1px solid #2d4a6f; border-radius: 8px; overflow: hidden; }
        .settings-acc-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: #1b2838; cursor: pointer; user-select: none; }
        .settings-acc-header:active { background: #2d4a6f; }
        .settings-acc-title { font-size: 13px; font-weight: 600; color: #4fc3f7; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .settings-acc-chevron { color: #4fc3f7; font-size: 14px; transition: transform 0.2s; }
        .settings-accordion.open .settings-acc-chevron { transform: rotate(180deg); }
        .settings-acc-body { display: none; padding: 12px 14px; background: #0d1b2a; }
        .settings-accordion.open .settings-acc-body { display: block; }
        .settings-acc-status { font-size: 11px; color: #888; font-weight: 400; text-transform: none; letter-spacing: 0; }
        /* Timecard styles */
        .tc-day-card { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #1b2838; border-radius: 6px; margin-bottom: 6px; border: 1px solid #2d4a6f; }
        .tc-day-card .tc-date { font-size: 12px; color: #4fc3f7; font-weight: 600; min-width: 80px; }
        .tc-day-card .tc-well { font-size: 11px; color: #ffa726; flex: 1; margin: 0 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tc-day-card .tc-hours { font-size: 12px; color: #66bb6a; font-weight: 600; white-space: nowrap; }
        .tc-day-card .tc-actions { display: flex; gap: 4px; margin-left: 6px; }
        .tc-day-card .tc-action-btn { background: none; border: 1px solid #2d4a6f; color: #888; width: 28px; height: 28px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .tc-day-card .tc-action-btn:hover { background: #2d4a6f; color: #e0e0e0; }
        .tc-log-btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tc-log-full { background: #2e7d32; color: white; }
        .tc-log-shutdown { background: #e65100; color: white; }
        .tc-log-custom { background: #1b2838; color: #e0e0e0; border: 1px solid #2d4a6f; }
        .tc-preview-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0d1b2a; z-index: 250; flex-direction: column; overflow: hidden; }
        .tc-preview-overlay.show { display: flex; }
        .tc-preview-body { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 16px; }
        .tc-preview-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .tc-preview-table th { background: #1b2838; color: #4fc3f7; padding: 6px 4px; border: 1px solid #2d4a6f; font-size: 10px; text-transform: uppercase; }
        .tc-preview-table td { padding: 5px 4px; border: 1px solid #2d4a6f; color: #e0e0e0; }
        .tc-preview-table .tc-week-header { background: #0a2a4a; color: #ffa726; font-weight: 700; text-align: center; }
        .tc-preview-table .tc-totals { background: #1b2838; font-weight: 600; color: #66bb6a; }
        
        
        /* Voice highlight removed - mic icon states handle feedback */
        
        /* Voice Keyword Modal */
        .voice-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #0d1b2a; z-index: 300;
            flex-direction: column; overflow: hidden;
        }
        .voice-modal-overlay.show { display: flex; }
        .voice-modal {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 40px;
        }
        .voice-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .voice-modal-subtitle { font-size: 13px; color: #888; margin-bottom: 16px; }
        .voice-keyword-list { margin-bottom: 16px; max-height: 150px; overflow-y: auto; }
        .voice-keyword-item {
            display: flex; align-items: center; gap: 8px;
            background: #1b2838; padding: 10px 12px; border-radius: 6px; margin-bottom: 8px;
        }
        .voice-keyword-item span { flex: 1; color: #66bb6a; }
        .voice-keyword-item button {
            background: #c62828; border: none; color: white;
            width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .voice-keyword-input-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .voice-keyword-input {
            flex: 1; padding: 12px; border: 1px solid #2d4a6f; border-radius: 6px;
            background: #1b2838; color: #e0e0e0; font-size: 16px;
        }
        .voice-keyword-add-btn {
            padding: 12px 16px; background: #2e7d32; border: none; border-radius: 6px;
            color: white; font-weight: 600; cursor: pointer;
        }
        .voice-record-btn {
            width: 100%; padding: 14px; background: #1565c0; border: none; border-radius: 6px;
            color: white; font-weight: 600; cursor: pointer; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .voice-record-btn svg { width: 20px; height: 20px; }
        .voice-record-btn.recording { background: #c62828; animation: pulse 1s infinite; }
        .voice-modal-close {
            width: 100%; padding: 14px; background: #455a64; border: none; border-radius: 6px;
            color: white; font-weight: 600; cursor: pointer;
        }
        
        /* Chat Feed Button */
        .chat-feed-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: #1b2838; border: 2px solid #455a64; color: #455a64;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
        }
        .chat-feed-btn svg { width: 20px; height: 20px; }
        .chat-feed-btn.has-data { border-color: #25d366; color: #25d366; background: rgba(37,211,102,0.1); }

        /* Chat Feed Full-Screen Overlay */
        .chat-feed-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #1b2838; z-index: 500; flex-direction: column;
            overflow: hidden;
        }
        .chat-feed-overlay.show { display: flex; }
        .chat-feed-header {
            background: linear-gradient(135deg, #0d1b2a, #1b2838);
            padding: 12px 16px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid #2d4a6f; flex-shrink: 0;
        }
        .chat-feed-header-icon { color: #25d366; display: flex; align-items: center; }
        .chat-feed-header-icon svg { width: 24px; height: 24px; }
        .chat-feed-header-title { flex: 1; }
        .chat-feed-header-title h2 { font-size: 14px; font-weight: 600; color: #e0e0e0; margin: 0; }
        .chat-feed-header-title p { font-size: 10px; color: #888; margin: 0; }
        .chat-feed-close {
            background: #2d4a6f; border: none; color: white; width: 32px; height: 32px;
            border-radius: 50%; font-size: 18px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }
        .chat-feed-body { flex: 1; overflow-y: auto; padding: 12px; }
        .chat-feed-tabs {
            display: flex; background: #0d1b2a; border-radius: 8px; padding: 3px; margin-bottom: 12px;
        }
        .chat-feed-tab {
            flex: 1; padding: 10px; border: none; background: transparent;
            font-size: 13px; font-weight: 600; color: #888; border-radius: 6px; cursor: pointer;
        }
        .chat-feed-tab.active { background: #2d4a6f; color: #4fc3f7; }
        .chat-feed-input-area {
            background: #243447; border-radius: 8px; padding: 12px; margin-bottom: 12px;
            border: 1px solid #2d4a6f;
        }
        .chat-feed-textarea {
            width: 100%; min-height: 160px; padding: 10px; border: 1px solid #2d4a6f;
            border-radius: 6px; background: #1b2838; color: #e0e0e0; font-size: 13px;
            font-family: 'Courier New', monospace; resize: vertical; line-height: 1.5;
        }
        .chat-feed-textarea::placeholder { color: #556; }
        .chat-feed-upload-zone {
            border: 2px dashed #2d4a6f; border-radius: 8px; padding: 30px 16px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            background: #1b2838;
        }
        .chat-feed-upload-zone:hover, .chat-feed-upload-zone.dragover {
            border-color: #25d366; background: rgba(37,211,102,0.05);
        }
        .chat-feed-upload-zone svg { width: 40px; height: 40px; color: #455a64; margin-bottom: 8px; }
        .chat-feed-upload-zone p { color: #888; font-size: 13px; margin: 4px 0; }
        .chat-feed-upload-zone .upload-hint { font-size: 11px; color: #556; }
        .chat-feed-preview-img {
            max-width: 100%; max-height: 200px; border-radius: 6px; margin-top: 10px;
            border: 1px solid #2d4a6f;
        }
        .chat-feed-process-btn {
            width: 100%; padding: 14px; background: #25d366; color: #fff; border: none;
            border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: center;
            gap: 8px; transition: all 0.2s; letter-spacing: 0.3px;
        }
        .chat-feed-process-btn:disabled { background: #455a64; cursor: not-allowed; }
        .chat-feed-process-btn:not(:disabled):hover { background: #20bd5a; }
        .chat-feed-process-btn svg { width: 18px; height: 18px; }
        .chat-feed-results {
            background: #243447; border-radius: 8px; border: 1px solid #2d4a6f; overflow: hidden;
            margin-bottom: 12px;
        }
        .chat-feed-results-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-bottom: 1px solid #2d4a6f; background: #1b2838;
        }
        .chat-feed-results-title { font-size: 12px; font-weight: 600; color: #25d366; text-transform: uppercase; letter-spacing: 0.5px; }
        .chat-feed-results-count { font-size: 11px; color: #888; }
        .chat-feed-results-body { max-height: 50vh; overflow-y: auto; }
        .chat-feed-record {
            border-bottom: 1px solid #2d4a6f; padding: 10px 12px;
        }
        .chat-feed-record:last-child { border-bottom: none; }
        .chat-feed-record-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        .chat-feed-record-plug { font-size: 15px; font-weight: 700; color: #4fc3f7; }
        .chat-feed-record-depth { font-size: 12px; color: #ffa726; }
        .chat-feed-record-time { font-size: 11px; color: #888; }
        .chat-feed-field-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px 16px;
        }
        .chat-feed-field {
            display: flex; justify-content: space-between; padding: 3px 0;
            font-size: 11px; border-bottom: 1px solid rgba(45,74,111,0.3);
        }
        .chat-feed-field-label { color: #888; }
        .chat-feed-field-value { color: #e0e0e0; font-weight: 600; }
        .chat-feed-empty {
            text-align: center; padding: 30px; color: #556;
        }
        .chat-feed-empty svg { width: 48px; height: 48px; color: #334; margin-bottom: 10px; }
        .chat-feed-empty p { font-size: 13px; margin: 4px 0; }
        .chat-feed-history-section {
            margin-top: 12px;
        }
        .chat-feed-history-title {
            font-size: 11px; color: #4fc3f7; text-transform: uppercase; letter-spacing: 0.5px;
            font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .chat-feed-history-clear {
            background: #2d4a6f; border: none; color: #e0e0e0; padding: 3px 8px;
            border-radius: 4px; font-size: 9px; cursor: pointer;
        }
        .chat-feed-badge {
            position: absolute; top: -2px; right: -2px; background: #25d366; color: #fff;
            font-size: 9px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
        }
        .chat-feed-badge.show { display: flex; }
        .chat-feed-mud-section {
            background: #1b2838; border-radius: 6px; padding: 8px 10px; margin-top: 6px;
            border: 1px solid rgba(45,74,111,0.5);
        }
        .chat-feed-mud-title {
            font-size: 10px; color: #ffa726; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;
        }

        .profile-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: #1b2838; border: 2px solid #2d4a6f; color: #4fc3f7;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
            margin-left: 4px;
        }
        .profile-btn svg { width: 20px; height: 20px; }
        .profile-btn.has-profile { border-color: #4fc3f7; color: #4fc3f7; background: rgba(79,195,247,0.1); }
        
        .profile-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #0d1b2a; z-index: 300;
            flex-direction: column; overflow: hidden;
        }
        .profile-modal-overlay.show { display: flex; }
        .profile-modal {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px; padding-bottom: 40px;
        }
        .profile-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; text-align: center; color: #4fc3f7; }
        .profile-input-group { margin-bottom: 16px; }
        .profile-input-group label { display: block; font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 6px; }
        .profile-input-group input {
            width: 100%; padding: 12px; border: 1px solid #2d4a6f; border-radius: 6px;
            background: #1b2838; color: #e0e0e0; font-size: 16px;
        }
        .profile-initials-preview {
            text-align: center; margin-bottom: 16px; padding: 12px;
            background: #1b2838; border-radius: 8px;
        }
        .profile-initials-label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .profile-initials-value { font-size: 24px; font-weight: 700; color: #66bb6a; }
        .profile-save-btn {
            width: 100%; padding: 14px; background: #2e7d32; border: none; border-radius: 6px;
            color: white; font-weight: 600; cursor: pointer; margin-bottom: 10px;
        }
        .profile-clear-btn {
            width: 100%; padding: 14px; background: #455a64; border: none; border-radius: 6px;
            color: white; font-weight: 600; cursor: pointer;
        }

        /* Log Edit Modal */
        .log-edit-overlay { position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:999; }
        .log-edit-panel { position:fixed;top:0;left:0;right:0;bottom:0;background:#0d1b2a;z-index:1000;display:flex;flex-direction:column;overflow:hidden; }
        .log-edit-header { display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#1b2838;border-bottom:1px solid #2d4a6f;flex-shrink:0; }
        .log-edit-title { font-size:16px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px; }
        .log-edit-close-btn { background:none;border:1px solid #2d4a6f;color:#e0e0e0;width:32px;height:32px;border-radius:6px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center; }
        .log-edit-clear-btn { background:#5a2020;border:1px solid #ef5350;color:#ef5350;padding:6px 12px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px; }
        .log-edit-body { flex:1;overflow-y:auto;padding:12px;padding-bottom:80px; }
        .log-edit-entry { background:#1b2838;border-radius:8px;margin-bottom:10px;overflow:hidden;border:1px solid #2d4a6f; }
        .log-edit-entry-header { display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;background:#243447; }
        .log-edit-entry-header:active { background:#2d4a6f; }
        .log-edit-entry-title { font-weight:600;color:#e0e0e0;font-size:13px; }
        .log-edit-entry-sub { font-size:10px;color:#888; }
        .log-edit-entry-actions { display:flex;gap:8px;align-items:center; }
        .log-edit-delete-btn { background:none;border:none;color:#ef5350;font-size:18px;cursor:pointer;padding:0 4px;line-height:1; }
        .log-edit-expand-icon { color:#888;font-size:14px;transition:transform 0.2s; }
        .log-edit-entry.expanded .log-edit-expand-icon { transform:rotate(180deg); }
        .log-edit-entry-fields { display:none;padding:12px 14px;border-top:1px solid #2d4a6f; }
        .log-edit-entry.expanded .log-edit-entry-fields { display:block; }
        .log-edit-field { display:flex;align-items:center;margin-bottom:8px;gap:8px; }
        .log-edit-field-label { font-size:11px;color:#888;min-width:80px;text-transform:uppercase; }
        .log-edit-field-input { flex:1;padding:8px 10px;background:#0d1b2a;border:1px solid #2d4a6f;border-radius:6px;color:#e0e0e0;font-size:13px;font-family:inherit; }
        .log-edit-field-input:focus { border-color:#4fc3f7;outline:none; }
        .log-edit-field-select { flex:1;padding:8px 10px;background:#0d1b2a;border:1px solid #2d4a6f;border-radius:6px;color:#e0e0e0;font-size:13px; }
        .log-edit-save-btn { width:100%;padding:14px;background:#1565c0;border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px;letter-spacing:0.5px; }
        .log-edit-save-btn:active { background:#0d47a1; }

        /* Sync Status Strip — sits under well name banner */
        .sync-strip { display:flex;align-items:center;justify-content:center;gap:6px;padding:3px 0;background:#060e18;border-bottom:1px solid #1a3050;font-size:10px;font-weight:600;letter-spacing:0.3px;transition:all 0.3s; }
        .sync-strip .sync-dot { width:6px;height:6px;border-radius:50%;flex-shrink:0; }
        .sync-strip.online { color:rgba(102,187,106,0.9); }
        .sync-strip.online .sync-dot { background:#66bb6a;box-shadow:0 0 4px rgba(102,187,106,0.6); }
        .sync-strip.offline { color:rgba(239,83,80,0.9); }
        .sync-strip.offline .sync-dot { background:#ef5350;box-shadow:0 0 4px rgba(239,83,80,0.5); }
        .sync-strip.syncing { color:rgba(255,167,38,0.9); }
        .sync-strip.syncing .sync-dot { background:#ffa726;box-shadow:0 0 4px rgba(255,167,38,0.5);animation:syncDotPulse 1.2s ease-in-out infinite; }
        .sync-strip.no-room { color:rgba(136,136,136,0.7); }
        .sync-strip.no-room .sync-dot { background:#555; }
        @keyframes syncDotPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* Tank Update Badge — positioned top-right, left of delete X */
        .tank-update-badge { position:absolute;top:10px;right:34px;display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600;background:rgba(102,187,106,0.15);color:#66bb6a;border:1px solid rgba(102,187,106,0.25);white-space:nowrap;line-height:1.3; }
        .tank-update-badge .update-initials { color:#81c784;font-weight:700; }
        .tank-update-badge .update-time { color:#a5d6a7;font-weight:500; }
        .tank-update-badge.remote { background:rgba(79,195,247,0.15);color:#4fc3f7;border-color:rgba(79,195,247,0.25); }
        .tank-update-badge.remote .update-initials { color:#4fc3f7; }
        .tank-update-badge.remote .update-time { color:#81d4fa; }
        
        /* Room Users Badge */
        .room-users-badge { display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:600;background:rgba(79,195,247,0.15);color:#4fc3f7;border:1px solid rgba(79,195,247,0.25);cursor:pointer; }
        .room-users-badge .user-count { background:#4fc3f7;color:#0d1b2a;border-radius:50%;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800; }
    </style>
</head>
<body>
    <div class="well-name-banner" onclick="openProfileModal()">
        <span class="well-name-banner-text empty" id="header-well-name">Tap to set well name</span>
    </div>
    <!-- Sync Status Strip -->
    <div class="sync-strip no-room" id="sync-status"><span class="sync-dot"></span><span id="sync-label">Local Only</span></div>
    <div class="app-header">
        <img src="data:image/png;base64,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" alt="IPS" class="app-logo">
        <div class="app-title">
            <h1>INTELLIGENT PETROLEUM SOLUTIONS LLC</h1>
            <p>Fluid Tracking System</p>
        </div>
        <div class="header-actions">
            <div class="room-users-badge" id="room-users-badge" onclick="showRoomUsersInfo()" style="display:none">
                <span class="user-count" id="room-user-count">0</span>
                <span>Online</span>
            </div>
            <button class="chat-feed-btn" id="chat-feed-btn" onclick="openChatFeed()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91c0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91C21.95 6.45 17.5 2 12.04 2zm5.82 14.01c-.25.7-1.23 1.43-1.97 1.62-.5.13-1.15.24-3.34-.72-2.8-1.22-4.6-4.06-4.74-4.25-.14-.19-1.13-1.51-1.13-2.88s.71-2.04.97-2.32c.26-.28.56-.35.75-.35h.54c.17 0 .41-.07.64.49.25.56.84 2.04.91 2.19.07.14.12.31.02.5-.1.19-.15.31-.29.47l-.43.5c-.14.14-.3.3-.13.58.17.29.75 1.23 1.61 2 1.1.98 2.03 1.28 2.32 1.43.28.14.45.12.62-.07.17-.19.71-.83.9-1.12.19-.28.38-.24.64-.14.26.1 1.65.78 1.93.92.28.14.47.21.54.33.07.12.07.68-.18 1.38z"/>
                </svg>
                <span class="chat-feed-badge" id="chat-feed-badge">0</span>
            </button>
            <button class="profile-btn" id="profile-btn" onclick="openProfileModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="8" r="4"/>
                    <path d="M20 21a8 8 0 1 0-16 0"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Voice Status Display -->
    <div class="voice-status" id="voice-status">
        <div class="voice-status-main" id="voice-status-main">Listening...</div>
        <div class="voice-status-sub" id="voice-status-sub">Say a tank keyword</div>
    </div>

    <div class="ble-status" id="ble-status">
        <div class="ble-status-main" id="ble-status-main">Connecting...</div>
        <div class="ble-status-sub" id="ble-status-sub">Select your laser</div>
    </div>

    <!-- Voice Keyword Modal (single tank) -->
    <div class="voice-modal-overlay" id="voice-keyword-modal">
        <div class="voice-modal">
            <div class="voice-modal-title" id="voice-modal-tank-name">Tank Name</div>
            <div class="voice-modal-subtitle">Add voice keywords for this tank</div>
            <div class="voice-keyword-list" id="voice-keyword-list"></div>
            <div class="voice-keyword-input-row">
                <input type="text" class="voice-keyword-input" id="voice-keyword-input" placeholder="Type a keyword...">
                <button class="voice-keyword-add-btn" onclick="addVoiceKeywordFromInput()">Add</button>
            </div>
            <button class="voice-record-btn" id="voice-record-btn" onclick="toggleVoiceKeywordRecord()">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                <span id="voice-record-label">Record Keyword</span>
            </button>
            <button class="voice-modal-close" onclick="closeVoiceKeywordModal()">Done</button>
        </div>
    </div>

    <!-- Voice Keywords Manager (all tanks) -->
    <div class="voice-modal-overlay" id="voice-keywords-manager">
        <div class="voice-modal" style="max-height:85vh;overflow-y:auto">
            <div class="voice-modal-title">🎤 Voice Keywords</div>
            <div class="voice-modal-subtitle">Tap a tank to add/edit keywords</div>
            <div id="voice-km-list"></div>
            <button class="voice-modal-close" onclick="closeVoiceKeywordsManager()">Done</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal-overlay" id="profile-modal">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#1b2838;border-bottom:1px solid #2d4a6f;flex-shrink:0">
            <span style="font-size:16px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px">⚙️ Settings</span>
            <span style="position:absolute;left:50%;transform:translateX(-50%);font-size:14px;font-weight:700;color:#ffa726;letter-spacing:0.5px">v1.2.0</span>
            <button onclick="closeProfileModal()" style="background:none;border:1px solid #2d4a6f;color:#e0e0e0;width:36px;height:36px;border-radius:6px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
        </div>
        <div class="profile-modal">
            <!-- Quick-access Input Device toggles -->
            <div style="display:flex;justify-content:center;gap:16px;margin-bottom:12px;padding:12px;background:#1b2838;border-radius:8px;border:1px solid #2d4a6f">
                <div style="text-align:center">
                    <button class="voice-master-btn" id="voice-master-btn" onclick="toggleVoiceMaster()" style="width:56px;height:56px;margin-bottom:6px">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:28px;height:28px"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <div style="font-size:10px;color:#888;text-transform:uppercase">Voice</div>
                </div>
                <div style="text-align:center">
                    <button class="ble-master-btn" id="ble-master-btn" onclick="toggleBleMaster()" style="width:56px;height:56px;margin-bottom:6px">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:28px;height:28px"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg>
                    </button>
                    <div style="font-size:10px;color:#888;text-transform:uppercase">Bluetooth</div>
                </div>
            </div>
            <!-- Profile & Well -->
            <div class="settings-accordion open">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Profile & Well</span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <div class="profile-input-group">
                        <label>Well Name</label>
                        <input type="text" id="profile-well-input" placeholder="e.g. Smith #4H" oninput="updateWellNamePreview()">
                    </div>
                    <div class="profile-input-group">
                        <label>Your Name</label>
                        <input type="text" id="profile-name-input" placeholder="e.g. Jonathan Barber" oninput="updateInitialsPreview()">
                    </div>
                    <div class="profile-initials-preview">
                        <div class="profile-initials-label">Your initials (shown in logs)</div>
                        <div class="profile-initials-value" id="profile-initials-preview">--</div>
                    </div>
                </div>
            </div>
            <!-- Room & Sync -->
            <div class="settings-accordion" id="settings-room-section">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Room & Sync <span class="settings-acc-status" id="settings-room-status-badge"></span></span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <div class="profile-section-label">Room Status</div>
                    <div id="profile-room-info" style="padding:8px 12px;background:#1b2838;border-radius:6px;margin-bottom:8px;border:1px solid #2d4a6f">
                        <div style="font-size:12px;color:#888">Not connected to a room</div>
                    </div>
                    <div class="profile-section-label">Users Active</div>
                    <div id="profile-users-list" style="padding:8px 12px;background:#1b2838;border-radius:6px;margin-bottom:8px;border:1px solid #2d4a6f">
                        <div style="font-size:12px;color:#888">No users online</div>
                    </div>
                    <button class="profile-action-btn" id="invite-user-btn" onclick="inviteUserToRoom()" style="border-color:#1565c0;color:#4fc3f7"><span class="action-icon">📨</span> Invite User to Room</button>
                    <button class="profile-action-btn" id="push-data-btn" onclick="adminPushData()" style="border-color:#e65100;color:#ffa726;display:none"><span class="action-icon">📤</span> Push My Data to Room</button>
                    <button class="profile-action-btn" id="claim-admin-btn" onclick="claimAdmin()" style="border-color:#c62828;color:#ef5350;display:none"><span class="action-icon">👑</span> Become Room Admin</button>
                </div>
            </div>
            <!-- Tank Management -->
            <div class="settings-accordion">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Tank Management</span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <button class="profile-action-btn" id="admin-add-tank-btn" onclick="closeProfileModal();showAddTankModal()"><span class="action-icon">➕</span> Add Tank</button>
                    <button class="profile-action-btn" onclick="closeProfileModal();openVoiceKeywordsManager()"><span class="action-icon">🎤</span> Set Voice Keywords</button>
                    <div class="profile-input-group" style="margin-top:10px">
                        <label>Tank Lip Offset (inches)</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="number" id="ble-offset-input" style="flex:1;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#1b2838;color:#e0e0e0;font-size:16px" placeholder="108" oninput="saveBleOffset()">
                            <span style="font-size:12px;color:#888;white-space:nowrap" id="ble-offset-ft">= 9.0 ft</span>
                        </div>
                        <div style="font-size:11px;color:#888;margin-top:4px">Laser rest point to 0" on stick chart</div>
                    </div>
                    <div class="profile-section-label" style="margin-top:10px">Packer Fluid</div>
                    <div id="packer-treated-controls"></div>
                </div>
            </div>
            <!-- Timecard Config -->
            <div class="settings-accordion" id="settings-timecard-section">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Timecard</span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <div style="font-size:11px;color:#888;margin-bottom:10px">Upload the blank AES timesheet with your rates already filled in. The app will use it as a template when generating timecards.</div>
                    <div id="tc-template-status" style="padding:10px 12px;background:#1b2838;border-radius:6px;margin-bottom:10px;border:1px solid #2d4a6f;font-size:12px;color:#888">No template uploaded</div>
                    <input type="file" id="tc-template-upload" accept=".xlsx" style="display:none" onchange="tcHandleTemplateUpload(this)">
                    <button class="profile-action-btn" onclick="tcLoadExcelJSThenUpload()"><span class="action-icon">📄</span> Upload Timesheet Template</button>
                    <button class="profile-action-btn" onclick="tcClearTemplate()" style="border-color:#c62828;color:#ef5350;display:none" id="tc-template-clear-btn"><span class="action-icon">🗑️</span> Remove Template</button>
                    <hr style="border:none;border-top:1px solid #2d4a6f;margin:12px 0">
                    <div style="font-size:11px;color:#888;margin-bottom:8px">These fields auto-fill when logging days. Edit per entry if needed.</div>
                    <div class="profile-input-group"><label>Default Operator</label><input type="text" id="tc-operator" placeholder="e.g. ExxonMobil" oninput="saveTimecardConfig()"></div>
                    <div style="display:flex;gap:8px">
                        <div class="profile-input-group" style="flex:1"><label>Default Rig</label><input type="text" id="tc-rig" placeholder="e.g. Cardinal" oninput="saveTimecardConfig()"></div>
                        <div class="profile-input-group" style="flex:1"><label>Default County</label><input type="text" id="tc-county" placeholder="e.g. upton, TX" oninput="saveTimecardConfig()"></div>
                    </div>
                </div>
            </div>
            <!-- Shift Actions -->
            <div class="settings-accordion">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Shift Actions</span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <button class="profile-action-btn" onclick="closeProfileModal();showTurnoverReport()"><span class="action-icon">📋</span> Generate Turnover Report</button>
                    <button class="profile-action-btn" style="border-color:#c62828;color:#ef5350" onclick="closeProfileModal();startNewShift()"><span class="action-icon">🔄</span> Start New Shift</button>
                </div>
            </div>
            <button class="profile-save-btn" onclick="saveProfile()">Save & Close</button>
        </div>
    </div>

    <!-- Chat Feed Overlay -->
    <div class="chat-feed-overlay" id="chat-feed-overlay">
        <div class="chat-feed-header">
            <div class="chat-feed-header-icon">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91c0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91C21.95 6.45 17.5 2 12.04 2zm5.82 14.01c-.25.7-1.23 1.43-1.97 1.62-.5.13-1.15.24-3.34-.72-2.8-1.22-4.6-4.06-4.74-4.25-.14-.19-1.13-1.51-1.13-2.88s.71-2.04.97-2.32c.26-.28.56-.35.75-.35h.54c.17 0 .41-.07.64.49.25.56.84 2.04.91 2.19.07.14.12.31.02.5-.1.19-.15.31-.29.47l-.43.5c-.14.14-.3.3-.13.58.17.29.75 1.23 1.61 2 1.1.98 2.03 1.28 2.32 1.43.28.14.45.12.62-.07.17-.19.71-.83.9-1.12.19-.28.38-.24.64-.14.26.1 1.65.78 1.93.92.28.14.47.21.54.33.07.12.07.68-.18 1.38z"/></svg>
            </div>
            <div class="chat-feed-header-title">
                <h2>Well Data Capture</h2>
                <p>Parse field data from WhatsApp messages</p>
            </div>
            <button class="chat-feed-close" onclick="closeChatFeed()">✕</button>
        </div>
        <div class="chat-feed-body">
            <div class="chat-feed-tabs">
                <button class="chat-feed-tab active" id="cf-tab-paste" onclick="switchChatFeedTab('paste')">📋 Paste Text</button>
                <button class="chat-feed-tab" id="cf-tab-image" onclick="switchChatFeedTab('image')">📷 Screenshot</button>
            </div>

            <!-- Paste Mode -->
            <div class="chat-feed-input-area" id="cf-paste-area">
                <textarea class="chat-feed-textarea" id="cf-text-input" placeholder="Paste chat text here...

Example:
Plug: 79 of 91
JNT: 362/ 4 out
Depth: 11,387
Time: 06:59
Drill: 3 min
Wash time: 14 minutes
RIH Wt: 50K
..."></textarea>
            </div>

            <!-- Image Mode -->
            <div class="chat-feed-input-area" id="cf-image-area" style="display:none">
                <div class="chat-feed-upload-zone" id="cf-upload-zone" onclick="document.getElementById('cf-file-input').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    <p>Tap to upload screenshot</p>
                    <p class="upload-hint">JPG, PNG — from WhatsApp chat</p>
                </div>
                <input type="file" id="cf-file-input" accept="image/*" style="display:none" onchange="handleChatFeedImage(event)">
                <div id="cf-image-preview" style="display:none;text-align:center;margin-top:10px">
                    <img id="cf-preview-img" class="chat-feed-preview-img" src="">
                    <p style="font-size:11px;color:#888;margin-top:6px">Image loaded — ready to extract</p>
                </div>
            </div>

            <button class="chat-feed-process-btn" id="cf-process-btn" onclick="processChatFeed()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                Extract Data
            </button>

            <!-- Results -->
            <div id="cf-results-container"></div>

            <!-- History -->
            <div class="chat-feed-history-section" id="cf-history-section" style="display:none">
                <div class="chat-feed-history-title">
                    Extraction Log
                    <button class="chat-feed-history-clear" onclick="clearChatFeedHistory()">Clear All</button>
                </div>
                <div class="chat-feed-results" id="cf-history-results"></div>
            </div>
        </div>
    </div>

    <div class="master-tabs">
        <button class="master-tab active" onclick="switchMasterTab('fluids')">Fluids</button>
        <button class="master-tab" onclick="switchMasterTab('wellbore')">Wellbore</button>
        <button class="master-tab" onclick="switchMasterTab('timecard')">Timecard</button>
    </div>

    <div id="fluids-section" class="master-section active">
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('tanks')">Tanks</button>
        <button class="main-tab" onclick="switchMainTab('gainloss')">Monitor</button>
        <button class="main-tab" onclick="switchMainTab('transfer')">Transfer</button>
        <button class="main-tab" onclick="switchMainTab('injection')">Injection</button>
        <button class="main-tab" onclick="switchMainTab('titrations')">Titrations</button>
    </div>

    <div id="tanks-tab" class="tab-content active">
        <div class="totals-bar" id="totals-bar">
            <div class="total-item" id="filter-brine" onclick="setFluidFilter('brine')"><div class="total-label">Brine</div><div class="total-value brine" id="total-brine">0</div></div>
            <div class="total-item" id="filter-packer" onclick="setFluidFilter('packer')"><div class="total-label">Packer</div><div class="total-value packer" id="total-packer">0</div></div>
            <div class="total-item" id="filter-mud" onclick="setFluidFilter('mud')"><div class="total-label">Mud</div><div class="total-value mud" id="total-mud">0</div></div>
            <div class="total-item" id="filter-recirc" onclick="setFluidFilter('recirc')"><div class="total-label">Recirc</div><div class="total-value recirc" id="total-recirc">0</div></div>
            <div class="total-item" id="filter-freshwater" onclick="setFluidFilter('freshwater')"><div class="total-label">Fresh</div><div class="total-value freshwater" id="total-freshwater">0</div></div>
            <div class="total-item" id="filter-other" onclick="setFluidFilter('other')"><div class="total-label">Other</div><div class="total-value other" id="total-other">0</div></div>
        </div>
        <div class="side-toggle" id="side-toggle">
            <button class="side-tab active" onclick="switchSide('pump')">Pump Side</button>
            <button class="side-tab" onclick="switchSide('return')">Return Side</button>
        </div>
        <div class="tanks-container active" id="pump-tanks"></div>
        <div class="tanks-container" id="return-tanks"></div>
        <div class="filtered-tanks" id="filtered-tanks"></div>
        <div class="system-totals">
            <div class="system-total"><div class="system-total-label">System Total</div><div class="system-total-value" id="system-total">0 BBL</div></div>
            <div class="system-total"><div class="system-total-label">Jetted (Shift)</div><div class="system-total-value jetted" id="jetted-total">0 BBL</div></div>
        </div>
        <button class="report-btn" onclick="showTankReport()">Generate Tank Report</button>
    </div>

    <!-- GAIN/LOSS TAB -->
    <div id="gainloss-tab" class="tab-content">
        <div class="totals-bar" id="gl-totals-bar">
            <div class="total-item" id="gl-filter-brine" onclick="setGLFluidFilter('brine')"><div class="total-label">Brine</div><div class="total-value brine" id="gl-total-brine">0</div></div>
            <div class="total-item" id="gl-filter-packer" onclick="setGLFluidFilter('packer')"><div class="total-label">Packer</div><div class="total-value packer" id="gl-total-packer">0</div></div>
            <div class="total-item" id="gl-filter-mud" onclick="setGLFluidFilter('mud')"><div class="total-label">Mud</div><div class="total-value mud" id="gl-total-mud">0</div></div>
            <div class="total-item" id="gl-filter-recirc" onclick="setGLFluidFilter('recirc')"><div class="total-label">Recirc</div><div class="total-value recirc" id="gl-total-recirc">0</div></div>
            <div class="total-item" id="gl-filter-freshwater" onclick="setGLFluidFilter('freshwater')"><div class="total-label">Fresh</div><div class="total-value freshwater" id="gl-total-freshwater">0</div></div>
            <div class="total-item" id="gl-filter-other" onclick="setGLFluidFilter('other')"><div class="total-label">Other</div><div class="total-value other" id="gl-total-other">0</div></div>
        </div>
        <div style="padding:12px;padding-bottom:80px">
            <div id="gl-filter-label" style="text-align:center;font-size:11px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px;padding:4px 0">Capture <span style="color:#e0e0e0">System</span></div>
            <div class="controls" style="margin-bottom:0">
                <button class="ctrl-btn blue" onclick="logGainLossCheck()" style="flex:1">Capture</button>
                <button style="background:#2d4a6f;color:#e0e0e0;border:none;padding:10px 12px;border-radius:6px;font-size:11px;cursor:pointer" onclick="resetGainLoss()">Reset</button>
            </div>
            <div class="gain-loss-bar" style="margin-bottom:0;border-radius:6px 6px 0 0">
                <div class="gl-box"><div class="gl-label">User</div><div class="gl-value neutral" id="cap-user" style="font-size:12px">--</div></div>
                <div class="gl-box"><div class="gl-label">Fluid</div><div class="gl-value neutral" id="cap-fluid" style="font-size:12px">--</div></div>
                <div class="gl-box"><div class="gl-label">Surface</div><div class="gl-value neutral" id="cap-surface">--</div></div>
                <div class="gl-box"><div class="gl-label">Wellbore</div><div class="gl-value neutral" id="cap-wellbore">--</div></div>
                <div class="gl-box"><div class="gl-label">Total</div><div class="gl-value neutral" id="cap-total">--</div></div>
            </div>
            <div class="gain-loss-bar" style="margin-top:0;padding-top:0;border-radius:0 0 6px 6px">
                <div class="gl-box"><div class="gl-label">Time</div><div class="gl-value neutral" id="cap-time">--</div><div class="gl-sublabel" id="elapsed-time"></div></div>
                <div class="gl-box"><div class="gl-label">Apparent</div><div class="gl-value neutral" id="apparent-change">--</div></div>
                <div class="gl-box"><div class="gl-label">Actual</div><div class="gl-value neutral" id="true-change">--</div></div>
                <div class="gl-box"><div class="gl-label">Transfers</div><div class="gl-value neutral" id="cap-transfers" style="font-size:11px">--</div></div>
                <div class="gl-box"><div class="gl-label">Hourly</div><div class="gl-value neutral" id="rate-per-hour">--</div></div>
            </div>
            <div class="system-totals" style="margin:0 0 12px">
                <div class="system-total"><div class="system-total-label">System Total</div><div class="system-total-value" id="gl-system-total">0 BBL</div></div>
                <div class="system-total"><div class="system-total-label">Jetted (Shift)</div><div class="system-total-value jetted" id="gl-jetted-total">0 BBL</div></div>
            </div>
            <div style="background:#1b2838;border-radius:6px;padding:10px;max-height:400px;overflow-y:auto">
                <div style="font-size:10px;color:#888;text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">Volume Log <button style="background:#2d4a6f;border:none;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" onclick="openLogEdit('volume')">Edit</button></div>
                <div id="volume-log-content"><em style="color:#666">No volume checks logged</em></div>
            </div>
            <button class="report-btn" onclick="showMonitorReport()">Generate Monitor Report</button>
            <button class="report-btn" onclick="showTurnoverReport()" style="background:transparent;border:1px solid #2d4a6f;color:#4fc3f7;margin-top:8px">📋 Generate Turnover Report</button>
        </div>
    </div>

    <!-- TRANSFER TAB -->
    <div id="transfer-tab" class="tab-content">
        <div class="totals-bar" id="xfer-totals-bar">
            <div class="total-item" id="xfer-filter-brine" onclick="setXferFluidFilter('brine')"><div class="total-label">Brine</div><div class="total-value brine" id="xfer-total-brine">0</div></div>
            <div class="total-item" id="xfer-filter-packer" onclick="setXferFluidFilter('packer')"><div class="total-label">Packer</div><div class="total-value packer" id="xfer-total-packer">0</div></div>
            <div class="total-item" id="xfer-filter-mud" onclick="setXferFluidFilter('mud')"><div class="total-label">Mud</div><div class="total-value mud" id="xfer-total-mud">0</div></div>
            <div class="total-item" id="xfer-filter-recirc" onclick="setXferFluidFilter('recirc')"><div class="total-label">Recirc</div><div class="total-value recirc" id="xfer-total-recirc">0</div></div>
            <div class="total-item" id="xfer-filter-freshwater" onclick="setXferFluidFilter('freshwater')"><div class="total-label">Fresh</div><div class="total-value freshwater" id="xfer-total-freshwater">0</div></div>
            <div class="total-item" id="xfer-filter-other" onclick="setXferFluidFilter('other')"><div class="total-label">Other</div><div class="total-value other" id="xfer-total-other">0</div></div>
        </div>
        <div style="padding:12px;padding-bottom:80px">
            <div id="xfer-filter-label" style="text-align:center;font-size:11px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px;padding:4px 0 8px">Capture <span style="color:#e0e0e0">System</span></div>
            <div class="jet-section">
                <div class="jet-toggle">
                    <button class="jet-toggle-btn out active" onclick="setJetType('out')">Jet Out</button>
                    <button class="jet-toggle-btn in" onclick="setJetType('in')">Jet In</button>
                    <button class="jet-toggle-btn build" onclick="setJetType('build')">Build</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:10px" id="xfer-volume-row">
                    <input type="number" id="jet-volume" value="120" oninput="if(jetType==='build')updateBuildTotal()" style="flex:1;padding:10px;border:1px solid #2d4a6f;border-radius:6px;font-size:16px;background:#1b2838;color:#e0e0e0;text-align:center" placeholder="BBL">
                    <span style="font-size:12px;color:#888">BBL</span>
                </div>
                <!-- Build batch counter -->
                <div id="build-row" style="display:none;margin-top:10px">
                    <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:10px">
                        <button onclick="adjustBuildCount(-1)" style="width:44px;height:44px;border:1px solid #6d4c41;border-radius:8px;background:#1b2838;color:#a1887f;font-size:22px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center">−</button>
                        <div style="text-align:center;min-width:80px">
                            <div style="font-size:36px;font-weight:800;color:#a1887f" id="build-count">1</div>
                            <div style="font-size:10px;color:#888;text-transform:uppercase">Batches</div>
                        </div>
                        <button onclick="adjustBuildCount(1)" style="width:44px;height:44px;border:1px solid #6d4c41;border-radius:8px;background:#1b2838;color:#a1887f;font-size:22px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center">+</button>
                    </div>
                    <div style="text-align:center;margin-bottom:6px">
                        <span style="font-size:12px;color:#888">Total: </span>
                        <span style="font-size:20px;font-weight:700;color:#a1887f" id="build-total-display">120 BBL</span>
                    </div>
                </div>
                <div class="controls" style="margin-top:10px;margin-bottom:0">
                    <button class="ctrl-btn blue" onclick="startTransferCapture()" style="flex:1" id="xfer-capture-btn">Capture</button>
                    <button style="background:#2d4a6f;color:#e0e0e0;border:none;padding:10px 12px;border-radius:6px;font-size:11px;cursor:pointer" onclick="resetShiftJetted()">Reset</button>
                </div>
                <div style="display:flex;justify-content:center;align-items:center;margin-top:10px">
                    <span style="font-size:11px;color:#888">Shift Total: </span><span style="font-size:16px;font-weight:700;color:#ffa726;margin-left:6px" id="transfer-shift-total">0 BBL</span>
                </div>
            </div>
            <div style="background:#1b2838;border-radius:6px;padding:10px;margin-top:12px;max-height:350px;overflow-y:auto">
                <div style="font-size:10px;color:#888;text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">Transfer Log <button style="background:#2d4a6f;border:none;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" onclick="openLogEdit('transfer')">Edit</button></div>
                <div id="transfer-log-content"><em style="color:#666">No transfers logged</em></div>
            </div>
            <button class="report-btn" onclick="showTransferReport()">Generate Transfer Report</button>
        </div>
    </div>
    
    <!-- TRANSFER TANK PICKER MODAL -->
    <div class="modal" id="xfer-tank-modal" onclick="if(event.target===this)hideXferTankModal()">
        <div style="background:#243447;border-radius:12px;padding:20px;width:90%;max-width:400px">
            <div style="font-size:16px;font-weight:700;color:#e0e0e0;margin-bottom:12px;text-align:center" id="xfer-modal-title">Select Tank(s)</div>
            <div id="xfer-tank-list" style="max-height:350px;overflow-y:auto"></div>
            <div style="display:flex;gap:8px;margin-top:12px">
                <button class="ctrl-btn blue" onclick="confirmXferTankSelection()" style="flex:1">Confirm</button>
                <button style="background:#2d4a6f;color:#e0e0e0;border:none;padding:10px 16px;border-radius:6px;font-size:13px;cursor:pointer" onclick="hideXferTankModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INJECTION TAB -->
    <div id="injection-tab" class="tab-content">
        <div style="padding:12px;padding-bottom:80px">
            <div style="background:#243447;border-radius:8px;padding:16px;margin-bottom:12px;border:2px solid #4fc3f7">
                <div style="font-size:12px;color:#4fc3f7;text-transform:uppercase;margin-bottom:8px">Current Pump Rate (BPM)</div>
                <div style="font-size:48px;font-weight:700;color:#ffd54f;text-align:center" id="current-pump-rate">--<span style="font-size:18px;color:#888"> BPM</span></div>
                <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
                    <label style="font-size:12px;color:#888;min-width:70px">Set Rate:</label>
                    <select id="pump-rate-select" onchange="updatePumpRate()" style="flex:1;padding:10px;border:1px solid #2d4a6f;border-radius:6px;font-size:16px;background:#1b2838;color:#e0e0e0">
                        <option value="">Select...</option>
                        <option value="0">0</option><option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option>
                        <option value="2.25">2.25</option><option value="2.5">2.5</option><option value="2.75">2.75</option>
                        <option value="3">3</option><option value="3.25">3.25</option><option value="3.5">3.5</option>
                        <option value="3.75">3.75</option><option value="4">4</option><option value="4.25">4.25</option>
                        <option value="4.5">4.5</option><option value="4.75">4.75</option><option value="5">5</option>
                        <option value="5.25">5.25</option><option value="5.5">5.5</option><option value="5.75">5.75</option>
                        <option value="6">6</option><option value="6.25">6.25</option><option value="6.5">6.5</option>
                        <option value="6.75">6.75</option><option value="7">7</option><option value="7.25">7.25</option>
                        <option value="7.5">7.5</option><option value="7.75">7.75</option><option value="8">8</option>
                    </select>
                </div>
            </div>
            <div style="background:#243447;border-radius:8px;padding:16px;margin-bottom:12px;border-left:4px solid #66bb6a">
                <div style="font-size:14px;font-weight:600;color:#66bb6a;margin-bottom:12px;display:flex;align-items:center;gap:8px"><svg width="24" height="24" viewBox="0 0 100 100" fill="white"><rect x="15" y="25" width="70" height="60" rx="5" stroke="white" stroke-width="3" fill="white"/><rect x="20" y="15" width="60" height="15" rx="3" fill="white"/><line x1="15" y1="45" x2="85" y2="45" stroke="#243447" stroke-width="2"/><line x1="15" y1="65" x2="85" y2="65" stroke="#243447" stroke-width="2"/><line x1="38" y1="25" x2="38" y2="85" stroke="#243447" stroke-width="2"/><line x1="62" y1="25" x2="62" y2="85" stroke="#243447" stroke-width="2"/><rect x="10" y="85" width="80" height="8" fill="white"/></svg> Friction Reducer (FR)</div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <label style="font-size:12px;color:#888;min-width:70px">Treatment:</label>
                    <select id="fr-treatment" onchange="updateInjTargets()" style="flex:1;padding:10px;border:1px solid #2d4a6f;border-radius:6px;font-size:16px;background:#1b2838;color:#e0e0e0">
                        <option value="">Select...</option>
                        <option value="0.125">1/8 per 10 bbl</option><option value="0.25">1/4 per 10 bbl</option>
                        <option value="0.375">3/8 per 10 bbl</option><option value="0.5">1/2 per 10 bbl</option>
                        <option value="0.625">5/8 per 10 bbl</option><option value="0.75">3/4 per 10 bbl</option>
                    </select>
                </div>
                <div style="background:#0d1b2a;border-radius:8px;padding:16px;text-align:center">
                    <div style="font-size:11px;color:#888;text-transform:uppercase;margin-bottom:4px">Target GPM</div>
                    <div style="font-size:36px;font-weight:700;color:#4caf50" id="fr-target">--</div>
                    <div style="font-size:12px;color:#888">Set Dayton dial until IFM shows this</div>
                </div>
                <button onclick="logInjChange('fr')" style="width:100%;padding:12px;background:#2e7d32;color:white;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px">Log FR Change</button>
            </div>
            <div style="background:#243447;border-radius:8px;padding:16px;margin-bottom:12px;border-left:4px solid #ffa726">
                <div style="font-size:14px;font-weight:600;color:#ffa726;margin-bottom:12px;display:flex;align-items:center;gap:8px"><svg width="24" height="24" viewBox="0 0 100 100"><rect x="15" y="25" width="70" height="60" rx="5" stroke="white" stroke-width="3" fill="#1b2838"/><rect x="20" y="15" width="60" height="15" rx="3" stroke="white" stroke-width="2" fill="#1b2838"/><line x1="15" y1="45" x2="85" y2="45" stroke="white" stroke-width="2"/><line x1="15" y1="65" x2="85" y2="65" stroke="white" stroke-width="2"/><line x1="38" y1="25" x2="38" y2="85" stroke="white" stroke-width="2"/><line x1="62" y1="25" x2="62" y2="85" stroke="white" stroke-width="2"/><rect x="10" y="85" width="80" height="8" stroke="white" stroke-width="2" fill="#1b2838"/></svg> Pipe-on-Pipe Lube</div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <label style="font-size:12px;color:#888;min-width:70px">Treatment:</label>
                    <select id="lube-treatment" onchange="updateInjTargets()" style="flex:1;padding:10px;border:1px solid #2d4a6f;border-radius:6px;font-size:16px;background:#1b2838;color:#e0e0e0">
                        <option value="">Select...</option>
                        <option value="0.125">1/8 per 10 bbl</option><option value="0.25">1/4 per 10 bbl</option>
                        <option value="0.375">3/8 per 10 bbl</option><option value="0.5">1/2 per 10 bbl</option>
                        <option value="0.625">5/8 per 10 bbl</option><option value="0.75">3/4 per 10 bbl</option>
                    </select>
                </div>
                <div style="background:#0d1b2a;border-radius:8px;padding:16px;text-align:center">
                    <div style="font-size:11px;color:#888;text-transform:uppercase;margin-bottom:4px">Target GPM</div>
                    <div style="font-size:36px;font-weight:700;color:#4caf50" id="lube-target">--</div>
                    <div style="font-size:12px;color:#888">Set Dayton dial until IFM shows this</div>
                </div>
                <button onclick="logInjChange('lube')" style="width:100%;padding:12px;background:#2e7d32;color:white;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px">Log Lube Change</button>
            </div>
            <div style="background:#1b2838;border-radius:6px;padding:10px;max-height:150px;overflow-y:auto">
                <div style="font-size:10px;color:#888;text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">Injection Log <button onclick="openLogEdit('injection')" style="background:#2d4a6f;border:none;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer">Edit</button></div>
                <div id="inj-history"><em style="color:#666">No changes logged</em></div>
            </div>
            <button class="report-btn" onclick="showInjReport()">Generate Injection Report</button>
        </div>
    </div>

    <!-- INJECTION REPORT SCREEN -->
    <div class="report-screen" id="injection-report">
        <div class="report-header"><button class="report-close" onclick="hideInjReport()">×</button><h1>Chemical Injection Report</h1><p id="inj-report-time"></p></div>
        <div class="report-body" id="inj-report-content"></div>
    </div>

    <div id="titrations-tab" class="tab-content">
        <div class="titration-container">
            <div style="display:flex;gap:0;margin-bottom:12px;background:#243447;border-radius:8px;overflow:hidden;border:1px solid #2d4a6f">
                <button class="sample-loc-btn active" id="sample-in-btn" onclick="setSampleLocation('in')" style="flex:1;padding:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;background:#1565c0;color:white">⬇ Pump Side (In)</button>
                <button class="sample-loc-btn" id="sample-out-btn" onclick="setSampleLocation('out')" style="flex:1;padding:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;background:transparent;color:rgba(255,255,255,0.4)">⬆ Discharge (Out)</button>
            </div>
            <div class="fluid-select">
                <select id="fluid-type" onchange="saveTitrationData()">
                    <option value="aphron">Aphron Mud</option>
                    <option value="brine">Brine</option>
                    <option value="recirc">Recirc</option>
                    <option value="freshwater">Freshwater</option>
                </select>
            </div>
            <div class="tit-card">
                <div class="tit-title">Basic Properties</div>
                <div class="tit-row"><span class="tit-label">Viscosity (USC)</span><input type="number" class="tit-input" id="tit-viscosity" onchange="saveTitrationData()"><span class="tit-unit">sec</span></div>
                <div class="tit-row"><span class="tit-label">Density (PPG)</span><input type="number" step="0.1" class="tit-input" id="tit-density" onchange="saveTitrationData()"><span class="tit-unit">ppg</span></div>
                <div class="tit-row"><span class="tit-label">pH</span><input type="number" step="0.1" class="tit-input" id="tit-ph" onchange="updatePF(); saveTitrationData()"><span class="tit-unit"></span></div>
            </div>
            <div class="tit-card">
                <div class="tit-title">Rheology</div>
                <div class="tit-row"><span class="tit-label">600 RPM</span><input type="number" class="tit-input" id="tit-r600" onchange="calcRheology(); saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row"><span class="tit-label">300 RPM</span><input type="number" class="tit-input" id="tit-r300" onchange="calcRheology(); saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row"><span class="tit-label">200 RPM</span><input type="number" class="tit-input" id="tit-r200" onchange="saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row"><span class="tit-label">100 RPM</span><input type="number" class="tit-input" id="tit-r100" onchange="saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row"><span class="tit-label">6 RPM</span><input type="number" class="tit-input" id="tit-r6" onchange="saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row"><span class="tit-label">3 RPM</span><input type="number" class="tit-input" id="tit-r3" onchange="saveTitrationData()"><span class="tit-unit"></span></div>
                <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">PV</span><span class="tit-result calculated" id="tit-pv">--</span><span class="tit-unit">cP</span></div>
                <div class="tit-row"><span class="tit-label">YP</span><span class="tit-result calculated" id="tit-yp">--</span><span class="tit-unit">lb/100ft²</span></div>
                <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">10-sec Gel</span><input type="number" class="tit-input" id="tit-gel10s" onchange="saveTitrationData()"><span class="tit-unit">lb/100ft²</span></div>
                <div class="tit-row"><span class="tit-label">10-min Gel</span><input type="number" class="tit-input" id="tit-gel10m" onchange="saveTitrationData()"><span class="tit-unit">lb/100ft²</span></div>
            </div>
            <div class="tit-card">
                <div class="tit-title">PF / MF Test</div>
                <div class="tit-note">If pH ≤ 7, PF = 0. Save remaining acid for MF test.</div>
                <div class="tit-row"><span class="tit-label">PF</span><input type="number" step="0.1" class="tit-input" id="tit-pf" onchange="saveTitrationData()"><span class="tit-unit">ml</span></div>
                <div class="tit-row"><span class="tit-label">MF</span><input type="number" step="0.1" class="tit-input" id="tit-mf" onchange="saveTitrationData()"><span class="tit-unit">ml</span></div>
            </div>
            <div class="tit-card">
                <div class="tit-title">Chlorides Test</div>
                <div class="tit-row"><span class="tit-label">Silver Nitrate</span><select class="tit-input" id="tit-sn-type" style="width:120px" onchange="calcChlorides(); saveTitrationData()"><option value="fresh">0.0282</option><option value="brine">0.282</option></select></div>
                <div class="tit-row"><span class="tit-label">Pipette Reading</span><input type="number" step="0.1" class="tit-input" id="tit-cl-pipette" onchange="calcChlorides(); saveTitrationData()"><span class="tit-unit">ml</span></div>
                <div class="tit-row"><span class="tit-label">Chlorides</span><span class="tit-result calculated" id="tit-chlorides">--</span><span class="tit-unit">ppm</span></div>
            </div>
            <div class="tit-card">
                <div class="tit-title">Hardness / Calcium / Magnesium</div>
                <div class="distilled-warning">⚠️ Use distilled water only. Tap water will throw off readings.</div>
                <div class="tit-row"><span class="tit-label">Hardness Pipette</span><input type="number" step="0.1" class="tit-input" id="tit-hard-pipette" onchange="calcHardness(); saveTitrationData()"><span class="tit-unit">ml</span></div>
                <div class="tit-row"><span class="tit-label">Total Hardness</span><span class="tit-result calculated" id="tit-hardness">--</span><span class="tit-unit">ppm</span></div>
                <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">Calcium Pipette</span><input type="number" step="0.1" class="tit-input" id="tit-ca-pipette" onchange="calcCalcium(); saveTitrationData()"><span class="tit-unit">ml</span></div>
                <div class="tit-row"><span class="tit-label">Calcium</span><span class="tit-result calculated" id="tit-calcium">--</span><span class="tit-unit">ppm</span></div>
                <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">Magnesium</span><span class="tit-result calculated" id="tit-magnesium">--</span><span class="tit-unit">ppm</span></div>
                <div class="tit-note">Magnesium = (Hardness − Calcium Pipette) × 243</div>
            </div>
            <div class="tit-card">
                <div class="tit-title">Surface Volume</div>
                <div class="tit-row"><span class="tit-label">Surface Vol</span><input type="number" step="0.1" class="tit-input" id="tit-surface-vol" onchange="saveTitrationData()"><span class="tit-unit">bbl</span></div>
            </div>
            <button class="report-btn" onclick="logTitration()" style="background:#2e7d32">📝 Log Titration</button>
            <div style="background:#1b2838;border-radius:6px;padding:10px;margin-top:12px;max-height:200px;overflow-y:auto">
                <div style="font-size:10px;color:#888;text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">Titration Log <button style="background:#2d4a6f;border:none;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" onclick="openLogEdit('titration')">Edit</button></div>
                <div id="titration-log-content"><em style="color:#666">No titrations logged</em></div>
            </div>
            <button class="report-btn" onclick="showTitrationReport()">Generate Titration Report</button>
        </div>
    </div>
    </div><!-- end fluids-section -->

    <!-- ========== WELLBORE SECTION ========== -->
    <div id="wellbore-section" class="master-section">
        <div class="wb-tabs">
            <button class="wb-tab active" onclick="switchWBTab('plugs')">Plugs</button>
            <button class="wb-tab" onclick="switchWBTab('volumes')">Volumes</button>
            <button class="wb-tab" onclick="switchWBTab('swivel')">Swivel</button>
        </div>

        <div id="wb-plugs" class="wb-content active">
            <div class="plug-container">
                <!-- Live Header Banner -->
                <div class="plug-header-banner">
                    <div class="plug-header-item">
                        <div class="plug-header-label">Joint</div>
                        <div class="plug-header-value" id="plug-hdr-jnt">--</div>
                    </div>
                    <div class="plug-header-divider"></div>
                    <div class="plug-header-item">
                        <div class="plug-header-label">Plug</div>
                        <div class="plug-header-value" id="plug-hdr-plug">-- <span class="plug-total">/ --</span></div>
                    </div>
                    <div class="plug-header-divider"></div>
                    <div class="plug-header-item">
                        <div class="plug-header-label">Depth</div>
                        <div class="plug-header-value" id="plug-hdr-depth">--'</div>
                    </div>
                </div>

                <!-- Plug Info -->
                <div class="tit-card">
                    <div class="tit-title">Plug Info</div>
                    <div class="tit-row"><span class="tit-label">Plug #</span><input type="number" class="tit-input" id="plug-num" onchange="updatePlugHeader(); savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Total Plugs</span><input type="number" class="tit-input" id="plug-total" onchange="updatePlugHeader(); savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">JNT (Total)</span><input type="number" class="tit-input" id="plug-jnt" onchange="updatePlugHeader(); savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">JNT Out</span><input type="number" class="tit-input" id="plug-jnt-out" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Depth</span><input type="number" class="tit-input" id="plug-depth" onchange="updatePlugHeader(); savePlugData()"><span class="tit-unit">ft</span></div>
                    <div class="tit-row"><span class="tit-label">Time</span><input type="time" class="tit-input" id="plug-time" style="width:110px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                </div>

                <!-- Timing -->
                <div class="tit-card">
                    <div class="tit-title">Timing</div>
                    <div class="tit-row"><span class="tit-label">Drill Time</span><input type="number" class="tit-input" id="plug-drill-time" onchange="savePlugData()"><span class="tit-unit">min</span></div>
                    <div class="tit-row"><span class="tit-label">Wash Time</span><input type="number" class="tit-input" id="plug-wash-time" onchange="savePlugData()"><span class="tit-unit">min</span></div>
                    <div class="tit-row"><span class="tit-label">ETA</span><input type="time" class="tit-input" id="plug-eta" style="width:110px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                </div>

                <!-- String Weights -->
                <div class="tit-card">
                    <div class="tit-title">String Weights</div>
                    <div class="tit-row"><span class="tit-label">RIH Weight</span><input type="number" class="tit-input" id="plug-rih-wt" onchange="savePlugData()"><span class="tit-unit">klb</span></div>
                    <div class="tit-row"><span class="tit-label">Neutral Weight</span><input type="number" class="tit-input" id="plug-neutral-wt" onchange="savePlugData()"><span class="tit-unit">klb</span></div>
                    <div class="tit-row"><span class="tit-label">P/U Weight</span><input type="number" class="tit-input" id="plug-pu-wt" onchange="savePlugData()"><span class="tit-unit">klb</span></div>
                </div>

                <!-- Drilling Parameters -->
                <div class="tit-card">
                    <div class="tit-title">Drilling Parameters</div>
                    <div class="tit-row"><span class="tit-label">Torque Off</span><input type="number" class="tit-input" id="plug-torque-off" onchange="savePlugData()"><span class="tit-unit">ft-lb</span></div>
                    <div class="tit-row"><span class="tit-label">Torque On</span><input type="number" class="tit-input" id="plug-torque-on" onchange="savePlugData()"><span class="tit-unit">ft-lb</span></div>
                    <div class="tit-row"><span class="tit-label">RPM</span><input type="number" class="tit-input" id="plug-rpm" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">WOB</span><input type="number" step="0.1" class="tit-input" id="plug-wob" onchange="savePlugData()"><span class="tit-unit">klb</span></div>
                </div>

                <!-- Pressures & Rates -->
                <div class="tit-card">
                    <div class="tit-title">Pressures & Rates</div>
                    <div class="tit-row"><span class="tit-label">Circ Pressure</span><input type="number" class="tit-input" id="plug-circ" onchange="savePlugData()"><span class="tit-unit">PSI</span></div>
                    <div class="tit-row"><span class="tit-label">Pump Rate</span><input type="number" step="0.1" class="tit-input" id="plug-pr" onchange="savePlugData()"><span class="tit-unit">BPM</span></div>
                    <div class="tit-row"><span class="tit-label">Motor Pressure</span><input type="number" class="tit-input" id="plug-mp" onchange="savePlugData()"><span class="tit-unit">PSI</span></div>
                    <div class="tit-row"><span class="tit-label">Return Rate</span><input type="number" step="0.1" class="tit-input" id="plug-rr" onchange="savePlugData()"><span class="tit-unit">BPM</span></div>
                    <div class="tit-row"><span class="tit-label">Choke Size</span><input type="text" class="tit-input" id="plug-choke" style="width:80px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                </div>

                <!-- Fluid Properties -->
                <div class="tit-card">
                    <div class="tit-title">Fluid Properties</div>
                    <div class="tit-note" style="margin-bottom:10px">In = Pump Side &nbsp;|&nbsp; Out = Returns</div>
                    <div class="tit-row"><span class="tit-label">Mud Wt In</span><input type="number" step="0.1" class="tit-input" id="plug-mw-in" onchange="savePlugData()"><span class="tit-unit">ppg</span></div>
                    <div class="tit-row"><span class="tit-label">Mud Wt Out</span><input type="number" step="0.1" class="tit-input" id="plug-mw-out" onchange="savePlugData()"><span class="tit-unit">ppg</span></div>
                    <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">Mud Visc In</span><input type="number" class="tit-input" id="plug-mv-in" onchange="savePlugData()"><span class="tit-unit">sec</span></div>
                    <div class="tit-row"><span class="tit-label">Mud Visc Out</span><input type="number" class="tit-input" id="plug-mv-out" onchange="savePlugData()"><span class="tit-unit">sec</span></div>
                    <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">Chlorides In</span><input type="number" class="tit-input" id="plug-cl-in" onchange="savePlugData()"><span class="tit-unit">ppm</span></div>
                    <div class="tit-row"><span class="tit-label">Chlorides Out</span><input type="number" class="tit-input" id="plug-cl-out" onchange="savePlugData()"><span class="tit-unit">ppm</span></div>
                </div>

                <!-- Marker & Returns -->
                <div class="tit-card">
                    <div class="tit-title">Marker & Returns</div>
                    <div class="tit-note" style="margin-bottom:10px">Blue dye tracer — log when sent and when it surfaces</div>
                    <div class="tit-row"><span class="tit-label">Marker Sent</span><input type="time" class="tit-input" id="plug-marker-sent" style="width:110px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Surface Time</span><input type="time" class="tit-input" id="plug-surface-time" style="width:110px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Sand</span><select class="tit-input" id="plug-sand" style="width:100px" onchange="savePlugData()"><option value="">--</option><option value="none">None</option><option value="light">Light</option><option value="moderate">Moderate</option><option value="heavy">Heavy</option></select><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Gas</span><select class="tit-input" id="plug-gas" style="width:100px" onchange="savePlugData()"><option value="">--</option><option value="none">None</option><option value="light">Light</option><option value="moderate">Moderate</option><option value="heavy">Heavy</option></select><span class="tit-unit"></span></div>
                </div>

                <!-- Other -->
                <div class="tit-card">
                    <div class="tit-title">Other</div>
                    <div class="tit-row"><span class="tit-label">Int</span><input type="text" class="tit-input" id="plug-int" style="width:80px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Stalls</span><input type="text" class="tit-input" id="plug-stalls" style="width:80px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">FR</span><input type="text" class="tit-input" id="plug-fr" style="width:80px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">POP</span><input type="text" class="tit-input" id="plug-pop" style="width:80px" onchange="savePlugData()"><span class="tit-unit"></span></div>
                    <div class="tit-row" style="flex-direction:column;align-items:stretch"><span class="tit-label" style="margin-bottom:6px">Comments</span><textarea id="plug-comments" onchange="savePlugData()" style="width:100%;padding:8px;border:1px solid #2d4a6f;border-radius:6px;font-size:14px;background:#1b2838;color:#e0e0e0;min-height:60px;resize:vertical;font-family:inherit"></textarea></div>
                </div>

                <!-- Log Button -->
                <button class="report-btn" onclick="logPlug()" style="background:#2e7d32">📝 Log Plug</button>

                <!-- Plug Log -->
                <div style="background:#1b2838;border-radius:6px;padding:10px;margin-top:12px;max-height:300px;overflow-y:auto">
                    <div style="font-size:10px;color:#888;text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
                        Plug Log <span id="plug-log-count" style="color:#4fc3f7"></span>
                        <button style="background:#2d4a6f;border:none;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:9px;cursor:pointer" onclick="openLogEdit('plug')">Edit</button>
                    </div>
                    <div id="plug-log-content"><em style="color:#666">No plugs logged</em></div>
                </div>

                <!-- Generate Report -->
                <button class="report-btn" onclick="showPlugReport()">Generate Plug Report</button>
            </div>
        </div>

        <div id="wb-volumes" class="wb-content">
            <div class="plug-container">
                <!-- Live Header Banner (synced from Plug data) -->
                <div class="plug-header-banner">
                    <div class="plug-header-item">
                        <div class="plug-header-label">Joint</div>
                        <div class="plug-header-value" id="vol-hdr-jnt">--</div>
                    </div>
                    <div class="plug-header-divider"></div>
                    <div class="plug-header-item">
                        <div class="plug-header-label">Plug</div>
                        <div class="plug-header-value" id="vol-hdr-plug">-- <span class="plug-total">/ --</span></div>
                    </div>
                    <div class="plug-header-divider"></div>
                    <div class="plug-header-item">
                        <div class="plug-header-label">Depth</div>
                        <div class="plug-header-value" id="vol-hdr-depth">--'</div>
                    </div>
                </div>

                <!-- Tubing -->
                <div class="tit-card">
                    <div class="tit-title">Tubing</div>
                    <div class="tit-row"><span class="tit-label">OD</span><select class="tit-input" id="vol-tbg-od" style="width:100px" onchange="updateVolWeights('tbg'); calcVolumes(); saveVolData()"><option value="">--</option><option value="2-3/8">2-3/8"</option><option value="2-7/8">2-7/8"</option><option value="3-1/2">3-1/2"</option><option value="4-1/2">4-1/2"</option></select><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Weight</span><select class="tit-input" id="vol-tbg-wt" style="width:100px" onchange="updateVolID('tbg'); calcVolumes(); saveVolData()"><option value="">--</option></select><span class="tit-unit">lb/ft</span></div>
                    <div class="tit-row"><span class="tit-label">ID</span><span class="tit-result calculated" id="vol-tbg-id">--</span><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Grade</span><input type="text" class="tit-input" id="vol-tbg-grade" style="width:80px" onchange="saveVolData()" placeholder="L-80"><span class="tit-unit"></span></div>
                </div>

                <!-- Intermediate Casing -->
                <div class="tit-card">
                    <div class="tit-title">Intermediate Casing</div>
                    <div class="tit-row"><span class="tit-label">OD</span><select class="tit-input" id="vol-csg-od" style="width:100px" onchange="updateVolWeights('csg'); calcVolumes(); saveVolData()"><option value="">--</option><option value="4-1/2">4-1/2"</option><option value="5">5"</option><option value="5-1/2">5-1/2"</option><option value="7">7"</option><option value="7-5/8">7-5/8"</option><option value="8-5/8">8-5/8"</option><option value="9-5/8">9-5/8"</option></select><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Weight</span><select class="tit-input" id="vol-csg-wt" style="width:100px" onchange="updateVolID('csg'); calcVolumes(); saveVolData()"><option value="">--</option></select><span class="tit-unit">lb/ft</span></div>
                    <div class="tit-row"><span class="tit-label">ID</span><span class="tit-result calculated" id="vol-csg-id">--</span><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Grade</span><input type="text" class="tit-input" id="vol-csg-grade" style="width:80px" onchange="saveVolData()" placeholder="P-110"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Setting Depth</span><input type="number" class="tit-input" id="vol-csg-depth" onchange="calcVolumes(); saveVolData()"><span class="tit-unit">ft</span></div>
                </div>

                <!-- Liner -->
                <div class="tit-card">
                    <div class="tit-title">Liner</div>
                    <div class="tit-row"><span class="tit-label">OD</span><select class="tit-input" id="vol-liner-od" style="width:100px" onchange="updateVolWeights('liner'); calcVolumes(); saveVolData()"><option value="">--</option><option value="4-1/2">4-1/2"</option><option value="5">5"</option><option value="5-1/2">5-1/2"</option><option value="7">7"</option><option value="7-5/8">7-5/8"</option></select><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Weight</span><select class="tit-input" id="vol-liner-wt" style="width:100px" onchange="updateVolID('liner'); calcVolumes(); saveVolData()"><option value="">--</option></select><span class="tit-unit">lb/ft</span></div>
                    <div class="tit-row"><span class="tit-label">ID</span><span class="tit-result calculated" id="vol-liner-id">--</span><span class="tit-unit">in</span></div>
                    <div class="tit-row"><span class="tit-label">Grade</span><input type="text" class="tit-input" id="vol-liner-grade" style="width:80px" onchange="saveVolData()" placeholder="P-110"><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Top of Liner</span><input type="number" class="tit-input" id="vol-liner-tol" onchange="calcVolumes(); saveVolData()"><span class="tit-unit">ft</span></div>
                </div>

                <!-- BBL/FT Reference -->
                <div class="tit-card">
                    <div class="tit-title">Capacity (bbl/ft)</div>
                    <div class="tit-note" style="margin-bottom:10px">Auto-calculated from pipe selections above</div>
                    <div class="tit-row"><span class="tit-label">Tubing</span><span class="tit-result calculated" id="vol-bpf-tbg">--</span><span class="tit-unit">bbl/ft</span></div>
                    <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">CSG-TBG Annulus</span><span class="tit-result calculated" id="vol-bpf-csg-ann">--</span><span class="tit-unit">bbl/ft</span></div>
                    <div class="tit-row"><span class="tit-label">Liner-TBG Annulus</span><span class="tit-result calculated" id="vol-bpf-liner-ann">--</span><span class="tit-unit">bbl/ft</span></div>
                </div>

                <!-- Calculated Volumes -->
                <div class="tit-card" style="border:1px solid #4fc3f7">
                    <div class="tit-title" style="color:#4fc3f7">Calculated Volumes</div>
                    <div class="tit-note" style="margin-bottom:10px">Using depth from Plugs tab. Update plug depth to recalculate.</div>
                    <div class="tit-row"><span class="tit-label">Tubing Volume</span><span class="tit-result calculated" id="vol-calc-tbg" style="color:#4fc3f7;font-size:16px">--</span><span class="tit-unit">bbl</span></div>
                    <div class="tit-row" style="border-top:1px dashed #2d4a6f;margin-top:8px;padding-top:12px"><span class="tit-label">CSG Annulus</span><span class="tit-result calculated" id="vol-calc-csg-ann">--</span><span class="tit-unit">bbl</span></div>
                    <div class="tit-row"><span class="tit-label" style="font-size:10px;color:#666">Surface to TOL</span><span class="tit-result" id="vol-calc-csg-ann-note" style="font-size:10px;color:#666">--</span><span class="tit-unit"></span></div>
                    <div class="tit-row"><span class="tit-label">Liner Annulus</span><span class="tit-result calculated" id="vol-calc-liner-ann">--</span><span class="tit-unit">bbl</span></div>
                    <div class="tit-row"><span class="tit-label" style="font-size:10px;color:#666">TOL to Depth</span><span class="tit-result" id="vol-calc-liner-ann-note" style="font-size:10px;color:#666">--</span><span class="tit-unit"></span></div>
                    <div class="tit-row" style="border-top:2px solid #2d4a6f;margin-top:10px;padding-top:12px"><span class="tit-label" style="font-weight:700;color:#4fc3f7">Total Annular Vol</span><span class="tit-result calculated" id="vol-calc-ann-total" style="color:#4fc3f7;font-size:16px">--</span><span class="tit-unit">bbl</span></div>
                    <div class="tit-row" style="border-top:2px solid #4fc3f7;margin-top:10px;padding-top:12px;background:rgba(79,195,247,0.05);margin:-4px -12px -12px;padding:14px 12px;border-radius:0 0 6px 6px"><span class="tit-label" style="font-weight:700;color:#fff;font-size:14px">Total Wellbore Vol</span><span class="tit-result calculated" id="vol-calc-total" style="color:#fff;font-size:20px;font-weight:700">--</span><span class="tit-unit" style="color:#fff">bbl</span></div>
                </div>
            </div>
        </div>

        <div id="wb-swivel" class="wb-content">
            <div class="wb-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3v18"/><circle cx="12" cy="8" r="3"/><path d="M8 14h8"/><path d="M6 18h12"/></svg>
                <h3>Swivel</h3>
                <p>Swivel data and tracking. Coming soon.</p>
            </div>
        </div>
    </div><!-- end wellbore-section -->

    <!-- ====== TIMECARD SECTION ====== -->
    <div id="timecard-section" class="master-section">
        <div style="padding:12px">
            <!-- Job Defaults (collapsed) -->
            <div class="settings-accordion" id="tc-defaults-acc">
                <div class="settings-acc-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="settings-acc-title">Job Defaults <span class="settings-acc-status" id="tc-defaults-badge"></span></span>
                    <span class="settings-acc-chevron">▼</span>
                </div>
                <div class="settings-acc-body">
                    <div class="profile-input-group"><label>Operator</label><input type="text" id="tc-operator" placeholder="e.g. ExxonMobil" oninput="saveTimecardConfig()"></div>
                    <div style="display:flex;gap:8px">
                        <div class="profile-input-group" style="flex:1"><label>Rig</label><input type="text" id="tc-rig" placeholder="e.g. Ranger 1412" oninput="saveTimecardConfig()"></div>
                        <div class="profile-input-group" style="flex:1"><label>County</label><input type="text" id="tc-county" placeholder="e.g. upton, TX" oninput="saveTimecardConfig()"></div>
                    </div>
                </div>
            </div>
            <!-- Today's Log -->
            <div id="tc-today-status" style="text-align:center;padding:10px;background:#1b2838;border-radius:8px;border:1px solid #2d4a6f;margin:12px 0">
                <div style="font-size:11px;color:#888;text-transform:uppercase;margin-bottom:4px">Today</div>
                <div id="tc-today-label" style="font-size:13px;color:#66bb6a;font-weight:600">Not logged yet</div>
            </div>
            <button class="tc-log-btn tc-log-full" onclick="tcLogDay('full')">✅ Log Full Day (12/12)</button>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="tc-log-btn tc-log-shutdown" style="flex:1" onclick="tcLogDay('shutdown')">⏸️ Half Day (0/12)</button>
                <button class="tc-log-btn tc-log-custom" style="flex:1" onclick="tcLogDayCustom()">✏️ Custom</button>
            </div>
            <button class="tc-log-btn" style="background:#1b2838;color:#4fc3f7;border:1px solid #2d4a6f;margin-bottom:16px" onclick="tcAddPastDay()">📅 Add Past Day</button>
            <!-- Work Log -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-size:13px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px">Work Log</div>
                <button style="background:none;border:1px solid #2d4a6f;color:#888;padding:4px 10px;border-radius:4px;font-size:10px;cursor:pointer" id="tc-edit-toggle-btn" onclick="tcToggleEditMode()">Edit</button>
            </div>
            <div id="tc-work-log" style="margin-bottom:16px">
                <div style="font-size:12px;color:#666;text-align:center;padding:20px">No days logged yet</div>
            </div>
            <!-- Generate -->
            <div style="display:flex;gap:8px">
                <div class="profile-input-group" style="flex:1"><label>Start Date</label><input type="date" id="tc-start-date" style="padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#1b2838;color:#e0e0e0;font-size:14px;width:100%"></div>
                <div class="profile-input-group" style="flex:1"><label>End Date</label><input type="date" id="tc-end-date" style="padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#1b2838;color:#e0e0e0;font-size:14px;width:100%"></div>
            </div>
            <button class="tc-log-btn" style="background:#1565c0;color:white" onclick="tcPreviewTimecard()">📄 Preview Timecard</button>
        </div>
    </div>

    <!-- Timecard Preview Overlay -->
    <div class="tc-preview-overlay" id="tc-preview-overlay">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#1b2838;border-bottom:1px solid #2d4a6f;flex-shrink:0">
            <span style="font-size:16px;font-weight:700;color:#4fc3f7;text-transform:uppercase;letter-spacing:1px">📄 Timecard Preview</span>
            <button onclick="document.getElementById('tc-preview-overlay').classList.remove('show');document.body.style.overflow=''" style="background:none;border:1px solid #2d4a6f;color:#e0e0e0;width:36px;height:36px;border-radius:6px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center">✕</button>
        </div>
        <div class="tc-preview-body" id="tc-preview-body"></div>
        <div style="padding:12px 20px;background:#1b2838;border-top:1px solid #2d4a6f;display:flex;gap:8px;flex-shrink:0">
            <button class="tc-log-btn" style="background:#2e7d32;color:white;flex:1;margin:0" onclick="tcApproveAndShare()">⬇️ Download</button>
            <button class="tc-log-btn" style="background:#1565c0;color:white;flex:1;margin:0" onclick="tcEmailTimecard()">✉️ Email</button>
        </div>
    </div>

    <div class="modal" id="add-tank-modal">
        <div class="modal-content">
            <div class="modal-title">Add Tank</div>
            <div class="modal-tabs"><button class="modal-tab active" onclick="selectModalSide('pump')">Pump Side</button><button class="modal-tab" onclick="selectModalSide('return')">Return Side</button></div>
            <div class="modal-group"><label>Tank Type</label><select id="new-tank-type"><option value="">-- Select --</option></select></div>
            <div class="modal-group"><label>How Many?</label><select id="new-tank-qty"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
            <div class="modal-buttons"><button class="modal-btn cancel" onclick="hideAddTankModal()">Cancel</button><button class="modal-btn confirm" onclick="addTanks()">Add</button></div>
        </div>
    </div>

    <div class="modal" id="equalize-modal">
        <div class="modal-content">
            <div class="modal-title">Tank Equalization</div>
            <div class="equalize-info"><div id="equalize-question"></div><div class="equalize-tanks" id="equalize-tanks-list"></div></div>
            <div class="equalize-buttons"><button class="equalize-btn yes" onclick="confirmEqualize(true)">Yes, Equalized</button><button class="equalize-btn no" onclick="confirmEqualize(false)">No, Isolated</button><button class="equalize-btn cancel" onclick="hideEqualizeModal()">Cancel</button></div>
        </div>
    </div>

    <!-- Tank Group Modal -->

    <div class="report-screen" id="tank-report">
        <div class="report-header"><button class="report-close" onclick="hideTankReport()">×</button><h1>Tank Volume Report</h1><p id="tank-report-time"></p></div>
        <div class="report-body"><div class="report-logo"><img src="data:image/png;base64,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" alt="IPS"></div><div class="report-company">Intelligent Petroleum Solutions LLC</div><div id="tank-report-content"></div></div>
    </div>

    <div class="report-screen" id="titration-report">
        <div class="report-header"><button class="report-close" onclick="hideTitrationReport()">×</button><h1>Fluid Chemistry Analysis</h1><p id="tit-report-fluid"></p></div>
        <div class="report-body"><div class="report-logo"><img src="data:image/png;base64,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" alt="IPS"></div><div class="report-company">Intelligent Petroleum Solutions LLC</div><div id="tit-report-content"></div></div>
    </div>

    <!-- TRANSFER REPORT SCREEN -->
    <div class="report-screen" id="transfer-report">
        <div class="report-header"><button class="report-close" onclick="hideTransferReport()">×</button><h1>Fluid Transfer Report</h1><p id="transfer-report-time"></p></div>
        <div class="report-body" id="transfer-report-content"></div>
    </div>

    <!-- TURNOVER REPORT SCREEN (PREVIEW) -->
    <div class="report-screen" id="turnover-report">
        <div class="report-header"><button class="report-close" onclick="hideTurnoverReport()">×</button><h1>Shift Turnover Preview</h1><p id="turnover-report-time"></p></div>
        <div class="report-body" id="turnover-report-content"></div>
        <div style="padding:10px 15px">
            <div style="font-size:10px;color:#4fc3f7;text-transform:uppercase;font-weight:600;margin-bottom:6px">Turnover Notes</div>
            <textarea id="turnover-notes" placeholder="Add turnover notes here..." style="width:100%;min-height:80px;background:#0d1b2a;border:1px solid #2d4a6f;border-radius:6px;color:#e0e0e0;padding:8px;font-size:12px;resize:vertical;box-sizing:border-box"></textarea>
        </div>
        <div style="padding:10px 15px 15px;display:flex;gap:10px">
            <button onclick="hideTurnoverReport()" style="flex:1;padding:14px;background:#455a64;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">Cancel</button>
            <button onclick="sendTurnoverReport()" style="flex:1;padding:14px;background:#1565c0;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">📤 Send Report</button>
        </div>
    </div>

    <!-- MONITOR REPORT SCREEN -->
    <div class="report-screen" id="monitor-report">
        <div class="report-header"><button class="report-close" onclick="hideMonitorReport()">×</button><h1>Volume Monitor Report</h1><p id="monitor-report-time"></p></div>
        <div class="report-body" id="monitor-report-content"></div>
        <div style="padding:15px;display:flex;gap:10px">
            <button onclick="hideMonitorReport()" style="flex:1;padding:14px;background:#455a64;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">Cancel</button>
            <button onclick="sendMonitorReport()" style="flex:1;padding:14px;background:#1565c0;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">📤 Send Report</button>
        </div>
    </div>

    <!-- PLUG REPORT SCREEN -->
    <div class="report-screen" id="plug-report">
        <div class="report-header"><button class="report-close" onclick="hidePlugReport()">×</button><h1>Plug Drill-Out Report</h1><p id="plug-report-time"></p></div>
        <div class="report-body" id="plug-report-content"></div>
        <div style="padding:15px;display:flex;gap:10px">
            <button onclick="hidePlugReport()" style="flex:1;padding:14px;background:#455a64;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">Close</button>
            <button onclick="sharePlugReport()" style="flex:1;padding:14px;background:#1565c0;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600">📤 Share</button>
        </div>
    </div>

<script>
// Dragon Products 500 BBL Frac Tank Stick Chart
const STICK_CHART = {
    1: 4, 2: 9, 3: 13, 4: 18, 5: 22, 6: 27, 7: 31, 8: 36, 9: 40, 10: 45,
    11: 49, 12: 53, 13: 58, 14: 62, 15: 67, 16: 71, 17: 76, 18: 80, 19: 85, 20: 89,
    21: 94, 22: 98, 23: 103, 24: 107, 25: 111, 26: 116, 27: 120, 28: 125, 29: 129, 30: 134,
    31: 138, 32: 143, 33: 147, 34: 152, 35: 156, 36: 160, 37: 165, 38: 169, 39: 174, 40: 178,
    41: 183, 42: 188, 43: 193, 44: 198, 45: 203, 46: 208, 47: 213, 48: 218, 49: 223, 50: 228,
    51: 233, 52: 238, 53: 243, 54: 248, 55: 254, 56: 259, 57: 264, 58: 269, 59: 274, 60: 279,
    61: 284, 62: 289, 63: 294, 64: 299, 65: 304, 66: 309, 67: 314, 68: 319, 69: 324, 70: 329,
    71: 334, 72: 339, 73: 344, 74: 350, 75: 355, 76: 360, 77: 365, 78: 370, 79: 375, 80: 380,
    81: 385, 82: 390, 83: 395, 84: 400, 85: 405, 86: 410, 87: 415, 88: 420, 89: 425, 90: 430,
    91: 435, 92: 441, 93: 446, 94: 451, 95: 456, 96: 461, 97: 466, 98: 471, 99: 476, 100: 481,
    101: 486, 102: 491, 103: 496, 104: 501
};

// Pump Rate Chart - GPM values
const PUMP_CHART = {
    '0':    { 0.125: 0.000, 0.25: 0.000, 0.375: 0.000, 0.5: 0.000, 0.625: 0.000, 0.75: 0.000 },
    '1':    { 0.125: 0.019, 0.25: 0.038, 0.375: 0.056, 0.5: 0.075, 0.625: 0.094, 0.75: 0.113 },
    '1.5':  { 0.125: 0.022, 0.25: 0.044, 0.375: 0.065, 0.5: 0.088, 0.625: 0.109, 0.75: 0.131 },
    '2':    { 0.125: 0.025, 0.25: 0.050, 0.375: 0.075, 0.5: 0.100, 0.625: 0.125, 0.75: 0.150 },
    '2.25': { 0.125: 0.028, 0.25: 0.056, 0.375: 0.084, 0.5: 0.113, 0.625: 0.141, 0.75: 0.169 },
    '2.5':  { 0.125: 0.031, 0.25: 0.063, 0.375: 0.094, 0.5: 0.125, 0.625: 0.156, 0.75: 0.188 },
    '2.75': { 0.125: 0.034, 0.25: 0.069, 0.375: 0.103, 0.5: 0.138, 0.625: 0.172, 0.75: 0.206 },
    '3':    { 0.125: 0.038, 0.25: 0.075, 0.375: 0.113, 0.5: 0.150, 0.625: 0.188, 0.75: 0.225 },
    '3.25': { 0.125: 0.041, 0.25: 0.081, 0.375: 0.122, 0.5: 0.163, 0.625: 0.203, 0.75: 0.244 },
    '3.5':  { 0.125: 0.044, 0.25: 0.088, 0.375: 0.131, 0.5: 0.175, 0.625: 0.219, 0.75: 0.263 },
    '3.75': { 0.125: 0.047, 0.25: 0.094, 0.375: 0.141, 0.5: 0.188, 0.625: 0.234, 0.75: 0.281 },
    '4':    { 0.125: 0.050, 0.25: 0.100, 0.375: 0.150, 0.5: 0.200, 0.625: 0.250, 0.75: 0.300 },
    '4.25': { 0.125: 0.053, 0.25: 0.106, 0.375: 0.159, 0.5: 0.213, 0.625: 0.266, 0.75: 0.319 },
    '4.5':  { 0.125: 0.056, 0.25: 0.113, 0.375: 0.169, 0.5: 0.225, 0.625: 0.281, 0.75: 0.338 },
    '4.75': { 0.125: 0.059, 0.25: 0.119, 0.375: 0.178, 0.5: 0.238, 0.625: 0.297, 0.75: 0.356 },
    '5':    { 0.125: 0.063, 0.25: 0.125, 0.375: 0.188, 0.5: 0.250, 0.625: 0.313, 0.75: 0.375 },
    '5.25': { 0.125: 0.066, 0.25: 0.131, 0.375: 0.197, 0.5: 0.263, 0.625: 0.328, 0.75: 0.394 },
    '5.5':  { 0.125: 0.069, 0.25: 0.138, 0.375: 0.206, 0.5: 0.275, 0.625: 0.344, 0.75: 0.413 },
    '5.75': { 0.125: 0.072, 0.25: 0.144, 0.375: 0.216, 0.5: 0.288, 0.625: 0.359, 0.75: 0.431 },
    '6':    { 0.125: 0.075, 0.25: 0.150, 0.375: 0.225, 0.5: 0.300, 0.625: 0.375, 0.75: 0.450 },
    '6.25': { 0.125: 0.078, 0.25: 0.156, 0.375: 0.234, 0.5: 0.313, 0.625: 0.391, 0.75: 0.469 },
    '6.5':  { 0.125: 0.081, 0.25: 0.163, 0.375: 0.244, 0.5: 0.325, 0.625: 0.406, 0.75: 0.488 },
    '6.75': { 0.125: 0.084, 0.25: 0.169, 0.375: 0.253, 0.5: 0.338, 0.625: 0.422, 0.75: 0.506 },
    '7':    { 0.125: 0.088, 0.25: 0.175, 0.375: 0.263, 0.5: 0.350, 0.625: 0.438, 0.75: 0.525 },
    '7.25': { 0.125: 0.091, 0.25: 0.181, 0.375: 0.272, 0.5: 0.363, 0.625: 0.453, 0.75: 0.544 },
    '7.5':  { 0.125: 0.094, 0.25: 0.188, 0.375: 0.281, 0.5: 0.375, 0.625: 0.469, 0.75: 0.563 },
    '7.75': { 0.125: 0.097, 0.25: 0.194, 0.375: 0.291, 0.5: 0.388, 0.625: 0.484, 0.75: 0.581 },
    '8':    { 0.125: 0.100, 0.25: 0.200, 0.375: 0.300, 0.5: 0.400, 0.625: 0.500, 0.75: 0.600 }
};
const TREAT_LABELS = { 0.125: '1/8', 0.25: '1/4', 0.375: '3/8', 0.5: '1/2', 0.625: '5/8', 0.75: '3/4' };

let injData = { pumpRate: null, frTreat: null, lubeTreat: null, history: [] };
function loadInjData() { const s = localStorage.getItem('ipsInjV5'); if (s) injData = JSON.parse(s); }
function saveInjData() { localStorage.setItem('ipsInjV5', JSON.stringify(injData)); firebaseSaveInjData(); }
function updatePumpRate() {
    const rate = document.getElementById('pump-rate-select').value;
    if (rate) {
        const old = injData.pumpRate;
        injData.pumpRate = rate;
        document.getElementById('current-pump-rate').innerHTML = rate + '<span style="font-size:18px;color:#888"> BPM</span>';
        if (old && old !== rate) injData.history.unshift({ time: new Date().toISOString(), type: 'pump', from: old, to: rate });
        saveInjData(); updateInjTargets(); renderInjHist();
    }
}
function updateInjTargets() {
    const rate = injData.pumpRate;
    const frT = document.getElementById('fr-treatment').value;
    const lubeT = document.getElementById('lube-treatment').value;
    injData.frTreat = frT || null; injData.lubeTreat = lubeT || null; saveInjData();
    document.getElementById('fr-target').textContent = (rate && frT && PUMP_CHART[rate]) ? PUMP_CHART[rate][parseFloat(frT)].toFixed(3) : '--';
    document.getElementById('lube-target').textContent = (rate && lubeT && PUMP_CHART[rate]) ? PUMP_CHART[rate][parseFloat(lubeT)].toFixed(3) : '--';
}
function logInjChange(chem) {
    const rate = injData.pumpRate, treat = chem === 'fr' ? document.getElementById('fr-treatment').value : document.getElementById('lube-treatment').value;
    if (!rate || !treat) { alert('Set pump rate and treatment first'); return; }
    const target = PUMP_CHART[rate][parseFloat(treat)];
    injData.history.unshift({ time: new Date().toISOString(), type: chem, pumpRate: rate, treat: TREAT_LABELS[parseFloat(treat)], gpm: target });
    saveInjData(); renderInjHist();
    alert((chem === 'fr' ? 'FR' : 'Lube') + ' logged!\nRate: ' + rate + ' BPM\nTreatment: ' + TREAT_LABELS[parseFloat(treat)] + '/10bbl\nTarget: ' + target.toFixed(3) + ' GPM');
}
function renderInjHist() {
    const el = document.getElementById('inj-history');
    if (!injData.history || !injData.history.length) { el.innerHTML = '<em style="color:#666">No changes logged</em>'; return; }
    el.innerHTML = injData.history.slice(0, 20).map(h => {
        const t = new Date(h.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        if (h.type === 'pump') return '<div style="font-size:11px;color:#aaa;padding:4px 0;border-bottom:1px solid #2d4a6f"><span style="color:#4fc3f7">' + t + '</span> Pump: ' + h.from + ' → ' + h.to + ' BPM</div>';
        return '<div style="font-size:11px;color:#aaa;padding:4px 0;border-bottom:1px solid #2d4a6f"><span style="color:#4fc3f7">' + t + '</span> ' + (h.type === 'fr' ? 'FR' : 'Lube') + ': ' + h.treat + '/10bbl @ ' + h.pumpRate + ' → ' + h.gpm.toFixed(3) + ' GPM</div>';
    }).join('');
}
function loadInjUI() {
    loadInjData();
    if (injData.pumpRate) { document.getElementById('pump-rate-select').value = injData.pumpRate; document.getElementById('current-pump-rate').innerHTML = injData.pumpRate + '<span style="font-size:18px;color:#888"> BPM</span>'; }
    if (injData.frTreat) document.getElementById('fr-treatment').value = injData.frTreat;
    if (injData.lubeTreat) document.getElementById('lube-treatment').value = injData.lubeTreat;
    updateInjTargets(); renderInjHist();
}
function showInjReport() {
    const now = new Date();
    document.getElementById('inj-report-time').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    let html = '<div class="report-section"><div class="report-section-title">Current Settings</div>';
    html += '<div class="report-row"><span class="report-row-label">Pump Rate</span><span class="report-row-value">' + (injData.pumpRate || '--') + ' BPM</span></div>';
    if (injData.pumpRate && injData.frTreat) { const t = PUMP_CHART[injData.pumpRate][parseFloat(injData.frTreat)]; html += '<div class="report-row"><span class="report-row-label">FR</span><span class="report-row-value" style="color:#66bb6a">' + TREAT_LABELS[parseFloat(injData.frTreat)] + '/10bbl → ' + t.toFixed(3) + ' GPM</span></div>'; }
    if (injData.pumpRate && injData.lubeTreat) { const t = PUMP_CHART[injData.pumpRate][parseFloat(injData.lubeTreat)]; html += '<div class="report-row"><span class="report-row-label">Lube</span><span class="report-row-value" style="color:#ffa726">' + TREAT_LABELS[parseFloat(injData.lubeTreat)] + '/10bbl → ' + t.toFixed(3) + ' GPM</span></div>'; }
    html += '</div>';
    if (injData.history && injData.history.length) {
        html += '<div class="report-section"><div class="report-section-title">Injection Log</div>';
        injData.history.forEach(h => { const d = new Date(h.time), ts = d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); if (h.type === 'pump') html += '<div class="report-row"><span class="report-row-label">' + ts + '</span><span class="report-row-value">Pump: ' + h.from + ' → ' + h.to + '</span></div>'; else html += '<div class="report-row"><span class="report-row-label">' + ts + '</span><span class="report-row-value">' + (h.type === 'fr' ? 'FR' : 'Lube') + ': ' + h.treat + ' @ ' + h.pumpRate + ' = ' + h.gpm.toFixed(3) + '</span></div>'; });
        html += '</div>';
    }
    html += '<div class="report-timestamp">' + now.toLocaleString() + '</div>';
    document.getElementById('inj-report-content').innerHTML = html;
    document.getElementById('injection-report').classList.add('show');
}
function hideInjReport() { document.getElementById('injection-report').classList.remove('show'); }
function resetInjHistory() { if(confirm('Clear injection history?')) { injData.history = []; saveInjData(); renderInjHist(); } }

function bblToInches(bbl) {
    let closest = 1, diff = Math.abs(STICK_CHART[1] - bbl);
    for (let i in STICK_CHART) { const d = Math.abs(STICK_CHART[i] - bbl); if (d < diff) { diff = d; closest = parseInt(i); } }
    return closest;
}
function inchesToBbl(inches) {
    if (inches <= 0) return 0;
    if (inches >= 104) return STICK_CHART[104];
    const lower = Math.floor(inches);
    const upper = Math.ceil(inches);
    if (lower === upper || lower <= 0) return STICK_CHART[upper] || 0;
    const lowerBbl = lower === 0 ? 0 : (STICK_CHART[lower] || 0);
    const upperBbl = STICK_CHART[upper] || 0;
    const frac = inches - lower;
    return Math.round(lowerBbl + (upperBbl - lowerBbl) * frac);
}

const pumpTypes = [
    { value: 'brine10', label: 'Brine 10#', badgeText: 'BRINE 10#', color: 'brine10' },
    { value: 'brine119', label: 'Brine 11.9#', badgeText: 'BRINE 11.9#', color: 'brine119' },
    { value: 'aphron', label: 'Aphron Mud', badgeText: 'APHRON', color: 'aphron' },
    { value: 'recirc', label: 'Recirc', badgeText: 'RECIRC', color: 'recirc' },
    { value: 'freshwater', label: 'Freshwater', badgeText: 'FRESH', color: 'freshwater' },
    { value: 'packer', label: 'Packer Fluid', badgeText: 'PACKER', color: 'packer' }
];
const returnTypes = [
    { value: 'sandcat', label: 'Sandcat', badgeText: 'SANDCAT', color: 'sandcat', hasContents: true },
    { value: 'trash', label: 'Trash Tank', badgeText: 'TRASH', color: 'trash', hasContents: true, canEqualize: true },
    { value: 'return', label: 'Settling Tank', badgeText: '', color: 'other', hasContents: true, canEqualize: true },
    { value: 'processed', label: 'Processed Returns', badgeText: 'PROCESSED', color: 'processed', hasContents: true, canEqualize: true }
];
const returnEqualizeTypes = ['trash', 'return', 'processed'];
const contentsOptions = [
    { value: '', label: '--', color: 'other' },
    { value: 'brine', label: 'Brine', color: 'brine10' },
    { value: 'mud', label: 'Mud', color: 'mud' },
    { value: 'recirc', label: 'Recirc', color: 'recirc' },
    { value: 'freshwater', label: 'Fresh', color: 'freshwater' },
    { value: 'mixed', label: 'Mixed', color: 'mixed' }
];

let data = { pumpTanks: [], returnTanks: [], jetsHour: 0, jetsShift: 0, lastSystemTotal: null, lastCheckTime: null, history: [] };
let titData = { fluidType: 'aphron', viscosity: '', density: '', ph: '', pf: '', mf: '', snType: 'fresh', clPipette: '', hardPipette: '', caPipette: '', surfaceVol: '', r600: '', r300: '', r200: '', r100: '', r6: '', r3: '', gel10s: '', gel10m: '' };
let profileData = { name: '', initials: '', wellName: '' };
let currentSide = 'pump', modalSide = 'pump', pendingJet = null, jetType = 'out';

// Profile functions
function loadProfile() {
    const p = localStorage.getItem('ipsProfile');
    if (p) profileData = JSON.parse(p);
    updateProfileButton();
}
function saveProfileData() {
    localStorage.setItem('ipsProfile', JSON.stringify(profileData));
    updateProfileButton();
}
function updateProfileButton() {
    const btn = document.getElementById('profile-btn');
    if (profileData.name) {
        btn.classList.add('has-profile');
        btn.title = profileData.name;
    } else {
        btn.classList.remove('has-profile');
    }
    const wellEl = document.getElementById('header-well-name');
    if (wellEl) {
        const wn = profileData.wellName || '';
        wellEl.textContent = wn || 'Tap to set well name';
        wellEl.classList.toggle('empty', !wn);
    }
}
function openProfileModal() {
    document.getElementById('profile-name-input').value = profileData.name || '';
    document.getElementById('profile-well-input').value = profileData.wellName || '';
    updateInitialsPreview();
    renderPackerTreatedControls();
    loadTimecardConfigUI();
    const oi = document.getElementById('ble-offset-input');
    if (oi) { oi.value = bleOffsetInches; updateOffsetDisplay(); }
    // Refresh room status display
    updateAdminUI();
    updateRoomUsersUI(document.getElementById('room-users-badge')._users || []);
    // Update room badge in accordion
    const badge = document.getElementById('settings-room-status-badge');
    if (badge) badge.textContent = fbRoom ? '— Connected' : '— Not connected';
    document.getElementById('profile-modal').classList.add('show');
    document.body.style.overflow = 'hidden';
}
function closeProfileModal() {
    document.getElementById('profile-modal').classList.remove('show');
    document.body.style.overflow = '';
}
function updateInitialsPreview() {
    const name = document.getElementById('profile-name-input').value.trim();
    const initials = getInitials(name);
    document.getElementById('profile-initials-preview').textContent = initials || '--';
}
function getInitials(name) {
    if (!name) return '';
    const parts = name.split(' ').filter(p => p.length > 0);
    if (parts.length === 0) return '';
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}
function updateWellNamePreview() {
    const val = (document.getElementById('profile-well-input').value || '').trim();
    const wellEl = document.getElementById('header-well-name');
    wellEl.textContent = val || 'Tap to set well name';
    wellEl.classList.toggle('empty', !val);
}
function renderPackerTreatedControls() {
    const container = document.getElementById('packer-treated-controls');
    if (!container) return;
    const packerTanks = data.pumpTanks.filter(t => t.type === 'packer');
    if (packerTanks.length === 0) {
        container.innerHTML = '<div style="font-size:12px;color:#666;padding:8px 0">No packer tanks added</div>';
        return;
    }
    container.innerHTML = packerTanks.map(t => {
        const isTreated = !!t.treated;
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#1b2838;border-radius:6px;margin-bottom:6px;border:1px solid #2d4a6f">' +
            '<span style="font-size:13px;color:#ff7043;font-weight:600">' + t.name + '</span>' +
            '<div style="display:flex;background:#0d1b2a;border-radius:6px;padding:3px;gap:2px">' +
            '<button onclick="setPackerTreated(' + t.id + ',false)" style="padding:6px 12px;border:none;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;' + (!isTreated ? 'background:#c62828;color:white' : 'background:transparent;color:#888') + '">UNTREATED</button>' +
            '<button onclick="setPackerTreated(' + t.id + ',true)" style="padding:6px 12px;border:none;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;' + (isTreated ? 'background:#2e7d32;color:white' : 'background:transparent;color:#888') + '">TREATED</button>' +
            '</div></div>';
    }).join('');
}
function setPackerTreated(tankId, treated) {
    const tank = data.pumpTanks.find(t => t.id === tankId);
    if (tank) {
        tank.treated = treated;
        saveData();
        render();
        renderPackerTreatedControls();
    }
}
function saveProfile() {
    const name = document.getElementById('profile-name-input').value.trim();
    profileData.name = name;
    profileData.initials = getInitials(name);
    const newWellName = (document.getElementById('profile-well-input').value || '').trim();
    const oldWellName = profileData.wellName;
    profileData.wellName = newWellName;
    saveProfileData();
    closeProfileModal();
    voicePlayDing();
    // If well name changed, rejoin Firebase room
    if (newWellName !== oldWellName) {
        firebaseLeaveRoom();
        if (newWellName) firebaseJoinRoom(newWellName);
    }
    // Update presence
    if (fbRoom && fbDb) firebaseUpdatePresence();
}

// ========== FIREBASE REALTIME SYNC ==========
/*
 * Firebase Config — REPLACE with your own Firebase project credentials.
 * 1. Go to https://console.firebase.google.com
 * 2. Create a new project (free Spark plan is fine)
 * 3. Enable "Realtime Database" (NOT Firestore) 
 * 4. Set database rules to: { "rules": { ".read": true, ".write": true } }
 *    (For production, add proper auth rules later)
 * 5. Copy your config object below
 */
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDpzbIpt0apWPScGDKMEzw1MhanGqz0lXg",
    authDomain: "ips-tracker-72f0b.firebaseapp.com",
    databaseURL: "https://ips-tracker-72f0b-default-rtdb.firebaseio.com",
    projectId: "ips-tracker-72f0b",
    storageBucket: "ips-tracker-72f0b.firebasestorage.app",
    messagingSenderId: "1014353405467",
    appId: "1:1014353405467:web:221e4d41e328235b687abe",
    measurementId: "G-8CFN1WZTFK"
};

let fbApp = null, fbDb = null, fbRoom = null, fbListeners = [], fbPresenceRef = null;
let _lastLocalWriteTime = 0; // Timestamp of our last write to Firebase
let _lastLocalWriteBy = ''; // Who wrote last (our initials)
let fbIsAdmin = false; // Whether current user is the room admin
let fbAdminInitials = ''; // The admin's initials for display

function firebaseInit() {
    try {
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded — check network/content blockers');
            setSyncStatus('offline', 'Firebase SDK failed to load');
            return false;
        }
        if (FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
            console.warn('Firebase not configured — running in local-only mode');
            setSyncStatus('no-room', 'Local Only');
            return false;
        }
        if (firebase.apps && firebase.apps.length) {
            fbApp = firebase.apps[0];
        } else {
            fbApp = firebase.initializeApp(FIREBASE_CONFIG);
        }
        fbDb = firebase.database();
        console.log('Firebase initialized successfully');
        return true;
    } catch(e) {
        console.error('Firebase init failed:', e);
        setSyncStatus('offline', 'Firebase Error: ' + e.message);
        return false;
    }
}

function setSyncStatus(state, label) {
    const el = document.getElementById('sync-status');
    const lbl = document.getElementById('sync-label');
    if (!el) return;
    el.className = 'sync-strip ' + state;
    lbl.textContent = label || '';
}

function wellNameToRoomKey(wellName) {
    // Sanitize for Firebase path: no . $ # [ ] / 
    return wellName.replace(/[.$#\[\]\/]/g, '_').toLowerCase().replace(/\s+/g, '-');
}

function firebaseJoinRoom(wellName) {
    if (!fbDb || !wellName) return;
    fbRoom = wellNameToRoomKey(wellName);
    console.log('Joining Firebase room:', fbRoom);
    setSyncStatus('syncing', 'Connecting...');
    
    // Listen for all data paths
    const paths = [
        { path: 'tanks', handler: onRemoteTanks },
        { path: 'titData', handler: onRemoteTitData },
        { path: 'injData', handler: onRemoteInjData },
        { path: 'plugData', handler: onRemotePlugData },
        { path: 'plugLog', handler: onRemotePlugLog },
        { path: 'titrationLog', handler: onRemoteTitrationLog },
        { path: 'volData', handler: onRemoteVolData }
    ];
    
    paths.forEach(p => {
        const ref = fbDb.ref('rooms/' + fbRoom + '/' + p.path);
        ref.on('value', p.handler);
        fbListeners.push({ ref, event: 'value', handler: p.handler });
    });
    
    // Listen for admin info
    const adminRef = fbDb.ref('rooms/' + fbRoom + '/admin');
    adminRef.on('value', snap => {
        if (snap.exists()) {
            const adminData = snap.val();
            fbAdminInitials = adminData.initials || '';
            fbIsAdmin = (profileData.initials && profileData.initials === fbAdminInitials);
        }
        updateAdminUI();
    });
    fbListeners.push({ ref: adminRef, event: 'value', handler: () => {} });
    
    // Presence system
    firebaseUpdatePresence();
    listenPresence();
    
    // Monitor connection state
    fbDb.ref('.info/connected').on('value', snap => {
        if (snap.val() === true) {
            const adminLabel = fbIsAdmin ? ' (Admin)' : '';
            setSyncStatus('online', 'Synced: ' + wellName + adminLabel);
            if (fbPresenceRef) fbPresenceRef.onDisconnect().remove();
        } else {
            setSyncStatus('offline', 'Offline');
        }
    });
    
    // Check if room exists — if not, this user becomes admin and pushes data
    setTimeout(() => {
        fbDb.ref('rooms/' + fbRoom + '/admin').once('value', snap => {
            if (!snap.exists()) {
                // This user is the room creator — set as admin
                console.log('Room empty — setting as admin and pushing local data');
                fbDb.ref('rooms/' + fbRoom + '/admin').set({
                    initials: profileData.initials || '',
                    name: profileData.name || '',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                fbIsAdmin = true;
                fbAdminInitials = profileData.initials || '';
                firebasePushAll();
                updateAdminUI();
            }
            const adminLabel = fbIsAdmin ? ' (Admin)' : '';
            setSyncStatus('online', 'Synced: ' + wellName + adminLabel);
        });
    }, 1000);
}

function updateAdminUI() {
    const addTankBtn = document.getElementById('admin-add-tank-btn');
    if (addTankBtn) {
        if (fbRoom && !fbIsAdmin) addTankBtn.style.display = 'none';
        else addTankBtn.style.display = '';
    }
    const inviteBtn = document.getElementById('invite-user-btn');
    if (inviteBtn) inviteBtn.style.display = fbRoom ? '' : 'none';
    const pushBtn = document.getElementById('push-data-btn');
    if (pushBtn) pushBtn.style.display = (fbRoom && fbIsAdmin) ? '' : 'none';
    const claimBtn = document.getElementById('claim-admin-btn');
    if (claimBtn) claimBtn.style.display = (fbRoom && !fbIsAdmin) ? '' : 'none';
    if (fbRoom) {
        const wellName = profileData.wellName || '';
        const adminLabel = fbIsAdmin ? ' (Admin)' : '';
        setSyncStatus('online', 'Synced: ' + wellName + adminLabel);
    }
}

function firebaseLeaveRoom() {
    // Remove all listeners
    fbListeners.forEach(l => l.ref.off(l.event, l.handler));
    fbListeners = [];
    // Remove presence
    if (fbPresenceRef) { fbPresenceRef.remove(); fbPresenceRef = null; }
    fbRoom = null;
    fbIsAdmin = false;
    fbAdminInitials = '';
    setSyncStatus('no-room', 'No Room');
    updateRoomUsersUI([]);
}

function firebaseUpdatePresence() {
    if (!fbDb || !fbRoom) return;
    const uid = profileData.initials || 'ANON';
    fbPresenceRef = fbDb.ref('rooms/' + fbRoom + '/presence/' + uid);
    fbPresenceRef.set({
        name: profileData.name || 'Unknown',
        initials: uid,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
    });
    fbPresenceRef.onDisconnect().remove();
    // Heartbeat every 30s
    if (window._fbHeartbeat) clearInterval(window._fbHeartbeat);
    window._fbHeartbeat = setInterval(() => {
        if (fbPresenceRef) fbPresenceRef.update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }, 30000);
}

function listenPresence() {
    if (!fbDb || !fbRoom) return;
    const ref = fbDb.ref('rooms/' + fbRoom + '/presence');
    ref.on('value', snap => {
        const users = [];
        const now = Date.now();
        snap.forEach(child => {
            const u = child.val();
            // Only show users active in last 5 minutes
            if (u.lastSeen && (now - u.lastSeen) < 300000) {
                users.push(u);
            }
        });
        updateRoomUsersUI(users);
    });
    fbListeners.push({ ref, event: 'value', handler: () => {} });
}

function updateRoomUsersUI(users) {
    const badge = document.getElementById('room-users-badge');
    const countEl = document.getElementById('room-user-count');
    if (users.length > 0) {
        badge.style.display = '';
        countEl.textContent = users.length;
        badge._users = users;
    } else {
        badge.style.display = 'none';
        badge._users = [];
    }
    // Update profile modal users list
    const listEl = document.getElementById('profile-users-list');
    if (listEl) {
        if (users.length === 0) {
            listEl.innerHTML = '<div style="font-size:12px;color:#888">No users online</div>';
        } else {
            listEl.innerHTML = users.map(u => {
                const isAdmin = u.initials === fbAdminInitials;
                const isYou = u.initials === (profileData.initials || '');
                const roleBadge = isAdmin ? '<span style="background:rgba(255,167,38,0.2);color:#ffa726;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;margin-left:6px">ADMIN</span>' : '';
                const youBadge = isYou ? '<span style="color:#66bb6a;font-size:10px;margin-left:4px">(you)</span>' : '';
                return '<div style="display:flex;align-items:center;padding:6px 0;border-bottom:1px solid #2d4a6f">' +
                    '<div style="width:28px;height:28px;border-radius:50%;background:' + (isAdmin ? 'rgba(255,167,38,0.2)' : 'rgba(79,195,247,0.15)') + ';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:' + (isAdmin ? '#ffa726' : '#4fc3f7') + ';margin-right:8px">' + (u.initials || '??') + '</div>' +
                    '<div style="flex:1"><div style="font-size:12px;color:#e0e0e0;font-weight:600">' + (u.name || u.initials) + youBadge + roleBadge + '</div></div></div>';
            }).join('');
        }
    }
    // Update room info
    const roomEl = document.getElementById('profile-room-info');
    if (roomEl) {
        if (fbRoom) {
            const role = fbIsAdmin ? '<span style="color:#ffa726;font-weight:700">Admin</span>' : '<span style="color:#4fc3f7">Member</span>';
            roomEl.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center">' +
                '<div><div style="font-size:13px;color:#e0e0e0;font-weight:600">' + (profileData.wellName || fbRoom) + '</div>' +
                '<div style="font-size:10px;color:#888;margin-top:2px">Role: ' + role + '</div></div>' +
                '<div style="width:8px;height:8px;border-radius:50%;background:#66bb6a;box-shadow:0 0 4px rgba(102,187,106,0.6)"></div></div>';
        } else {
            roomEl.innerHTML = '<div style="font-size:12px;color:#888">Not connected — set a well name to sync</div>';
        }
    }
}

function showRoomUsersInfo() {
    const badge = document.getElementById('room-users-badge');
    const users = badge._users || [];
    if (users.length === 0) return;
    const names = users.map(u => {
        const isAdmin = u.initials === fbAdminInitials;
        return (u.name || u.initials) + (isAdmin ? ' ⭐ Admin' : '');
    }).join('\n• ');
    alert('Users in room (' + users.length + '):\n• ' + names);
}

// === Firebase WRITE helpers ===
function firebaseSaveTanks() {
    if (!fbDb || !fbRoom) { console.log('[SYNC] Save skipped: no db or room', !!fbDb, fbRoom); return; }
    _lastLocalWriteTime = Date.now();
    _lastLocalWriteBy = profileData.initials || '';
    console.log('[SYNC] Writing tanks to Firebase as ' + _lastLocalWriteBy + ' room=' + fbRoom);
    fbDb.ref('rooms/' + fbRoom + '/tanks').set({
        pumpTanks: data.pumpTanks || [],
        returnTanks: data.returnTanks || [],
        jetsHour: data.jetsHour || 0,
        jetsShift: data.jetsShift || 0,
        lastSystemTotal: data.lastSystemTotal || null,
        lastCheckTime: data.lastCheckTime || null,
        history: (data.history || []).slice(0, 50),
        transferLog: (data.transferLog || []).slice(0, 100),
        _updatedAt: firebase.database.ServerValue.TIMESTAMP,
        _updatedBy: profileData.initials || ''
    }).catch(e => { console.error('Firebase save error:', e); });
}

function firebaseSaveTitData() {
    if (!fbDb || !fbRoom) return;
    fbDb.ref('rooms/' + fbRoom + '/titData').set(titData).catch(e => console.error(e));
}

function firebaseSaveInjData() {
    if (!fbDb || !fbRoom) return;
    fbDb.ref('rooms/' + fbRoom + '/injData').set(injData).catch(e => console.error(e));
}

function firebaseSavePlugData() {
    if (!fbDb || !fbRoom) return;
    const pd = {};
    PLUG_FIELDS.forEach(id => { const el = document.getElementById(id); if (el) pd[id] = el.value; });
    fbDb.ref('rooms/' + fbRoom + '/plugData').set(pd).catch(e => console.error(e));
}

function firebaseSavePlugLog() {
    if (!fbDb || !fbRoom) return;
    const logs = JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    fbDb.ref('rooms/' + fbRoom + '/plugLog').set(logs).catch(e => console.error(e));
}

function firebaseSaveTitrationLog() {
    if (!fbDb || !fbRoom) return;
    fbDb.ref('rooms/' + fbRoom + '/titrationLog').set(titrationLog).catch(e => console.error(e));
}

function firebaseSaveVolData() {
    if (!fbDb || !fbRoom) return;
    const d = {};
    VOL_FIELDS.forEach(id => { const el = document.getElementById(id); if (el) d[id] = el.value; });
    fbDb.ref('rooms/' + fbRoom + '/volData').set(d).catch(e => console.error(e));
}

function adminPushData() {
    if (!fbRoom || !fbDb) { alert('Not connected to a room'); return; }
    if (!confirm('Push your local tank data to the room?\n\nThis will overwrite the room data for all users.')) return;
    firebasePushAll();
    alert('Data pushed! Other users will see your tanks now.');
}

function claimAdmin() {
    if (!fbRoom || !fbDb) { alert('Not connected to a room'); return; }
    if (!confirm('Become room admin?\n\nThis lets you add/delete tanks and push data.')) return;
    fbDb.ref('rooms/' + fbRoom + '/admin').set({
        initials: profileData.initials || '',
        name: profileData.name || '',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    fbIsAdmin = true;
    fbAdminInitials = profileData.initials || '';
    updateAdminUI();
    // Also push data after claiming admin
    firebasePushAll();
    alert('You are now admin. Your data has been pushed to the room.');
}

function firebasePushAll() {
    firebaseSaveTanks();
    firebaseSaveTitData();
    firebaseSaveInjData();
    firebaseSavePlugData();
    firebaseSavePlugLog();
    firebaseSaveTitrationLog();
    firebaseSaveVolData();
}

// Helper: Firebase sometimes converts arrays to objects — normalize them
function fbToArray(val) {
    if (Array.isArray(val)) return val;
    if (val && typeof val === 'object') return Object.values(val);
    return [];
}

// === Firebase READ handlers (remote changes) ===
function onRemoteTanks(snap) {
    if (!snap.exists()) return;
    try {
        const d = snap.val();
        const newPump = d.pumpTanks ? fbToArray(d.pumpTanks) : [];
        const newReturn = d.returnTanks ? fbToArray(d.returnTanks) : [];
        
        // Check if this is our own echo (we wrote within last 3s and initials match)
        const timeSince = Date.now() - _lastLocalWriteTime;
        const myInitials = profileData.initials || '';
        const writerInitials = d._updatedBy || '';
        const isOwnEcho = (timeSince < 3000) && writerInitials !== '' && writerInitials === myInitials;
        
        console.log('[SYNC] Remote tanks: by=' + writerInitials + ' me=' + myInitials + ' timeSince=' + timeSince + 'ms echo=' + isOwnEcho);
        
        if (isOwnEcho) {
            console.log('[SYNC] Skipping own echo');
            return;
        }
        
        // Flash sync strip to show we received data
        setSyncStatus('syncing', 'Receiving from ' + (writerInitials || 'unknown') + '...');
        setTimeout(() => { setSyncStatus('online', 'Synced: ' + (profileData.wellName || '')); }, 1500);
        
        // Recalculate BBLs from inches to ensure consistency
        newPump.forEach(t => { if(t.inches > 0) t.bbls = inchesToBbl(t.inches); });
        newReturn.forEach(t => { if(t.inches > 0) t.bbls = inchesToBbl(t.inches); });
        
        data.pumpTanks = newPump;
        data.returnTanks = newReturn;
        if (d.jetsHour !== undefined) data.jetsHour = d.jetsHour;
        if (d.jetsShift !== undefined) data.jetsShift = d.jetsShift;
        if (d.lastSystemTotal !== undefined) data.lastSystemTotal = d.lastSystemTotal;
        if (d.lastCheckTime !== undefined) data.lastCheckTime = d.lastCheckTime;
        if (d.history) data.history = fbToArray(d.history);
        if (d.transferLog) data.transferLog = fbToArray(d.transferLog);
        // Save to localStorage as offline cache
        localStorage.setItem('ipsTrackerV3', JSON.stringify(data));
        render();
        renderTransferLog();
        renderVolumeLog();
        console.log('[SYNC] Render complete');
    } catch(err) {
        console.error('[SYNC] Error processing remote tanks:', err);
        setSyncStatus('offline', 'Sync Error: ' + err.message);
    }
}

function onRemoteTitData(snap) {
    if (!snap.exists()) return;
    titData = snap.val();
    localStorage.setItem('ipsTitrationV3', JSON.stringify(titData));
    try { loadTitrationUI(); } catch(e) {}
}

function onRemoteInjData(snap) {
    if (!snap.exists()) return;
    injData = snap.val();
    if (injData.history) injData.history = fbToArray(injData.history);
    localStorage.setItem('ipsInjV5', JSON.stringify(injData));
    try { loadInjUI(); renderInjHist(); } catch(e) {}
}

function onRemotePlugData(snap) {
    if (!snap.exists()) return;
    const d = snap.val();
    localStorage.setItem('ips_plug_data', JSON.stringify(d));
    PLUG_FIELDS.forEach(id => { const el = document.getElementById(id); if (el && d[id] !== undefined) el.value = d[id]; });
    try { updatePlugHeader(); } catch(e) {}
}

function onRemotePlugLog(snap) {
    const logs = snap.exists() ? fbToArray(snap.val()) : [];
    localStorage.setItem('ips_plug_log', JSON.stringify(logs));
    renderPlugLog();
}

function onRemoteTitrationLog(snap) {
    titrationLog = snap.exists() ? fbToArray(snap.val()) : [];
    localStorage.setItem('ipsTitrationLog', JSON.stringify(titrationLog));
    renderTitrationLog();
}

function onRemoteVolData(snap) {
    if (!snap.exists()) return;
    const d = snap.val();
    localStorage.setItem('ips_vol_data', JSON.stringify(d));
    try { loadVolData(); } catch(e) {}
}
// ========== END FIREBASE SYNC ==========

function loadData() {
    const s = localStorage.getItem('ipsTrackerV3'); 
    if (s) {
        try {
            data = JSON.parse(s);
            // Recalculate BBLs from inches to ensure consistency
            (data.pumpTanks||[]).forEach(t => { if(t.inches > 0) t.bbls = inchesToBbl(t.inches); });
            (data.returnTanks||[]).forEach(t => { if(t.inches > 0) t.bbls = inchesToBbl(t.inches); });
        } catch(e) {
            console.error('Failed to parse data:', e);
        }
    }
    const t = localStorage.getItem('ipsTitrationV3'); 
    if (t) {
        try {
            titData = JSON.parse(t);
        } catch(e) {
            console.error('Failed to parse titData:', e);
        }
    }
    try {
        loadTitrationUI();
    } catch(e) {
        console.error('Failed to loadTitrationUI:', e);
    }
}
let _fbSaveTimer = null;
function saveData() { 
    localStorage.setItem('ipsTrackerV3', JSON.stringify(data)); 
    // Debounce Firebase writes to avoid spamming on rapid input
    clearTimeout(_fbSaveTimer);
    _fbSaveTimer = setTimeout(() => { firebaseSaveTanks(); }, 500);
}
function saveTitrationData() {
    titData.fluidType = document.getElementById('fluid-type').value;
    titData.viscosity = document.getElementById('tit-viscosity').value;
    titData.density = document.getElementById('tit-density').value;
    titData.ph = document.getElementById('tit-ph').value;
    titData.pf = document.getElementById('tit-pf').value;
    titData.mf = document.getElementById('tit-mf').value;
    titData.snType = document.getElementById('tit-sn-type').value;
    titData.clPipette = document.getElementById('tit-cl-pipette').value;
    titData.hardPipette = document.getElementById('tit-hard-pipette').value;
    titData.caPipette = document.getElementById('tit-ca-pipette').value;
    titData.surfaceVol = document.getElementById('tit-surface-vol').value;
    titData.r600 = document.getElementById('tit-r600').value;
    titData.r300 = document.getElementById('tit-r300').value;
    titData.r200 = document.getElementById('tit-r200').value;
    titData.r100 = document.getElementById('tit-r100').value;
    titData.r6 = document.getElementById('tit-r6').value;
    titData.r3 = document.getElementById('tit-r3').value;
    titData.gel10s = document.getElementById('tit-gel10s').value;
    titData.gel10m = document.getElementById('tit-gel10m').value;
    localStorage.setItem('ipsTitrationV3', JSON.stringify(titData));
    firebaseSaveTitData();
}
function loadTitrationUI() {
    document.getElementById('fluid-type').value = titData.fluidType || 'aphron';
    document.getElementById('tit-viscosity').value = titData.viscosity || '';
    document.getElementById('tit-density').value = titData.density || '';
    document.getElementById('tit-ph').value = titData.ph || '';
    document.getElementById('tit-pf').value = titData.pf || '';
    document.getElementById('tit-mf').value = titData.mf || '';
    document.getElementById('tit-sn-type').value = titData.snType || 'fresh';
    document.getElementById('tit-cl-pipette').value = titData.clPipette || '';
    document.getElementById('tit-hard-pipette').value = titData.hardPipette || '';
    document.getElementById('tit-ca-pipette').value = titData.caPipette || '';
    document.getElementById('tit-surface-vol').value = titData.surfaceVol || '';
    document.getElementById('tit-r600').value = titData.r600 || '';
    document.getElementById('tit-r300').value = titData.r300 || '';
    document.getElementById('tit-r200').value = titData.r200 || '';
    document.getElementById('tit-r100').value = titData.r100 || '';
    document.getElementById('tit-r6').value = titData.r6 || '';
    document.getElementById('tit-r3').value = titData.r3 || '';
    document.getElementById('tit-gel10s').value = titData.gel10s || '';
    document.getElementById('tit-gel10m').value = titData.gel10m || '';
    calcChlorides(); calcHardness(); calcCalcium(); calcRheology();
}

function switchMasterTab(tab) {
    document.querySelectorAll('.master-tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase() === tab));
    document.querySelectorAll('.master-section').forEach(s => s.classList.remove('active'));
    document.getElementById(tab + '-section').classList.add('active');
    if (tab === 'wellbore') syncVolumesHeader();
    if (tab === 'timecard') { tcRenderLog(); tcInitDateListeners(); }
}
function tcInitDateListeners() {
    const sd = document.getElementById('tc-start-date');
    const ed = document.getElementById('tc-end-date');
    if (sd && !sd._tcListener) { sd.addEventListener('change', tcCalcEarnings); sd._tcListener = true; }
    if (ed && !ed._tcListener) { ed.addEventListener('change', tcCalcEarnings); ed._tcListener = true; }
}

// ========== TIMECARD SYSTEM ==========
let tcConfig = JSON.parse(localStorage.getItem('ipsTcConfig') || '{}');
let tcLog = JSON.parse(localStorage.getItem('ipsTcLog') || '[]');

function saveTimecardConfig() {
    tcConfig.operator = (document.getElementById('tc-operator')||{}).value || '';
    tcConfig.rig = (document.getElementById('tc-rig')||{}).value || '';
    tcConfig.county = (document.getElementById('tc-county')||{}).value || '';
    localStorage.setItem('ipsTcConfig', JSON.stringify(tcConfig));
}
function loadTimecardConfigUI() {
    const f = (id, key) => { const el = document.getElementById(id); if (el && tcConfig[key]) el.value = tcConfig[key]; };
    f('tc-operator','operator'); f('tc-rig','rig'); f('tc-county','county');
    tcUpdateTemplateStatus();
}
async function tcLoadExcelJSThenUpload() {
    if (typeof ExcelJS === 'undefined') {
        try {
            await new Promise((res, rej) => {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js';
                s.onload = res; s.onerror = rej;
                document.head.appendChild(s);
            });
        } catch(e) { alert('Failed to load library. Check your internet connection.'); return; }
    }
    document.getElementById('tc-template-upload').click();
}
function tcHandleTemplateUpload(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        const data = new Uint8Array(e.target.result);
        // Convert to base64 in chunks to avoid stack overflow
        var binStr = '';
        var chunkSize = 8192;
        for (var ci = 0; ci < data.length; ci += chunkSize) {
            var chunk = data.subarray(ci, Math.min(ci + chunkSize, data.length));
            binStr += String.fromCharCode.apply(null, chunk);
        }
        const b64 = btoa(binStr);
        try {
            localStorage.setItem('ipsTcTemplate', b64);
            tcConfig.templateName = file.name;
            // Extract rates from Rate Sheet using ExcelJS
            try {
                if (typeof ExcelJS !== 'undefined') {
                    const ewb = new ExcelJS.Workbook();
                    await ewb.xlsx.load(e.target.result);
                    const rs = ewb.getWorksheet('Rate Sheet');
                    if (rs) {
                        var v5 = rs.getCell('C5').value; tcConfig.extractedRegRate = (typeof v5 === 'object' && v5 !== null) ? parseFloat(v5.result || 0) : parseFloat(v5) || 0;
                        var v6 = rs.getCell('C6').value; tcConfig.extractedOtRate = (typeof v6 === 'object' && v6 !== null) ? parseFloat(v6.result || 0) : parseFloat(v6) || 0;
                        var v7 = rs.getCell('C7').value; tcConfig.extractedDayRate = (typeof v7 === 'object' && v7 !== null) ? parseFloat(v7.result || 0) : parseFloat(v7) || 0;
                        var v9 = rs.getCell('C9').value; tcConfig.extractedPerDiem = (typeof v9 === 'object' && v9 !== null) ? parseFloat(v9.result || 0) : parseFloat(v9) || 0;
                    }
                }
            } catch(ex) { console.log('Rate extraction skipped:', ex); }
            localStorage.setItem('ipsTcConfig', JSON.stringify(tcConfig));
            tcUpdateTemplateStatus();
            const toast = document.createElement('div');
            toast.textContent = '\u2705 Template uploaded: ' + file.name;
            toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#2e7d32;color:white;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:999';
            document.body.appendChild(toast);
            setTimeout(function(){ toast.remove(); }, 2500);
        } catch(err) {
            alert('Template too large for storage. Try a smaller file.');
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = '';
}
function tcClearTemplate() {
    if (!confirm('Remove uploaded template?')) return;
    localStorage.removeItem('ipsTcTemplate');
    delete tcConfig.templateName;
    localStorage.setItem('ipsTcConfig', JSON.stringify(tcConfig));
    tcUpdateTemplateStatus();
}
function tcUpdateTemplateStatus() {
    const el = document.getElementById('tc-template-status');
    const clearBtn = document.getElementById('tc-template-clear-btn');
    const hasTemplate = !!localStorage.getItem('ipsTcTemplate');
    if (el) {
        if (hasTemplate) {
            let rateInfo = '';
            if (tcConfig.extractedRegRate) {
                rateInfo = '<div style="font-size:11px;color:#888;margin-top:4px">$' + tcConfig.extractedRegRate + '/hr reg · $' + (tcConfig.extractedOtRate||0) + '/hr OT · $' + (tcConfig.extractedDayRate||0) + ' day · $' + (tcConfig.extractedPerDiem||0) + ' per diem</div>';
            }
            el.innerHTML = '<span style="color:#66bb6a;font-weight:600">\u2705 ' + (tcConfig.templateName || 'Template loaded') + '</span>' + rateInfo;
        } else {
            el.innerHTML = '<span style="color:#888">No template uploaded</span>';
        }
    }
    if (clearBtn) clearBtn.style.display = hasTemplate ? 'flex' : 'none';
}
function tcLogDay(type) {
    const today = new Date().toISOString().split('T')[0];
    const existing = tcLog.findIndex(e => e.date === today);
    const well = profileData.wellName || '';
    const county = ''; // user can edit later
    const entry = {
        date: today,
        well: well,
        operator: tcConfig.operator || '',
        rig: tcConfig.rig || '',
        county: tcConfig.county || '',
        worked: type === 'full' ? 12 : 0,
        standby: 12,
        notWorking: 0
    };
    if (existing >= 0) tcLog[existing] = entry; else tcLog.push(entry);
    tcLog.sort((a,b) => a.date.localeCompare(b.date));
    localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
    tcRenderLog();
    tcUpdateTodayStatus();
    const label = type === 'full' ? '12W / 12S' : '0W / 12S';
    const toast = document.createElement('div');
    toast.textContent = '✅ Logged ' + label + ' — ' + (well || 'no well');
    toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#2e7d32;color:white;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:999;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}
function tcLogDayCustom() {
    const today = new Date().toISOString().split('T')[0];
    const existing = tcLog.find(e => e.date === today);
    const w = prompt('Hours Worked:', existing ? existing.worked : '12');
    if (w === null) return;
    const s = prompt('Hours Standby:', existing ? existing.standby : '12');
    if (s === null) return;
    const entry = {
        date: today, well: profileData.wellName || '', operator: tcConfig.operator || '',
        rig: tcConfig.rig || '', county: tcConfig.county || '', worked: parseFloat(w) || 0, standby: parseFloat(s) || 0, notWorking: 0
    };
    const idx = tcLog.findIndex(e => e.date === today);
    if (idx >= 0) tcLog[idx] = entry; else tcLog.push(entry);
    tcLog.sort((a,b) => a.date.localeCompare(b.date));
    localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
    tcRenderLog(); tcUpdateTodayStatus();
}
function tcAddPastDay() {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:300;display:flex;align-items:center;justify-content:center';
    const card = document.createElement('div');
    card.style.cssText = 'background:#1b2838;border:1px solid #2d4a6f;border-radius:12px;padding:20px;width:90%;max-width:340px';
    card.innerHTML = '<div style="font-size:15px;font-weight:700;color:#4fc3f7;margin-bottom:14px;text-align:center">Add Past Day</div>' +
        '<label style="font-size:12px;color:#888;display:block;margin-bottom:4px">Date</label>' +
        '<input type="date" id="tc-past-date" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:16px;margin-bottom:10px;box-sizing:border-box">' +
        '<label style="font-size:12px;color:#888;display:block;margin-bottom:4px">Well Name</label>' +
        '<input type="text" id="tc-past-well" value="' + (profileData.wellName || '').replace(/"/g,'&quot;') + '" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:14px;margin-bottom:10px;box-sizing:border-box">' +
        '<div style="display:flex;gap:8px;margin-bottom:10px">' +
        '<div style="flex:1"><label style="font-size:12px;color:#888;display:block;margin-bottom:4px">Operator</label><input type="text" id="tc-past-oper" value="' + (tcConfig.operator || '').replace(/"/g,'&quot;') + '" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:14px;box-sizing:border-box"></div>' +
        '<div style="flex:1"><label style="font-size:12px;color:#888;display:block;margin-bottom:4px">County</label><input type="text" id="tc-past-county" value="' + (tcConfig.county || '').replace(/"/g,'&quot;') + '" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:14px;box-sizing:border-box"></div>' +
        '</div>' +
        '<div style="display:flex;gap:8px;margin-bottom:10px">' +
        '<div style="flex:1"><label style="font-size:12px;color:#888;display:block;margin-bottom:4px">Hours Worked</label><input type="number" id="tc-past-worked" value="12" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:16px;box-sizing:border-box"></div>' +
        '<div style="flex:1"><label style="font-size:12px;color:#888;display:block;margin-bottom:4px">Hours Standby</label><input type="number" id="tc-past-standby" value="12" style="width:100%;padding:10px;border:1px solid #2d4a6f;border-radius:6px;background:#0d1b2a;color:#e0e0e0;font-size:16px;box-sizing:border-box"></div>' +
        '</div>' +
        '<div style="display:flex;gap:8px;margin-top:14px">' +
        '<button id="tc-past-cancel" style="flex:1;padding:12px;border:1px solid #2d4a6f;border-radius:6px;background:transparent;color:#888;font-size:14px;font-weight:600;cursor:pointer">Cancel</button>' +
        '<button id="tc-past-save" style="flex:1;padding:12px;border:none;border-radius:6px;background:#2e7d32;color:white;font-size:14px;font-weight:600;cursor:pointer">Save</button>' +
        '</div>';
    overlay.appendChild(card);
    document.body.appendChild(overlay);
    overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
    card.querySelector('#tc-past-cancel').onclick = function() { overlay.remove(); };
    card.querySelector('#tc-past-save').onclick = function() {
        const date = document.getElementById('tc-past-date').value;
        if (!date) { alert('Please select a date'); return; }
        const well = document.getElementById('tc-past-well').value.trim();
        const worked = parseFloat(document.getElementById('tc-past-worked').value) || 0;
        const standby = parseFloat(document.getElementById('tc-past-standby').value) || 0;
        const entry = { date: date, well: well, operator: document.getElementById('tc-past-oper').value.trim() || tcConfig.operator || '', rig: tcConfig.rig || '', county: document.getElementById('tc-past-county').value.trim() || tcConfig.county || '', worked: worked, standby: standby, notWorking: 0 };
        const idx = tcLog.findIndex(e => e.date === date);
        if (idx >= 0) { if (!confirm('Entry for ' + date + ' already exists. Overwrite?')) return; tcLog[idx] = entry; }
        else tcLog.push(entry);
        tcLog.sort((a,b) => a.date.localeCompare(b.date));
        localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
        overlay.remove();
        tcRenderLog(); tcUpdateTodayStatus();
        const toast = document.createElement('div');
        toast.textContent = '\u2705 Added ' + date + ' \u2014 ' + worked + 'W/' + standby + 'S';
        toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#2e7d32;color:white;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:999';
        document.body.appendChild(toast);
        setTimeout(function(){ toast.remove(); }, 2000);
    };
}
function tcUpdateTodayStatus() {
    const today = new Date().toISOString().split('T')[0];
    const entry = tcLog.find(e => e.date === today);
    const label = document.getElementById('tc-today-label');
    if (!label) return;
    if (entry) {
        label.textContent = entry.worked + 'W / ' + entry.standby + 'S — ' + (entry.well || 'no well');
        label.style.color = '#66bb6a';
    } else {
        label.textContent = 'Not logged yet';
        label.style.color = '#888';
    }
}
let tcEditMode = false;
function tcToggleEditMode() {
    tcEditMode = !tcEditMode;
    const btn = document.getElementById('tc-edit-toggle-btn');
    if (btn) {
        btn.textContent = tcEditMode ? 'Done' : 'Edit';
        btn.style.color = tcEditMode ? '#ef5350' : '#888';
    }
    tcRenderLog();
}
function tcRenderLog() {
    const el = document.getElementById('tc-work-log');
    if (!el) return;
    tcUpdateTodayStatus();
    tcUpdateDefaultsBadge();
    if (!tcLog.length) { el.innerHTML = '<div style="font-size:12px;color:#666;text-align:center;padding:20px">No days logged yet</div>'; tcCalcEarnings(); return; }
    const sorted = [...tcLog].sort((a,b) => b.date.localeCompare(a.date));
    el.innerHTML = sorted.slice(0, 30).map((e, i) => {
        const d = new Date(e.date + 'T12:00:00');
        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const rigStr = e.rig || tcConfig.rig || '';
        let actions = '';
        if (tcEditMode) {
            actions = '<div class="tc-actions">' +
                '<button class="tc-action-btn" onclick="tcEditDay(\'' + e.date + '\')">✏️</button>' +
                '<button class="tc-action-btn" style="border-color:#c62828" onclick="tcDeleteDay(\'' + e.date + '\')">🗑️</button>' +
                '</div>';
        }
        return '<div class="tc-day-card">' +
            '<div class="tc-date">' + dayName + ' ' + dateStr + '</div>' +
            '<div class="tc-well" style="display:flex;flex-direction:column;gap:1px">' +
                '<span>' + (e.well || '--') + '</span>' +
                (rigStr ? '<span style="font-size:9px;color:#78909c">' + rigStr + '</span>' : '') +
            '</div>' +
            '<div class="tc-hours">' + e.worked + 'W/' + e.standby + 'S</div>' +
            actions + '</div>';
    }).join('');
    if (tcEditMode) {
        el.innerHTML += '<button style="width:100%;padding:10px;border:1px solid #c62828;border-radius:6px;background:transparent;color:#ef5350;font-size:12px;font-weight:600;cursor:pointer;margin-top:8px" onclick="tcClearLog()">Clear All Entries</button>';
    }
    tcCalcEarnings();
}
function tcUpdateDefaultsBadge() {
    const badge = document.getElementById('tc-defaults-badge');
    if (!badge) return;
    const parts = [tcConfig.operator, tcConfig.rig, tcConfig.county].filter(Boolean);
    badge.textContent = parts.length ? '— ' + parts.join(' · ') : '';
}
function tcCalcEarnings() {
    let container = document.getElementById('tc-earnings-display');
    if (!container) {
        // Insert earnings display before the preview button
        const previewBtn = document.querySelector('#timecard-section .tc-log-btn[style*="1565c0"]');
        if (previewBtn) {
            container = document.createElement('div');
            container.id = 'tc-earnings-display';
            previewBtn.parentNode.insertBefore(container, previewBtn);
        } else return;
    }
    const startVal = document.getElementById('tc-start-date').value;
    const endVal = document.getElementById('tc-end-date').value;
    if (!startVal || !endVal || !tcConfig.extractedRegRate) { container.innerHTML = ''; return; }
    const entries = tcLog.filter(e => e.date >= startVal && e.date <= endVal);
    if (!entries.length) { container.innerHTML = ''; return; }
    const regRate = tcConfig.extractedRegRate || 0;
    const otRate = tcConfig.extractedOtRate || 0;
    const dayRate = tcConfig.extractedDayRate || 0;
    const perDiem = tcConfig.extractedPerDiem || 0;
    // Group by week
    const weeks = {};
    entries.forEach(e => {
        const wk = tcGetWeekNum(e.date, startVal);
        if (wk >= 1 && wk <= 4) { if (!weeks[wk]) weeks[wk] = []; weeks[wk].push(e); }
    });
    let grandTotal = 0;
    let html = '';
    Object.keys(weeks).sort().forEach(wk => {
        const wEntries = weeks[wk];
        let weekHrs = 0;
        let weekPerDiem = 0;
        wEntries.forEach(e => {
            weekHrs += (e.worked || 0) + (e.standby || 0);
            if ((e.worked || 0) + (e.standby || 0) > 0) weekPerDiem += perDiem;
        });
        const regHrs = Math.min(weekHrs, 40);
        const otHrs = Math.max(weekHrs - 40, 0);
        const regPay = regRate * regHrs;
        const otPay = otRate * otHrs;
        const billableDays = wEntries.reduce((s, e) => { const t = (e.worked||0) + (e.standby||0); return s + (t >= 24 ? 1 : t >= 12 ? 0.5 : 0); }, 0);
        const maxBonus = dayRate * billableDays;
        const perfBonus = Math.max(maxBonus - regPay - otPay, 0);
        const weekTotal = regPay + otPay + perfBonus + weekPerDiem;
        grandTotal += weekTotal;
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px">' +
            '<span style="color:#888">Wk' + wk + ': ' + wEntries.length + 'd · ' + weekHrs + 'h</span>' +
            '<span style="color:#66bb6a;font-weight:600">$' + weekTotal.toFixed(2) + '</span></div>';
    });
    container.innerHTML = '<div style="padding:12px;background:#0a2a4a;border-radius:8px;margin-bottom:12px;border:1px solid #2d4a6f">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">' +
        '<span style="font-size:11px;color:#888;text-transform:uppercase">Estimated Earnings</span>' +
        '<span style="font-size:18px;font-weight:700;color:#66bb6a">$' + grandTotal.toFixed(2) + '</span></div>' +
        html + '</div>';
}
function tcEditDay(date) {
    const entry = tcLog.find(e => e.date === date);
    if (!entry) return;
    const w = prompt('Hours Worked:', entry.worked);
    if (w === null) return;
    const s = prompt('Hours Standby:', entry.standby);
    if (s === null) return;
    const well = prompt('Well Name:', entry.well);
    if (well === null) return;
    entry.worked = parseFloat(w) || 0;
    entry.standby = parseFloat(s) || 0;
    entry.well = well;
    localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
    tcRenderLog();
}
function tcDeleteDay(date) {
    if (!confirm('Delete entry for ' + date + '?')) return;
    tcLog = tcLog.filter(e => e.date !== date);
    localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
    tcRenderLog();
}
function tcClearLog() {
    if (!confirm('Clear all timecard entries?')) return;
    tcLog = [];
    localStorage.setItem('ipsTcLog', JSON.stringify(tcLog));
    tcRenderLog();
}
function tcGetWeekNum(dateStr, startDate) {
    const d = new Date(dateStr + 'T12:00:00');
    const s = new Date(startDate + 'T12:00:00');
    const diff = Math.floor((d - s) / (1000 * 60 * 60 * 24));
    return Math.floor(diff / 7) + 1;
}
function tcPreviewTimecard() {
    const startEl = document.getElementById('tc-start-date');
    const endEl = document.getElementById('tc-end-date');
    if (!startEl.value || !endEl.value) { alert('Please select start and end dates'); return; }
    const entries = tcLog.filter(e => e.date >= startEl.value && e.date <= endEl.value);
    if (!entries.length) { alert('No entries in selected date range'); return; }
    // Group by week
    const weeks = {};
    entries.forEach(e => {
        const wk = tcGetWeekNum(e.date, startEl.value);
        if (!weeks[wk]) weeks[wk] = [];
        weeks[wk].push(e);
    });
    const regRate = tcConfig.regRate || 0;
    const otRate = tcConfig.otRate || 0;
    const dayRate = tcConfig.dayRate || 0;
    const perDiem = tcConfig.perDiem || 0;
    let html = '<div style="margin-bottom:12px">';
    html += '<div style="font-size:11px;color:#888;margin-bottom:2px">CONTRACTOR</div>';
    html += '<div style="font-size:14px;font-weight:600;color:#e0e0e0">' + (profileData.name || '--') + '</div>';
    html += '<div style="font-size:11px;color:#888">' + (profileData.wellName || '--') + ' &nbsp;|&nbsp; ' + (tcConfig.operator || '--') + ' &nbsp;|&nbsp; ' + (tcConfig.rig || '--') + '</div>';
    html += '</div>';
    let grandTotalPay = 0;
    Object.keys(weeks).sort((a,b) => a-b).forEach(wk => {
        const wEntries = weeks[wk];
        let weekWorked = 0, weekStandby = 0;
        html += '<div style="font-size:12px;font-weight:700;color:#ffa726;margin:12px 0 6px;text-transform:uppercase">Week ' + wk + '</div>';
        html += '<table class="tc-preview-table"><tr><th>Date</th><th>Day</th><th>Well</th><th>W</th><th>S</th><th>Tot</th><th>Per Diem</th></tr>';
        wEntries.forEach(e => {
            const d = new Date(e.date + 'T12:00:00');
            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
            const dateStr = (d.getMonth()+1) + '/' + d.getDate();
            const total = e.worked + e.standby;
            weekWorked += e.worked;
            weekStandby += e.standby;
            const pd = total > 0 ? perDiem : 0;
            html += '<tr><td>' + dateStr + '</td><td>' + dayName + '</td><td style="color:#ffa726;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (e.well || '--') + '</td><td>' + e.worked + '</td><td>' + e.standby + '</td><td style="color:#4fc3f7">' + total + '</td><td>$' + pd + '</td></tr>';
        });
        const weekTotal = weekWorked + weekStandby;
        const regHrs = Math.min(weekTotal, 40);
        const otHrs = Math.max(weekTotal - 40, 0);
        const regPay = regRate * regHrs;
        const otPay = otRate * otHrs;
        const billableDays = wEntries.reduce((sum, e) => { const t = e.worked + e.standby; return sum + (t >= 24 ? 1 : t >= 12 ? 0.5 : 0); }, 0);
        const maxBonus = dayRate * billableDays;
        const perfBonus = Math.max(maxBonus - regPay - otPay, 0);
        const weekPay = regPay + otPay + perfBonus;
        const weekPerDiem = wEntries.reduce((sum, e) => sum + ((e.worked + e.standby) > 0 ? perDiem : 0), 0);
        grandTotalPay += weekPay + weekPerDiem;
        html += '<tr class="tc-totals"><td colspan="3">Totals</td><td>' + weekWorked + '</td><td>' + weekStandby + '</td><td>' + weekTotal + '</td><td>$' + weekPerDiem + '</td></tr>';
        html += '</table>';
        html += '<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">';
        html += '<div style="background:#1b2838;border:1px solid #2d4a6f;border-radius:4px;padding:4px 8px;font-size:10px"><span style="color:#888">Reg:</span> <span style="color:#66bb6a">' + regHrs + 'h × $' + regRate + ' = $' + regPay.toFixed(2) + '</span></div>';
        if (otHrs > 0) html += '<div style="background:#1b2838;border:1px solid #2d4a6f;border-radius:4px;padding:4px 8px;font-size:10px"><span style="color:#888">OT:</span> <span style="color:#ffa726">' + otHrs + 'h × $' + otRate + ' = $' + otPay.toFixed(2) + '</span></div>';
        if (perfBonus > 0) html += '<div style="background:#1b2838;border:1px solid #2d4a6f;border-radius:4px;padding:4px 8px;font-size:10px"><span style="color:#888">Bonus:</span> <span style="color:#ab47bc">$' + perfBonus.toFixed(2) + '</span></div>';
        html += '</div>';
    });
    html += '<div style="margin-top:16px;padding:12px;background:#0a2a4a;border-radius:8px;text-align:center">';
    html += '<div style="font-size:11px;color:#888;text-transform:uppercase">Estimated Total</div>';
    html += '<div style="font-size:24px;font-weight:700;color:#66bb6a">$' + grandTotalPay.toFixed(2) + '</div>';
    html += '</div>';
    document.getElementById('tc-preview-body').innerHTML = html;
    document.getElementById('tc-preview-overlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}
function tcApproveAndShare() {
    tcGenerateXLSX().then(blob => {
        if (!blob) return;
        const startDate = document.getElementById('tc-start-date').value;
        const endDate = document.getElementById('tc-end-date').value;
        const fileName = (profileData.name || 'Timecard').replace(/\s+/g, '_') + '_' + startDate + '_to_' + endDate + '.xlsx';
        // Always download first
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
        // Close preview
        document.getElementById('tc-preview-overlay').classList.remove('show');
        document.body.style.overflow = '';
        // Try native share after a short delay
        setTimeout(() => {
            try {
                const file = new File([blob], fileName, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({ title: 'Timecard - ' + (profileData.name || ''), files: [file] }).catch(() => {});
                }
            } catch(e) {}
        }, 500);
        // Toast
        const toast = document.createElement('div');
        toast.innerHTML = '📄 <b>' + fileName + '</b> downloaded.<br><span style="font-size:11px;color:#aaa">Check your Downloads folder to email it.</span>';
        toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1b2838;border:1px solid #4fc3f7;color:white;padding:14px 20px;border-radius:10px;font-size:13px;z-index:999;max-width:90%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    });
}
function tcEmailTimecard() {
    // Download first, then open email
    tcGenerateXLSX().then(blob => {
        if (!blob) return;
        const startDate = document.getElementById('tc-start-date').value;
        const endDate = document.getElementById('tc-end-date').value;
        const fileName = (profileData.name || 'Timecard').replace(/\s+/g, '_') + '_' + startDate + '_to_' + endDate + '.xlsx';
        // Download the file
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
        // Open mailto
        const to = tcConfig.submitEmail || '';
        const subject = encodeURIComponent('Timecard - ' + (profileData.name || '') + ' - ' + startDate + ' to ' + endDate);
        const body = encodeURIComponent('Please find my timecard attached for the period ' + startDate + ' to ' + endDate + '.\n\nFile: ' + fileName + '\n\n(Please attach the downloaded file from your Downloads folder)');
        window.location.href = 'mailto:' + to + '?subject=' + subject + '&body=' + body;
        // Close preview
        document.getElementById('tc-preview-overlay').classList.remove('show');
        document.body.style.overflow = '';
    });
}
async function tcGenerateXLSX() {
    // Load ExcelJS if not loaded
    if (typeof ExcelJS === 'undefined') {
        try {
            await new Promise((res, rej) => {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js';
                s.onload = res; s.onerror = rej;
                document.head.appendChild(s);
            });
        } catch(e) { alert('Failed to load spreadsheet library'); return null; }
    }
    // Load template from localStorage
    const templateB64 = localStorage.getItem('ipsTcTemplate');
    if (!templateB64) { alert('No timesheet template uploaded. Go to Settings → Timecard to upload your AES template.'); return null; }
    const startDate = document.getElementById('tc-start-date').value;
    const endDate = document.getElementById('tc-end-date').value;
    const entries = tcLog.filter(e => e.date >= startDate && e.date <= endDate);
    if (!entries.length) { alert('No entries in selected date range.'); return null; }
    // Decode base64 template to ArrayBuffer
    const raw = atob(templateB64);
    const buf = new ArrayBuffer(raw.length);
    const view = new Uint8Array(buf);
    for (let i = 0; i < raw.length; i++) view[i] = raw.charCodeAt(i);
    // Load workbook with ExcelJS
    const wb = new ExcelJS.Workbook();
    await wb.xlsx.load(buf);
    const ws = wb.getWorksheet('Job Sheet');
    if (!ws) { alert('Template missing "Job Sheet" tab.'); return null; }
    // Fill contractor info
    ws.getCell('C4').value = profileData.name || '';
    // Pay period dates
    ws.getCell('N6').value = new Date(startDate + 'T12:00:00');
    ws.getCell('N7').value = new Date(endDate + 'T12:00:00');
    // Week data row mapping: week# -> [startRow, endRow] (7 rows each)
    var weekRows = { 1: [22,28], 2: [36,42], 3: [50,56], 4: [64,70] };
    // Group entries by week
    var weeks = {};
    entries.forEach(function(e) {
        var wk = tcGetWeekNum(e.date, startDate);
        if (wk >= 1 && wk <= 4) {
            if (!weeks[wk]) weeks[wk] = [];
            weeks[wk].push(e);
        }
    });
    // Fill each week's data rows
    for (var w = 1; w <= 4; w++) {
        var wEntries = weeks[w] || [];
        var rowStart = weekRows[w][0];
        var rowEnd = weekRows[w][1];
        // Clear all 7 data rows first (preserve formulas in C, L, O, P, Q, T)
        for (var r = rowStart; r <= rowEnd; r++) {
            ws.getCell('B' + r).value = null;  // date
            ws.getCell('D' + r).value = null;  // operator
            ws.getCell('E' + r).value = null;  // well
            ws.getCell('F' + r).value = null;  // rig
            ws.getCell('G' + r).value = null;  // job #
            ws.getCell('H' + r).value = null;  // county
            ws.getCell('I' + r).value = null;  // hours worked
            ws.getCell('J' + r).value = null;  // hours standby
            ws.getCell('K' + r).value = null;  // hours not working
            // C (day name formula), L (total formula), O/P/Q/T (calc formulas) left alone
        }
        // Fill entries into rows
        for (var i = 0; i < wEntries.length && i < 7; i++) {
            var e = wEntries[i];
            var row = rowStart + i;
            ws.getCell('B' + row).value = new Date(e.date + 'T12:00:00');
            ws.getCell('D' + row).value = e.operator || tcConfig.operator || '';
            ws.getCell('E' + row).value = e.well || '';
            ws.getCell('F' + row).value = e.rig || tcConfig.rig || '';
            ws.getCell('H' + row).value = e.county || tcConfig.county || '';
            ws.getCell('I' + row).value = e.worked || 0;
            ws.getCell('J' + row).value = e.standby || 0;
            ws.getCell('K' + row).value = e.notWorking || 0;
        }
    }
    // Write to buffer
    var outBuf = await wb.xlsx.writeBuffer();
    return new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
}

function switchWBTab(tab) {
    const tabs = ['plugs','volumes','swivel'];
    document.querySelectorAll('.wb-tab').forEach((t,i) => t.classList.toggle('active', tabs[i]===tab));
    tabs.forEach(id => { const el=document.getElementById('wb-'+id); if(el) el.classList.toggle('active', id===tab); });
    if (tab === 'volumes') { syncVolumesHeader(); calcVolumes(); }
}

// ========== PLUG TRACKING ==========
const PLUG_FIELDS = ['plug-num','plug-total','plug-jnt','plug-jnt-out','plug-depth','plug-time',
    'plug-drill-time','plug-wash-time','plug-eta','plug-rih-wt','plug-neutral-wt','plug-pu-wt',
    'plug-torque-off','plug-torque-on','plug-rpm','plug-wob','plug-circ','plug-pr','plug-mp','plug-rr',
    'plug-choke','plug-mw-in','plug-mw-out','plug-mv-in','plug-mv-out','plug-cl-in','plug-cl-out',
    'plug-marker-sent','plug-surface-time','plug-sand','plug-gas','plug-int','plug-stalls','plug-fr','plug-pop','plug-comments'];

function updatePlugHeader() {
    const jnt = document.getElementById('plug-jnt').value || '--';
    const num = document.getElementById('plug-num').value || '--';
    const total = document.getElementById('plug-total').value || '--';
    const depth = document.getElementById('plug-depth').value;
    document.getElementById('plug-hdr-jnt').textContent = jnt;
    document.getElementById('plug-hdr-plug').innerHTML = num + ' <span class="plug-total">/ ' + total + '</span>';
    document.getElementById('plug-hdr-depth').textContent = depth ? Number(depth).toLocaleString() + "'" : "--'";
    syncVolumesHeader();
}

function savePlugData() {
    const data = {};
    PLUG_FIELDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) data[id] = el.value;
    });
    localStorage.setItem('ips_plug_data', JSON.stringify(data));
    firebaseSavePlugData();
}

function loadPlugData() {
    const saved = localStorage.getItem('ips_plug_data');
    if (!saved) return;
    try {
        const data = JSON.parse(saved);
        PLUG_FIELDS.forEach(id => {
            const el = document.getElementById(id);
            if (el && data[id] !== undefined) el.value = data[id];
        });
        updatePlugHeader();
    } catch(e) {}
}

function getPlugFormData() {
    const d = {};
    PLUG_FIELDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) d[id] = el.value;
    });
    return d;
}

function _savePlugLog(logs) {
    localStorage.setItem('ips_plug_log', JSON.stringify(logs));
    firebaseSavePlugLog();
}

function logPlug() {
    const d = getPlugFormData();
    if (!d['plug-num']) { alert('Enter a plug number first'); return; }
    const logs = JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    d._timestamp = new Date().toISOString();
    logs.push(d);
    _savePlugLog(logs);
    renderPlugLog();

    // Auto-increment plug number and clear per-plug fields
    const nextPlug = parseInt(d['plug-num']) + 1;
    document.getElementById('plug-num').value = nextPlug;
    ['plug-time','plug-drill-time','plug-wash-time','plug-eta','plug-torque-off','plug-torque-on',
     'plug-marker-sent','plug-surface-time','plug-sand','plug-gas','plug-int','plug-stalls',
     'plug-fr','plug-pop','plug-comments'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    updatePlugHeader();
    savePlugData();
}

function renderPlugLog() {
    const logs = JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    const container = document.getElementById('plug-log-content');
    const countEl = document.getElementById('plug-log-count');
    if (logs.length === 0) {
        container.innerHTML = '<em style="color:#666">No plugs logged</em>';
        countEl.textContent = '';
        return;
    }
    countEl.textContent = logs.length + ' plugs';
    let html = '';
    for (let i = logs.length - 1; i >= 0; i--) {
        const p = logs[i];
        const t = p._timestamp ? new Date(p._timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
        html += '<div style="background:#243447;border-radius:6px;padding:10px;margin-bottom:6px;border-left:3px solid #4fc3f7;position:relative">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
        html += '<span style="font-weight:700;color:#4fc3f7;font-size:14px">Plug ' + (p['plug-num']||'?') + '/' + (p['plug-total']||'?') + '</span>';
        html += '<span style="font-size:10px;color:#888">' + t + '</span>';
        html += '<button onclick="deletePlugLog(' + i + ')" style="background:none;border:none;color:#ef5350;font-size:14px;cursor:pointer;padding:0 4px">✕</button>';
        html += '</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:#aaa">';
        if (p['plug-depth']) html += '<span>Depth: ' + Number(p['plug-depth']).toLocaleString() + "'</span>";
        if (p['plug-jnt']) html += '<span>JNT: ' + p['plug-jnt'] + (p['plug-jnt-out'] ? '/' + p['plug-jnt-out'] + ' out' : '') + '</span>';
        if (p['plug-drill-time']) html += '<span>Drill: ' + p['plug-drill-time'] + ' min</span>';
        if (p['plug-wash-time']) html += '<span>Wash: ' + p['plug-wash-time'] + ' min</span>';
        if (p['plug-rih-wt']) html += '<span>RIH: ' + p['plug-rih-wt'] + 'k</span>';
        if (p['plug-pu-wt']) html += '<span>P/U: ' + p['plug-pu-wt'] + 'k</span>';
        if (p['plug-circ']) html += '<span>CIRC: ' + p['plug-circ'] + '</span>';
        html += '</div></div>';
    }
    container.innerHTML = html;
}

function deletePlugLog(idx) {
    const logs = JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    logs.splice(idx, 1);
    _savePlugLog(logs);
    renderPlugLog();
}

function resetPlugLog() {
    if (!confirm('Clear all logged plugs?')) return;
    localStorage.removeItem('ips_plug_log');
    firebaseSavePlugLog();
    renderPlugLog();
}

// ========== UNIVERSAL LOG EDIT SYSTEM ==========
let _logEditType = null;

function openLogEdit(type) {
    _logEditType = type;
    const modal = document.getElementById('log-edit-modal');
    const title = document.getElementById('log-edit-title');
    const body = document.getElementById('log-edit-body');
    const clearBtn = document.getElementById('log-edit-clear-btn');

    const titles = {volume:'Volume Log',transfer:'Transfer Log',injection:'Injection Log',titration:'Titration Log',plug:'Plug Log'};
    title.textContent = titles[type] || 'Edit Log';
    clearBtn.onclick = function() { logEditClearAll(); };
    modal.classList.add('show');
    renderLogEditEntries(type);
}

function hideLogEditModal() {
    document.getElementById('log-edit-modal').classList.remove('show');
    _logEditType = null;
}

function logEditClearAll() {
    if (!confirm('Clear ALL entries from this log?')) return;
    if (_logEditType === 'volume') { data.history = []; data.lastCheckTime = null; data.lastSystemTotal = null; saveData(); render(); renderVolumeLog(); }
    else if (_logEditType === 'transfer') { data.transferLog = []; saveData(); renderTransferLog(); }
    else if (_logEditType === 'injection') { injData.history = []; saveInjData(); renderInjHist(); }
    else if (_logEditType === 'titration') { titrationLog = []; saveTitrationLog(); renderTitrationLog(); }
    else if (_logEditType === 'plug') { localStorage.removeItem('ips_plug_log'); firebaseSavePlugLog(); renderPlugLog(); }
    hideLogEditModal();
}

function getLogEntries(type) {
    if (type === 'volume') return data.history || [];
    if (type === 'transfer') return data.transferLog || [];
    if (type === 'injection') return (injData.history || []);
    if (type === 'titration') return titrationLog || [];
    if (type === 'plug') return JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    return [];
}

function saveLogEntries(type, entries) {
    if (type === 'volume') { data.history = entries; saveData(); renderVolumeLog(); render(); }
    else if (type === 'transfer') { data.transferLog = entries; saveData(); renderTransferLog(); }
    else if (type === 'injection') { injData.history = entries; saveInjData(); renderInjHist(); }
    else if (type === 'titration') { titrationLog = entries; saveTitrationLog(); renderTitrationLog(); }
    else if (type === 'plug') { _savePlugLog(entries); renderPlugLog(); }
}

function getEntryTitle(type, entry, idx) {
    const t = entry.time || entry._timestamp;
    const timeStr = t ? new Date(t).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : '';
    const dateStr = t ? new Date(t).toLocaleDateString([], {month:'short',day:'numeric'}) : '';
    const ini = entry.initials ? entry.initials + ' — ' : '';

    if (type === 'volume') {
        const ft = entry.filterType;
        const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
        const label = ft ? fluidNames[ft] || ft : 'System';
        return {title: ini + label + ': ' + entry.systemTotal + ' BBL', sub: dateStr + ' ' + timeStr};
    }
    if (type === 'transfer') {
        const tLabel = entry.type === 'out' ? 'OUT' : entry.type === 'in' ? 'IN' : 'BUILD';
        return {title: ini + tLabel + ' ' + entry.volume + ' BBL', sub: dateStr + ' ' + timeStr + ' — ' + (entry.tanks||[]).join(', ')};
    }
    if (type === 'injection') {
        if (entry.type === 'pump') return {title: 'Pump: ' + entry.from + ' → ' + entry.to + ' BPM', sub: dateStr + ' ' + timeStr};
        return {title: (entry.type==='fr'?'FR':'Lube') + ': ' + entry.treat + '/10bbl', sub: dateStr + ' ' + timeStr + ' @ ' + entry.pumpRate + ' BPM'};
    }
    if (type === 'titration') {
        return {title: ini + (entry.fluidName||'--') + ' — ' + (entry.density||'--') + '#', sub: dateStr + ' ' + timeStr + (entry.sampleLocation === 'out' ? ' OUT' : ' IN')};
    }
    if (type === 'plug') {
        return {title: 'Plug ' + (entry['plug-num']||'?') + '/' + (entry['plug-total']||'?'), sub: dateStr + ' ' + timeStr + (entry['plug-depth'] ? ' — ' + Number(entry['plug-depth']).toLocaleString() + "\'" : '')};
    }
    return {title:'Entry ' + idx, sub:''};
}

function getEditableFields(type, entry) {
    if (type === 'volume') {
        return [
            {key:'initials',label:'Initials',type:'text'},
            {key:'filterType',label:'Fluid Type',type:'select',options:[{v:'',l:'System'},{v:'brine',l:'Brine'},{v:'packer',l:'Packer'},{v:'mud',l:'Mud'},{v:'recirc',l:'Recirc'},{v:'freshwater',l:'Freshwater'},{v:'other',l:'Other'}]},
            {key:'systemTotal',label:'System Total',type:'number'},
            {key:'apparentChange',label:'Apparent',type:'number'},
            {key:'trueChange',label:'Actual G/L',type:'number'},
            {key:'ratePerHour',label:'Hourly Rate',type:'text'},
            {key:'elapsedMin',label:'Elapsed Min',type:'number'}
        ];
    }
    if (type === 'transfer') {
        return [
            {key:'initials',label:'Initials',type:'text'},
            {key:'type',label:'Type',type:'select',options:[{v:'out',l:'Out'},{v:'in',l:'In'},{v:'build',l:'Build'}]},
            {key:'fluidType',label:'Fluid Type',type:'select',options:[{v:'',l:'--'},{v:'brine',l:'Brine'},{v:'packer',l:'Packer'},{v:'mud',l:'Mud'},{v:'recirc',l:'Recirc'},{v:'freshwater',l:'Freshwater'},{v:'other',l:'Other'}]},
            {key:'volume',label:'Volume (BBL)',type:'number'},
            {key:'tanks',label:'Tanks',type:'text',isArray:true}
        ];
    }
    if (type === 'injection') {
        if (entry.type === 'pump') {
            return [
                {key:'from',label:'From (BPM)',type:'text'},
                {key:'to',label:'To (BPM)',type:'text'}
            ];
        }
        return [
            {key:'type',label:'Type',type:'select',options:[{v:'fr',l:'FR'},{v:'lube',l:'Lube'}]},
            {key:'treat',label:'Treatment',type:'text'},
            {key:'pumpRate',label:'Pump Rate',type:'text'},
            {key:'gpm',label:'GPM',type:'number'}
        ];
    }
    if (type === 'titration') {
        return [
            {key:'initials',label:'Initials',type:'text'},
            {key:'fluidName',label:'Fluid',type:'text'},
            {key:'sampleLocation',label:'Sample',type:'select',options:[{v:'in',l:'In'},{v:'out',l:'Out'}]},
            {key:'density',label:'Density',type:'text'},
            {key:'viscosity',label:'Viscosity',type:'text'},
            {key:'ph',label:'pH',type:'text'},
            {key:'chlorides',label:'Chlorides',type:'text'},
            {key:'calcium',label:'Calcium',type:'text'},
            {key:'hardness',label:'Hardness',type:'text'},
            {key:'magnesium',label:'Magnesium',type:'text'},
            {key:'r600',label:'600 RPM',type:'text'},
            {key:'r300',label:'300 RPM',type:'text'},
            {key:'r200',label:'200 RPM',type:'text'},
            {key:'r100',label:'100 RPM',type:'text'},
            {key:'r6',label:'6 RPM',type:'text'},
            {key:'r3',label:'3 RPM',type:'text'},
            {key:'pv',label:'PV',type:'text'},
            {key:'yp',label:'YP',type:'text'},
            {key:'gel10s',label:'10-sec Gel',type:'text'},
            {key:'gel10m',label:'10-min Gel',type:'text'},
            {key:'surfaceVol',label:'Surface Vol',type:'text'}
        ];
    }
    if (type === 'plug') {
        return [
            {key:'plug-num',label:'Plug #',type:'text'},
            {key:'plug-total',label:'Total Plugs',type:'text'},
            {key:'plug-jnt',label:'Joint',type:'text'},
            {key:'plug-jnt-out',label:'JNT Out',type:'text'},
            {key:'plug-depth',label:'Depth',type:'number'},
            {key:'plug-drill-time',label:'Drill Time',type:'text'},
            {key:'plug-wash-time',label:'Wash Time',type:'text'},
            {key:'plug-rih-wt',label:'RIH Wt',type:'text'},
            {key:'plug-neutral-wt',label:'Neutral Wt',type:'text'},
            {key:'plug-pu-wt',label:'P/U Wt',type:'text'},
            {key:'plug-rpm',label:'RPM',type:'text'},
            {key:'plug-wob',label:'WOB',type:'text'},
            {key:'plug-circ',label:'CIRC',type:'text'},
            {key:'plug-pr',label:'Pump Rate',type:'text'},
            {key:'plug-mp',label:'Motor PSI',type:'text'},
            {key:'plug-rr',label:'Return Rate',type:'text'},
            {key:'plug-choke',label:'Choke',type:'text'},
            {key:'plug-mw-in',label:'MW In',type:'text'},
            {key:'plug-mw-out',label:'MW Out',type:'text'},
            {key:'plug-mv-in',label:'MV In',type:'text'},
            {key:'plug-mv-out',label:'MV Out',type:'text'},
            {key:'plug-cl-in',label:'Cl In',type:'text'},
            {key:'plug-cl-out',label:'Cl Out',type:'text'},
            {key:'plug-marker-sent',label:'Marker Sent',type:'text'},
            {key:'plug-surface-time',label:'Surface Time',type:'text'},
            {key:'plug-sand',label:'Sand',type:'text'},
            {key:'plug-gas',label:'Gas',type:'text'},
            {key:'plug-comments',label:'Comments',type:'text'}
        ];
    }
    return [];
}

function renderLogEditEntries(type) {
    const entries = getLogEntries(type);
    const body = document.getElementById('log-edit-body');
    if (!entries.length) {
        body.innerHTML = '<div style="text-align:center;color:#666;padding:40px">No entries to edit</div>';
        return;
    }

    // For volume log, newest first (already unshifted). For plug log, show newest first too.
    const displayEntries = type === 'plug' ? [...entries].reverse() : entries;

    let html = '';
    displayEntries.forEach((entry, displayIdx) => {
        // Map display index back to actual array index
        const realIdx = type === 'plug' ? (entries.length - 1 - displayIdx) : displayIdx;
        const info = getEntryTitle(type, entry, realIdx);
        const fields = getEditableFields(type, entry);

        html += '<div class="log-edit-entry" id="log-edit-entry-' + realIdx + '">';
        html += '<div class="log-edit-entry-header" onclick="toggleLogEditEntry(' + realIdx + ')">';
        html += '<div><div class="log-edit-entry-title">' + info.title + '</div>';
        html += '<div class="log-edit-entry-sub">' + info.sub + '</div></div>';
        html += '<div class="log-edit-entry-actions">';
        html += '<button class="log-edit-delete-btn" onclick="event.stopPropagation();deleteLogEditEntry(' + realIdx + ')">🗑</button>';
        html += '<span class="log-edit-expand-icon">▼</span>';
        html += '</div></div>';

        html += '<div class="log-edit-entry-fields">';
        fields.forEach(f => {
            let val = entry[f.key];
            if (val === null || val === undefined) val = '';
            if (f.isArray && Array.isArray(val)) val = val.join(', ');

            html += '<div class="log-edit-field">';
            html += '<span class="log-edit-field-label">' + f.label + '</span>';

            if (f.type === 'select') {
                html += '<select class="log-edit-field-select" data-idx="' + realIdx + '" data-key="' + f.key + '">';
                f.options.forEach(o => {
                    html += '<option value="' + o.v + '"' + (String(val) === String(o.v) ? ' selected' : '') + '>' + o.l + '</option>';
                });
                html += '</select>';
            } else {
                html += '<input class="log-edit-field-input" type="' + (f.type === 'number' ? 'number' : 'text') + '" value="' + String(val).replace(/"/g, '&quot;') + '" data-idx="' + realIdx + '" data-key="' + f.key + '"' + (f.isArray ? ' data-array="1"' : '') + '>';
            }
            html += '</div>';
        });
        html += '<button class="log-edit-save-btn" onclick="saveLogEditEntry(' + realIdx + ')">✓ Confirm Changes</button>';
        html += '</div></div>';
    });

    body.innerHTML = html;
}

function toggleLogEditEntry(idx) {
    const el = document.getElementById('log-edit-entry-' + idx);
    if (el) el.classList.toggle('expanded');
}

function deleteLogEditEntry(idx) {
    if (!confirm('Delete this entry?')) return;
    const entries = getLogEntries(_logEditType);
    entries.splice(idx, 1);
    saveLogEntries(_logEditType, entries);
    renderLogEditEntries(_logEditType);
}

function saveLogEditEntry(idx) {
    const entries = getLogEntries(_logEditType);
    if (!entries[idx]) return;
    const entry = entries[idx];

    // Gather all inputs/selects for this index
    const inputs = document.querySelectorAll('[data-idx="' + idx + '"]');
    inputs.forEach(inp => {
        const key = inp.dataset.key;
        let val = inp.value;
        if (inp.dataset.array === '1') {
            val = val.split(',').map(s => s.trim()).filter(s => s);
        } else if (inp.type === 'number' && val !== '') {
            val = parseFloat(val);
            if (isNaN(val)) val = null;
        }
        entry[key] = val;
        // filterType uses null for "System", not empty string
        if (key === 'filterType' && val === '') entry[key] = null;
    });

    entries[idx] = entry;
    saveLogEntries(_logEditType, entries);
    renderLogEditEntries(_logEditType);

    // Brief visual feedback
    const el = document.getElementById('log-edit-entry-' + idx);
    if (el) {
        el.style.borderColor = '#4caf50';
        setTimeout(() => { el.style.borderColor = ''; }, 800);
    }
}

function showPlugReport() {
    const logs = JSON.parse(localStorage.getItem('ips_plug_log') || '[]');
    if (logs.length === 0) { alert('No plugs logged yet'); return; }
    const now = new Date();
    document.getElementById('plug-report-time').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    let html = '<div class="report-section"><div class="report-section-title">Plug Drill-Out Summary (' + logs.length + ' plugs)</div>';
    html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px;color:#e0e0e0">';
    html += '<tr style="background:#0d1b2a;color:#4fc3f7"><th style="padding:6px;text-align:left">Plug</th><th>Depth</th><th>JNT</th><th>Drill</th><th>Wash</th><th>RIH</th><th>Nw</th><th>P/U</th><th>CIRC</th><th>PR</th></tr>';
    logs.forEach(p => {
        html += '<tr style="border-bottom:1px solid #2d4a6f">';
        html += '<td style="padding:5px;font-weight:600;color:#4fc3f7">' + (p['plug-num']||'') + '/' + (p['plug-total']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-depth'] ? Number(p['plug-depth']).toLocaleString() : '') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-jnt']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-drill-time']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-wash-time']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-rih-wt']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-neutral-wt']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-pu-wt']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-circ']||'') + '</td>';
        html += '<td style="padding:5px;text-align:center">' + (p['plug-pr']||'') + '</td>';
        html += '</tr>';
    });
    html += '</table></div></div>';

    // Averages
    const numVals = (key) => logs.map(p => parseFloat(p[key])).filter(v => !isNaN(v));
    const avg = (arr) => arr.length ? (arr.reduce((a,b) => a+b, 0) / arr.length).toFixed(1) : '--';
    const drillTimes = numVals('plug-drill-time');
    const washTimes = numVals('plug-wash-time');
    html += '<div class="report-section"><div class="report-section-title">Averages</div>';
    html += '<div class="report-row"><span class="report-row-label">Avg Drill Time</span><span class="report-row-value">' + avg(drillTimes) + ' min</span></div>';
    html += '<div class="report-row"><span class="report-row-label">Avg Wash Time</span><span class="report-row-value">' + avg(washTimes) + ' min</span></div>';
    html += '<div class="report-row"><span class="report-row-label">Avg CIRC Pressure</span><span class="report-row-value">' + avg(numVals('plug-circ')) + ' PSI</span></div>';
    html += '<div class="report-row"><span class="report-row-label">Avg Pump Rate</span><span class="report-row-value">' + avg(numVals('plug-pr')) + ' BPM</span></div>';
    html += '</div>';

    document.getElementById('plug-report-content').innerHTML = html;
    document.getElementById('plug-report').classList.add('show');
}

function hidePlugReport() { document.getElementById('plug-report').classList.remove('show'); }

function sharePlugReport() {
    const content = document.getElementById('plug-report-content');
    const text = content.innerText;
    if (navigator.share) {
        navigator.share({ title: 'Plug Drill-Out Report', text: text }).catch(() => {});
    } else {
        navigator.clipboard.writeText(text).then(() => alert('Report copied to clipboard'));
    }
}

// ========== WELLBORE VOLUMES ==========
const PIPE_DATA = {
    tubing: {
        '2-3/8': [{w:4.00,id:2.041},{w:4.60,id:1.995},{w:5.80,id:1.867},{w:6.60,id:1.751}],
        '2-7/8': [{w:6.40,id:2.441},{w:6.50,id:2.441},{w:7.80,id:2.323},{w:8.60,id:2.259},{w:8.70,id:2.243}],
        '3-1/2': [{w:7.70,id:3.068},{w:9.20,id:2.992},{w:9.30,id:2.992},{w:10.20,id:2.922},{w:12.70,id:2.750}],
        '4-1/2': [{w:9.50,id:4.090},{w:10.50,id:4.052},{w:11.60,id:3.958},{w:12.60,id:3.958},{w:13.50,id:3.826}]
    },
    casing: {
        '4-1/2': [{w:9.50,id:4.090},{w:10.50,id:4.052},{w:11.60,id:3.958},{w:13.50,id:3.826},{w:15.10,id:3.754}],
        '5':     [{w:11.50,id:4.560},{w:13.00,id:4.494},{w:15.00,id:4.408},{w:18.00,id:4.276},{w:21.40,id:4.154}],
        '5-1/2': [{w:14.00,id:5.012},{w:15.50,id:4.950},{w:17.00,id:4.892},{w:20.00,id:4.778},{w:23.00,id:4.670}],
        '7':     [{w:17.00,id:6.538},{w:20.00,id:6.456},{w:23.00,id:6.366},{w:26.00,id:6.276},{w:29.00,id:6.184},{w:32.00,id:6.094},{w:35.00,id:6.004}],
        '7-5/8': [{w:20.00,id:7.125},{w:24.00,id:7.025},{w:26.40,id:6.969},{w:29.70,id:6.875},{w:33.70,id:6.765}],
        '8-5/8': [{w:24.00,id:8.097},{w:28.00,id:8.017},{w:32.00,id:7.921},{w:36.00,id:7.825},{w:40.00,id:7.725}],
        '9-5/8': [{w:32.30,id:9.001},{w:36.00,id:8.921},{w:40.00,id:8.835},{w:43.50,id:8.755},{w:47.00,id:8.681},{w:53.50,id:8.535}]
    }
};
// Liner uses same data as casing
PIPE_DATA.liner = PIPE_DATA.casing;

const OD_NUMERIC = {'2-3/8':2.375,'2-7/8':2.875,'3-1/2':3.5,'4-1/2':4.5,'5':5.0,'5-1/2':5.5,'7':7.0,'7-5/8':7.625,'8-5/8':8.625,'9-5/8':9.625};

const VOL_FIELDS = ['vol-tbg-od','vol-tbg-wt','vol-tbg-grade','vol-csg-od','vol-csg-wt','vol-csg-grade','vol-csg-depth','vol-liner-od','vol-liner-wt','vol-liner-grade','vol-liner-tol'];

function syncVolumesHeader() {
    try {
        const saved = localStorage.getItem('ips_plug_data');
        if (!saved) return;
        const pd = JSON.parse(saved);
        const jnt = pd['plug-jnt'] || '--';
        const num = pd['plug-num'] || '--';
        const total = pd['plug-total'] || '--';
        const depth = pd['plug-depth'];
        const jntEl = document.getElementById('vol-hdr-jnt');
        const plugEl = document.getElementById('vol-hdr-plug');
        const depthEl = document.getElementById('vol-hdr-depth');
        if (jntEl) jntEl.textContent = jnt;
        if (plugEl) plugEl.innerHTML = num + ' <span class="plug-total">/ ' + total + '</span>';
        if (depthEl) depthEl.textContent = depth ? Number(depth).toLocaleString() + "'" : "--'";
    } catch(e) {}
}

function getPipeCategory(prefix) {
    if (prefix === 'tbg') return 'tubing';
    if (prefix === 'csg') return 'casing';
    return 'liner';
}

function updateVolWeights(prefix) {
    const odVal = document.getElementById('vol-' + prefix + '-od').value;
    const wtSelect = document.getElementById('vol-' + prefix + '-wt');
    const idDisplay = document.getElementById('vol-' + prefix + '-id');
    wtSelect.innerHTML = '<option value="">--</option>';
    if (idDisplay) idDisplay.textContent = '--';
    if (!odVal) return;
    const cat = getPipeCategory(prefix);
    const pipes = PIPE_DATA[cat][odVal];
    if (!pipes) return;
    pipes.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.w;
        opt.textContent = p.w.toFixed(p.w % 1 === 0 ? 1 : 2);
        wtSelect.appendChild(opt);
    });
}

function updateVolID(prefix) {
    const odVal = document.getElementById('vol-' + prefix + '-od').value;
    const wtVal = parseFloat(document.getElementById('vol-' + prefix + '-wt').value);
    const idDisplay = document.getElementById('vol-' + prefix + '-id');
    if (!odVal || isNaN(wtVal)) { idDisplay.textContent = '--'; return; }
    const cat = getPipeCategory(prefix);
    const pipes = PIPE_DATA[cat][odVal];
    if (!pipes) { idDisplay.textContent = '--'; return; }
    const match = pipes.find(p => Math.abs(p.w - wtVal) < 0.01);
    idDisplay.textContent = match ? match.id.toFixed(3) : '--';
}

function getVolID(prefix) {
    const txt = document.getElementById('vol-' + prefix + '-id').textContent;
    return txt === '--' ? null : parseFloat(txt);
}

function getVolOD(prefix) {
    const odVal = document.getElementById('vol-' + prefix + '-od').value;
    return odVal ? OD_NUMERIC[odVal] || null : null;
}

function calcVolumes() {
    const tbgID = getVolID('tbg');
    const tbgOD = getVolOD('tbg');
    const csgID = getVolID('csg');
    const linerID = getVolID('liner');
    const linerOD = getVolOD('liner');
    const csgDepth = parseFloat(document.getElementById('vol-csg-depth').value) || 0;
    const tol = parseFloat(document.getElementById('vol-liner-tol').value) || 0;

    // Get working depth from plug data
    let workingDepth = 0;
    try {
        const pd = JSON.parse(localStorage.getItem('ips_plug_data') || '{}');
        workingDepth = parseFloat(pd['plug-depth']) || 0;
    } catch(e) {}

    const C = 1029.4; // conversion constant

    // BBL/FT calculations
    const tbgBpf = tbgID ? (tbgID * tbgID / C) : null;
    const csgAnnBpf = (csgID && tbgOD) ? ((csgID * csgID - tbgOD * tbgOD) / C) : null;
    const linerAnnBpf = (linerID && tbgOD) ? ((linerID * linerID - tbgOD * tbgOD) / C) : null;

    document.getElementById('vol-bpf-tbg').textContent = tbgBpf ? tbgBpf.toFixed(5) : '--';
    document.getElementById('vol-bpf-csg-ann').textContent = csgAnnBpf ? csgAnnBpf.toFixed(5) : '--';
    document.getElementById('vol-bpf-liner-ann').textContent = linerAnnBpf ? linerAnnBpf.toFixed(5) : '--';

    // Volume calculations
    // Tubing volume = full depth
    const tbgVol = (tbgBpf && workingDepth) ? tbgBpf * workingDepth : 0;

    // CSG annulus: surface to TOL (or to working depth if no liner)
    const csgAnnLen = tol > 0 ? tol : workingDepth;
    const csgAnnVol = (csgAnnBpf && csgAnnLen) ? csgAnnBpf * csgAnnLen : 0;

    // Liner annulus: TOL to working depth
    const linerAnnLen = (tol > 0 && workingDepth > tol) ? (workingDepth - tol) : 0;
    const linerAnnVol = (linerAnnBpf && linerAnnLen) ? linerAnnBpf * linerAnnLen : 0;

    const totalAnn = csgAnnVol + linerAnnVol;
    const totalWellbore = tbgVol + totalAnn;

    // Display
    document.getElementById('vol-calc-tbg').textContent = tbgVol > 0 ? tbgVol.toFixed(1) : '--';
    document.getElementById('vol-calc-csg-ann').textContent = csgAnnVol > 0 ? csgAnnVol.toFixed(1) : '--';
    document.getElementById('vol-calc-csg-ann-note').textContent = csgAnnLen > 0 ? '0 - ' + csgAnnLen.toLocaleString() + "' (" + csgAnnLen.toLocaleString() + ' ft)' : '--';
    document.getElementById('vol-calc-liner-ann').textContent = linerAnnVol > 0 ? linerAnnVol.toFixed(1) : '--';
    document.getElementById('vol-calc-liner-ann-note').textContent = linerAnnLen > 0 ? tol.toLocaleString() + "' - " + workingDepth.toLocaleString() + "' (" + linerAnnLen.toLocaleString() + ' ft)' : '--';
    document.getElementById('vol-calc-ann-total').textContent = totalAnn > 0 ? totalAnn.toFixed(1) : '--';
    document.getElementById('vol-calc-total').textContent = totalWellbore > 0 ? totalWellbore.toFixed(1) : '--';
}

function saveVolData() {
    const d = {};
    VOL_FIELDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) d[id] = el.value;
    });
    localStorage.setItem('ips_vol_data', JSON.stringify(d));
    firebaseSaveVolData();
}

function loadVolData() {
    const saved = localStorage.getItem('ips_vol_data');
    if (!saved) return;
    try {
        const d = JSON.parse(saved);
        // Restore OD selections first, then trigger weight population, then set weight
        ['tbg','csg','liner'].forEach(prefix => {
            const odEl = document.getElementById('vol-' + prefix + '-od');
            const odKey = 'vol-' + prefix + '-od';
            const wtKey = 'vol-' + prefix + '-wt';
            if (odEl && d[odKey]) {
                odEl.value = d[odKey];
                updateVolWeights(prefix);
                const wtEl = document.getElementById(wtKey);
                if (wtEl && d[wtKey]) {
                    wtEl.value = d[wtKey];
                    updateVolID(prefix);
                }
            }
        });
        // Restore text/number inputs
        ['vol-tbg-grade','vol-csg-grade','vol-csg-depth','vol-liner-grade','vol-liner-tol'].forEach(id => {
            const el = document.getElementById(id);
            if (el && d[id] !== undefined) el.value = d[id];
        });
        syncVolumesHeader();
        calcVolumes();
    } catch(e) {}
}

function switchMainTab(tab) {
    const tabs = ['tanks','gainloss','transfer','injection','titrations'];
    document.querySelectorAll('.main-tab').forEach((t,i) => t.classList.toggle('active', tabs[i]===tab));
    tabs.forEach(id => { const el=document.getElementById(id+'-tab'); if(el) el.classList.toggle('active', id===tab); });
    if(tab==='gainloss') renderGLTotals();
    if(tab==='transfer') renderXferTotals();
}
function switchSide(side) {
    currentSide = side;
    document.querySelectorAll('.side-toggle .side-tab').forEach((t,i) => t.classList.toggle('active', (i===0 && side==='pump') || (i===1 && side==='return')));
    document.getElementById('pump-tanks').classList.toggle('active', side==='pump');
    document.getElementById('return-tanks').classList.toggle('active', side==='return');
}
function setJetType(type) {
    jetType = type;
    document.querySelectorAll('.jet-toggle-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.jet-toggle-btn.'+type).classList.add('active');
    const buildRow = document.getElementById('build-row');
    const volRow = document.getElementById('xfer-volume-row');
    const volInput = document.getElementById('jet-volume');
    if (type === 'build') {
        buildRow.style.display = 'block';
        if (volRow) volRow.querySelector('span').textContent = 'BBL/batch';
        if (volInput) volInput.value = '35';
        updateBuildTotal();
    } else {
        buildRow.style.display = 'none';
        if (volRow) volRow.querySelector('span').textContent = 'BBL';
        if (volInput) volInput.value = '120';
    }
}
let buildCount = 1;
function adjustBuildCount(delta) {
    buildCount = Math.max(1, buildCount + delta);
    document.getElementById('build-count').textContent = buildCount;
    updateBuildTotal();
}
function populateBuildDest() {
    // No longer needed - tank selection via modal now
}
function updateBuildTotal() {
    const perBatch = parseFloat(document.getElementById('jet-volume').value) || 35;
    document.getElementById('build-total-display').textContent = (buildCount * perBatch) + ' BBL';
}
function executeBuild() {
    // Called from old flow — no longer used directly, 
    // now routed through startTransferCapture → modal → confirmXferTankSelection
}
function showBuildEqualizeModal(dest, eqTanks, vol) {
    const all = [dest, ...eqTanks], per = Math.round(vol / all.length);
    document.getElementById('equalize-question').innerHTML = 'Is <strong>' + dest.name + '</strong> equalized?<br><br>' + vol + ' BBL build split = <strong>' + per + ' BBL</strong> each';
    document.getElementById('equalize-tanks-list').innerHTML = all.map(t => t.name).join(', ');
    document.getElementById('equalize-modal').classList.add('show');
}
function finalizeBuild(tanks, totalVol) {
    const per = Math.round(totalVol / tanks.length);
    tanks.forEach(t => { t.bbls += per; t.inches = bblToInches(t.bbls); t.estimated = true; });
    if (!data.transferLog) data.transferLog = [];
    data.transferLog.unshift({ time: new Date().toISOString(), initials: profileData.initials || '', type: 'build', volume: totalVol, batches: buildCount, perBatch: parseFloat(document.getElementById('jet-volume').value) || 35, tanks: tanks.map(t => t.name) });
    buildCount = 1;
    document.getElementById('build-count').textContent = '1';
    const perBatch = parseFloat(document.getElementById('jet-volume').value) || 35;
    document.getElementById('build-total-display').textContent = perBatch + ' BBL';
    saveData(); render(); renderTransferLog(); populateBuildDest();
    if (tanks.length === 1) alert('Built ' + totalVol + ' BBL\n' + tanks[0].name + ': ' + tanks[0].bbls + ' BBL (est ' + tanks[0].inches + '")');
    else alert('Built ' + totalVol + ' BBL across ' + tanks.length + ' tanks');
}
function resetShiftJetted() { if(confirm('Reset shift jetted total?')) { data.jetsShift=0; saveData(); render(); } }

// === Transfer Tab Fluid Filter ===
let xferFluidFilter = null;

function setXferFluidFilter(type) {
    xferFluidFilter = xferFluidFilter === type ? null : type;
    ['brine','packer','mud','recirc','freshwater','other'].forEach(t => {
        const btn = document.getElementById('xfer-filter-' + t);
        if (btn) btn.classList.toggle('filter-active', xferFluidFilter === t);
    });
    const label = document.getElementById('xfer-filter-label');
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Freshwater',other:'Other'};
    const fluidLabelColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    if (label) {
        if (xferFluidFilter) {
            const fName = fluidNames[xferFluidFilter] || xferFluidFilter;
            const fClr = fluidLabelColors[xferFluidFilter] || '#e0e0e0';
            label.innerHTML = 'Capture <span style="color:' + fClr + '">' + fName + '</span> Only';
        } else {
            label.innerHTML = 'Capture <span style="color:#e0e0e0">System</span>';
        }
    }
}

function renderXferTotals() {
    const totals = calculateTotals();
    const el = (id) => document.getElementById(id);
    if(el('xfer-total-brine')) el('xfer-total-brine').textContent = totals.brine;
    if(el('xfer-total-packer')) el('xfer-total-packer').textContent = totals.packer;
    if(el('xfer-total-mud')) el('xfer-total-mud').textContent = totals.mud;
    if(el('xfer-total-recirc')) el('xfer-total-recirc').textContent = totals.recirc;
    if(el('xfer-total-freshwater')) el('xfer-total-freshwater').textContent = totals.freshwater;
    if(el('xfer-total-other')) el('xfer-total-other').textContent = totals.other;
}

// === Transfer Capture Flow ===
let xferSelectedTanks = [];

function getTanksForFluidType(fluidType) {
    const tanks = [];
    data.pumpTanks.forEach(t => {
        if (getTankFluidType(t, 'pump') === fluidType) tanks.push({ tank: t, side: 'pump' });
    });
    data.returnTanks.forEach(t => {
        if (getTankFluidType(t, 'return') === fluidType) tanks.push({ tank: t, side: 'return' });
    });
    return tanks;
}

function startTransferCapture() {
    const vol = parseFloat(document.getElementById('jet-volume').value) || 120;
    const totalVol = jetType === 'build' ? buildCount * vol : vol;
    
    // Get filtered tanks
    const filter = xferFluidFilter;
    let tankList;
    if (filter) {
        tankList = getTanksForFluidType(filter);
    } else {
        // System — show all tanks
        tankList = [];
        data.pumpTanks.forEach(t => tankList.push({ tank: t, side: 'pump' }));
        data.returnTanks.forEach(t => tankList.push({ tank: t, side: 'return' }));
    }
    
    if (tankList.length === 0) {
        alert('No tanks available' + (filter ? ' for this fluid type' : ''));
        return;
    }
    
    // Set modal title based on jet type
    const titleEl = document.getElementById('xfer-modal-title');
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Freshwater',other:'Other'};
    const typeLabel = filter ? (fluidNames[filter] || filter) + ' — ' : '';
    if (jetType === 'out') {
        titleEl.textContent = typeLabel + 'Remove from which tank(s)?';
        titleEl.style.color = '#ef5350';
    } else if (jetType === 'in') {
        titleEl.textContent = typeLabel + 'Added into what tank(s)?';
        titleEl.style.color = '#4caf50';
    } else {
        titleEl.textContent = typeLabel + 'Added to what tank(s)?';
        titleEl.style.color = '#a1887f';
    }
    
    // Populate tank list with checkboxes
    xferSelectedTanks = [];
    const listEl = document.getElementById('xfer-tank-list');
    const fluidColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    listEl.innerHTML = tankList.map((item, idx) => {
        const t = item.tank;
        const ft = getTankFluidType(t, item.side);
        const borderClr = fluidColors[ft] || '#2d4a6f';
        return '<div onclick="toggleXferTank(' + idx + ')" id="xfer-pick-' + idx + '" data-tank-id="' + t.id + '" ' +
            'style="display:flex;justify-content:space-between;align-items:center;padding:12px;margin-bottom:6px;' +
            'background:#1b2838;border:2px solid #2d4a6f;border-left:4px solid ' + borderClr + ';border-radius:6px;cursor:pointer">' +
            '<div><div style="font-weight:600;color:#e0e0e0;font-size:14px">' + t.name + '</div>' +
            '<div style="font-size:11px;color:#888">' + t.inches + '" — ' + t.bbls + ' BBL</div></div>' +
            '<div style="width:24px;height:24px;border:2px solid #2d4a6f;border-radius:4px;display:flex;align-items:center;justify-content:center" ' +
            'id="xfer-chk-' + idx + '"></div></div>';
    }).join('');
    
    // Store tank list reference for confirm
    window._xferTankList = tankList;
    window._xferTotalVol = totalVol;
    
    document.getElementById('xfer-tank-modal').classList.add('show');
}

function toggleXferTank(idx) {
    const pos = xferSelectedTanks.indexOf(idx);
    if (pos >= 0) {
        xferSelectedTanks.splice(pos, 1);
        document.getElementById('xfer-pick-' + idx).style.borderColor = '#2d4a6f';
        document.getElementById('xfer-chk-' + idx).innerHTML = '';
    } else {
        xferSelectedTanks.push(idx);
        document.getElementById('xfer-pick-' + idx).style.borderColor = '#4fc3f7';
        document.getElementById('xfer-chk-' + idx).innerHTML = '<span style="color:#4fc3f7;font-weight:700">✓</span>';
    }
}

function hideXferTankModal() {
    document.getElementById('xfer-tank-modal').classList.remove('show');
    xferSelectedTanks = [];
}

function confirmXferTankSelection() {
    if (xferSelectedTanks.length === 0) { alert('Select at least one tank'); return; }
    
    const tankList = window._xferTankList;
    const totalVol = window._xferTotalVol;
    const selectedTanks = xferSelectedTanks.map(idx => tankList[idx].tank);
    
    hideXferTankModal();
    
    // Check equalization for first selected tank
    if (selectedTanks.length === 1) {
        const result = findTank(selectedTanks[0].id);
        if (result) {
            const eqTanks = getEqualizableTanks(result.tank, result.side);
            if (eqTanks.length > 0) {
                if (jetType === 'build') {
                    pendingJet = { tank: result.tank, side: result.side, volume: totalVol, equalizableTanks: eqTanks, isBuild: true };
                    showBuildEqualizeModal(result.tank, eqTanks, totalVol);
                } else if (jetType === 'out') {
                    pendingJet = { tank: result.tank, side: result.side, volume: totalVol, equalizableTanks: eqTanks };
                    showEqualizeModal(result.tank, eqTanks, totalVol);
                } else {
                    executeJet(selectedTanks, totalVol);
                }
                return;
            }
        }
    }
    
    // No equalization needed — execute directly
    if (jetType === 'build') {
        finalizeBuild(selectedTanks, totalVol);
    } else {
        executeJet(selectedTanks, totalVol);
    }
}

function updatePF() { const ph = parseFloat(document.getElementById('tit-ph').value)||0; if(ph<=7) document.getElementById('tit-pf').value='0'; }
function calcRheology() {
    const r600 = parseFloat(document.getElementById('tit-r600').value)||0;
    const r300 = parseFloat(document.getElementById('tit-r300').value)||0;
    if(r600>0 && r300>0) {
        const pv = r600 - r300;
        const yp = r300 - pv;
        document.getElementById('tit-pv').textContent = pv;
        document.getElementById('tit-yp').textContent = yp;
    } else {
        document.getElementById('tit-pv').textContent = '--';
        document.getElementById('tit-yp').textContent = '--';
    }
}

function calcChlorides() {
    const sn = document.getElementById('tit-sn-type').value;
    const p = parseFloat(document.getElementById('tit-cl-pipette').value)||0;
    const ppm = sn==='fresh' ? p*1000 : p*10000;
    document.getElementById('tit-chlorides').textContent = ppm>0 ? ppm.toLocaleString() : '--';
}
function calcHardness() {
    const p = parseFloat(document.getElementById('tit-hard-pipette').value)||0;
    document.getElementById('tit-hardness').textContent = p>0 ? (p*400).toLocaleString() : '--';
    calcMagnesium();
}
function calcCalcium() {
    const p = parseFloat(document.getElementById('tit-ca-pipette').value)||0;
    document.getElementById('tit-calcium').textContent = p>0 ? (p*400).toLocaleString() : '--';
    calcMagnesium();
}
function calcMagnesium() {
    const h = parseFloat(document.getElementById('tit-hard-pipette').value)||0;
    const c = parseFloat(document.getElementById('tit-ca-pipette').value)||0;
    if(h>0 && c>0) { const m=(h-c)*243; document.getElementById('tit-magnesium').textContent = m>=0 ? Math.round(m).toLocaleString() : '--'; }
    else document.getElementById('tit-magnesium').textContent = '--';
}

function selectModalSide(side) {
    modalSide = side;
    document.querySelectorAll('.modal-tabs .modal-tab').forEach((t,i) => t.classList.toggle('active', (i===0 && side==='pump') || (i===1 && side==='return')));
    updateTankTypeOptions();
}
function showAddTankModal() {
    document.getElementById('add-tank-modal').classList.add('show');
    modalSide = currentSide;
    document.querySelectorAll('.modal-tabs .modal-tab').forEach((t,i) => t.classList.toggle('active', (i===0 && modalSide==='pump') || (i===1 && modalSide==='return')));
    updateTankTypeOptions();
    document.getElementById('new-tank-qty').value = '1';
}
function hideAddTankModal() { document.getElementById('add-tank-modal').classList.remove('show'); }
function updateTankTypeOptions() {
    const sel = document.getElementById('new-tank-type');
    sel.innerHTML = '<option value="">-- Select --</option>';
    (modalSide==='pump' ? pumpTypes : returnTypes).forEach(t => { sel.innerHTML += '<option value="'+t.value+'">'+t.label+'</option>'; });
}

function getColor(tank) { if(tank.contents) { const o=contentsOptions.find(x=>x.value===tank.contents); return o?o.color:'other'; } const t=[...pumpTypes,...returnTypes].find(x=>x.value===tank.type); return t?t.color:'other'; }
function getBadgeText(tank) { if(tank.contents) { const o=contentsOptions.find(x=>x.value===tank.contents); return o&&o.value?o.label.toUpperCase():''; } const t=[...pumpTypes,...returnTypes].find(x=>x.value===tank.type); return t?t.badgeText:''; }
function countTanksOfType(side,type) { return (side==='pump'?data.pumpTanks:data.returnTanks).filter(t=>t.type===type).length; }
function generateTankName(side,type,idx) { const t=(side==='pump'?pumpTypes:returnTypes).find(x=>x.value===type); const b=t?t.label:type; if(type==='sandcat') return b; return b+' '+idx; }

function addTanks() {
    if (fbRoom && !fbIsAdmin) { alert('Only the room admin (' + (fbAdminInitials||'creator') + ') can add tanks'); return; }
    const type=document.getElementById('new-tank-type').value, qty=parseInt(document.getElementById('new-tank-qty').value)||1;
    if(!type) { alert('Select a tank type'); return; }
    const existing = countTanksOfType(modalSide,type);
    for(let i=0;i<qty;i++) { const tank={id:Date.now()+i,type,name:generateTankName(modalSide,type,existing+i+1),inches:0,bbls:0,contents:'',side:modalSide,estimated:false}; (modalSide==='pump'?data.pumpTanks:data.returnTanks).push(tank); }
    renumberTanksOfType(modalSide,type); saveData(); render(); hideAddTankModal(); switchSide(modalSide);
}
function renumberTanksOfType(side,type) { const tanks=(side==='pump'?data.pumpTanks:data.returnTanks).filter(t=>t.type===type); tanks.forEach((tank,i)=>{ tank.name=generateTankName(side,type,i+1); }); }
function deleteTank(side,id) { if(fbRoom && !fbIsAdmin){alert('Only the room admin (' + (fbAdminInitials||'creator') + ') can delete tanks');return;} if(!confirm('Delete?')) return; let dt=''; if(side==='pump'){const t=data.pumpTanks.find(x=>x.id===id);if(t)dt=t.type;data.pumpTanks=data.pumpTanks.filter(x=>x.id!==id);}else{const t=data.returnTanks.find(x=>x.id===id);if(t)dt=t.type;data.returnTanks=data.returnTanks.filter(x=>x.id!==id);} if(dt)renumberTanksOfType(side,dt); saveData(); render(); }
function renderTotals() {
    const totals=calculateTotals(); 
    const el = (id) => document.getElementById(id);
    if(el('total-brine')) el('total-brine').textContent=totals.brine; 
    if(el('total-packer')) el('total-packer').textContent=totals.packer; 
    if(el('total-mud')) el('total-mud').textContent=totals.mud; 
    if(el('total-recirc')) el('total-recirc').textContent=totals.recirc; 
    if(el('total-freshwater')) el('total-freshwater').textContent=totals.freshwater; 
    if(el('total-other')) el('total-other').textContent=totals.other; 
    if(el('system-total')) el('system-total').textContent=totals.system+' BBL'; 
    if(el('jetted-total')) el('jetted-total').textContent=data.jetsShift+' BBL';
}
function updateTank(side,id,field,val) { 
    const tank=(side==='pump'?data.pumpTanks:data.returnTanks).find(t=>t.id===id); 
    if(!tank)return; 
    if(field==='inches'){
        tank.inches=parseFloat(val)||0;
        tank.bbls=inchesToBbl(tank.inches);
        tank.estimated=false;
        tank.lastStrapTime=new Date().toISOString();
        tank.lastStrapBy=profileData.initials||'';
        tank._updatedAt=new Date().toISOString();
        tank._updatedBy=profileData.initials||'';
        // Targeted DOM update — update BBL, fill bar, and totals without full re-render
        const card = document.querySelector('.tank-card[data-side="'+side+'"][data-id="'+id+'"]');
        if(card){
            const bblEl = card.querySelector('.bbl-value');
            if(bblEl) bblEl.textContent = tank.bbls;
            const color = getColor(tank);
            const maxBbl = tank.type==='sandcat'?185:500;
            const fillPct = Math.min(100,Math.round((tank.bbls/maxBbl)*100));
            const fc = getTankFillColor(color);
            card.style.background = 'linear-gradient(to right, '+fc.fill+' '+fillPct+'%, '+fc.bg+' '+fillPct+'%)';
        }
        // Update summary totals
        renderTotals();
    }else if(field==='contents'){
        tank.contents=val;
        tank._updatedAt=new Date().toISOString();
        tank._updatedBy=profileData.initials||'';
    } 
    saveData();
    // Only do full render for non-inches changes (contents needs card rebuild)
    if(field!=='inches') render();
}
// Debounce timer for Firebase saves during rapid input
let _tankSaveTimer = null;
function setSandcatFull(id) { const tank=data.returnTanks.find(t=>t.id===id); if(tank){tank.bbls=185;tank.inches=bblToInches(185);tank.estimated=false;tank.lastStrapTime=new Date().toISOString();tank.lastStrapBy=profileData.initials||'';tank._updatedAt=new Date().toISOString();tank._updatedBy=profileData.initials||'';saveData();render();} }

function calculateTotals() { let totals={brine:0,packer:0,mud:0,recirc:0,freshwater:0,other:0,system:0}; data.pumpTanks.forEach(t=>{totals.system+=t.bbls;if(t.type==='brine10'||t.type==='brine119')totals.brine+=t.bbls;else if(t.type==='packer')totals.packer+=t.bbls;else if(t.type==='aphron')totals.mud+=t.bbls;else if(t.type==='recirc')totals.recirc+=t.bbls;else if(t.type==='freshwater')totals.freshwater+=t.bbls;else totals.other+=t.bbls;}); data.returnTanks.forEach(t=>{totals.system+=t.bbls;const f=t.contents||'';if(f==='brine')totals.brine+=t.bbls;else if(f==='mud')totals.mud+=t.bbls;else if(f==='recirc')totals.recirc+=t.bbls;else if(f==='freshwater')totals.freshwater+=t.bbls;else totals.other+=t.bbls;}); return totals; }

function findTank(id) { let t=data.pumpTanks.find(x=>x.id===id); if(t)return{tank:t,side:'pump'}; t=data.returnTanks.find(x=>x.id===id); if(t)return{tank:t,side:'return'}; return null; }
function getEqualizableTanks(tank,side) { if(side==='pump')return data.pumpTanks.filter(t=>t.id!==tank.id&&t.type===tank.type); const info=returnTypes.find(x=>x.value===tank.type); if(info&&info.canEqualize)return data.returnTanks.filter(t=>t.id!==tank.id&&returnEqualizeTypes.includes(t.type)); if(tank.type==='sandcat')return data.returnTanks.filter(t=>t.id!==tank.id&&t.type==='sandcat'); return []; }
function startJetProcess() { const srcId=parseInt(document.getElementById('jet-source').value),vol=parseFloat(document.getElementById('jet-volume').value)||120; if(!srcId){alert('Select a tank');return;} const result=findTank(srcId); if(!result){alert('Tank not found');return;} const{tank,side}=result,eqTanks=getEqualizableTanks(tank,side); if(eqTanks.length>0&&jetType==='out'){pendingJet={tank,side,volume:vol,equalizableTanks:eqTanks};showEqualizeModal(tank,eqTanks,vol);}else{executeJet([tank],vol);} }
function showEqualizeModal(src,eqTanks,vol) { const all=[src,...eqTanks],per=Math.round(vol/all.length); document.getElementById('equalize-question').innerHTML='Is <strong>'+src.name+'</strong> equalized?<br><br>'+vol+' BBL split = <strong>'+per+' BBL</strong> each'; document.getElementById('equalize-tanks-list').innerHTML=all.map(t=>t.name).join(', '); document.getElementById('equalize-modal').classList.add('show'); }
function hideEqualizeModal() { document.getElementById('equalize-modal').classList.remove('show'); pendingJet=null; }
function confirmEqualize(isEq) { if(!pendingJet)return; const{tank,volume,equalizableTanks,isBuild}=pendingJet; if(isBuild){finalizeBuild(isEq?[tank,...equalizableTanks]:[tank],volume);}else{executeJet(isEq?[tank,...equalizableTanks]:[tank],volume);} hideEqualizeModal(); }
function executeJet(tanks,totalVol) { const per=Math.round(totalVol/tanks.length); tanks.forEach(t=>{if(jetType==='out')t.bbls=Math.max(0,t.bbls-per);else t.bbls+=per;t.inches=bblToInches(t.bbls);t.estimated=true;}); if(jetType==='out'){data.jetsHour+=totalVol;data.jetsShift+=totalVol;} if(!data.transferLog)data.transferLog=[]; data.transferLog.unshift({time:new Date().toISOString(),initials:profileData.initials||'',type:jetType,volume:totalVol,tanks:tanks.map(t=>t.name)}); document.getElementById('jet-volume').value='120'; saveData();render();renderTransferLog(); const act=jetType==='out'?'Jetted out':'Jetted in'; if(tanks.length===1)alert(act+' '+totalVol+' BBL\n'+tanks[0].name+': '+tanks[0].bbls+' BBL (est '+tanks[0].inches+'")'); else alert(act+' '+totalVol+' BBL across '+tanks.length+' tanks'); }
function logGainLossCheck() { 
    const totals = calculateTotals(), curr = totals.system, now = new Date();
    const lastCheckTime = data.lastCheckTime ? new Date(data.lastCheckTime) : null;
    
    // Build lookup: tank name -> fluid category
    const tankFluidMap = {};
    data.pumpTanks.forEach(t => {
        if(t.type==='brine10'||t.type==='brine119') tankFluidMap[t.name]='brine';
        else if(t.type==='packer') tankFluidMap[t.name]='packer';
        else if(t.type==='aphron') tankFluidMap[t.name]='mud';
        else if(t.type==='recirc') tankFluidMap[t.name]='recirc';
        else if(t.type==='freshwater') tankFluidMap[t.name]='freshwater';
        else tankFluidMap[t.name]='other';
    });
    data.returnTanks.forEach(t => {
        const f=t.contents||'';
        if(f==='brine') tankFluidMap[t.name]='brine';
        else if(f==='mud') tankFluidMap[t.name]='mud';
        else if(f==='recirc') tankFluidMap[t.name]='recirc';
        else if(f==='freshwater') tankFluidMap[t.name]='freshwater';
        else tankFluidMap[t.name]='other';
    });
    
    // Snapshot all tank BBLs
    const tankSnap = {};
    [...data.pumpTanks,...data.returnTanks].forEach(t => { tankSnap[t.name] = t.bbls; });
    
    // Compare to previous snapshot to find per-tank changes
    const tankChanges = [];
    const prevSnap = (data.history.length && data.history[0].tankSnap) ? data.history[0].tankSnap : null;
    if (prevSnap) {
        for (const name in tankSnap) {
            const prev = prevSnap[name];
            if (prev !== undefined && tankSnap[name] !== prev) {
                tankChanges.push({ name: name, delta: tankSnap[name] - prev, fluid: tankFluidMap[name] || 'other' });
            }
        }
    }
    
    // === Calculate ALL transfers since last check, broken down by fluid type ===
    const fluidTypes = ['brine','packer','mud','recirc','freshwater','other'];
    const xferByType = {};
    fluidTypes.forEach(f => { xferByType[f] = { out: 0, in: 0, build: 0 }; });
    let xferTotalOut = 0, xferTotalIn = 0, xferTotalBuild = 0;
    
    if (data.transferLog && lastCheckTime) {
        data.transferLog.forEach(tl => {
            const tlTime = new Date(tl.time);
            if (tlTime > lastCheckTime && tlTime <= now) {
                const perTank = tl.tanks && tl.tanks.length ? Math.round(tl.volume / tl.tanks.length) : tl.volume;
                if (tl.type === 'out') {
                    xferTotalOut += tl.volume;
                    if (tl.tanks) tl.tanks.forEach(name => {
                        const ft = tankFluidMap[name] || 'other';
                        xferByType[ft].out += perTank;
                    });
                } else if (tl.type === 'in') {
                    xferTotalIn += tl.volume;
                    if (tl.tanks) tl.tanks.forEach(name => {
                        const ft = tankFluidMap[name] || 'other';
                        xferByType[ft].in += perTank;
                    });
                } else if (tl.type === 'build') {
                    xferTotalBuild += tl.volume;
                    if (tl.tanks) tl.tanks.forEach(name => {
                        const ft = tankFluidMap[name] || 'other';
                        xferByType[ft].build += perTank;
                    });
                }
            }
        });
    }
    
    // === System-level calculations ===
    // Apparent = simple difference in system total
    const last = data.lastSystemTotal;
    const sysApp = last !== null ? curr - last : null;
    // Actual = Apparent + stuff_removed - stuff_added (jet outs restore, jet ins/builds subtract)
    const sysActual = sysApp !== null ? sysApp + xferTotalOut - xferTotalIn - xferTotalBuild : null;
    
    let elapsedMin = null, sysRate = null;
    if (lastCheckTime) {
        elapsedMin = Math.round((now - lastCheckTime) / 60000);
        if (elapsedMin > 0 && sysActual !== null) sysRate = ((sysActual / elapsedMin) * 60).toFixed(1);
    }
    
    // === Store history entry with full transfer data ===
    // === Per-fluid breakdown: apparent & actual for each fluid type ===
    const prevEntry = data.history.length ? data.history[0] : null;
    const prevTotals = prevEntry ? prevEntry.totals : null;
    const fluidBreakdown = {};
    fluidTypes.forEach(ft => {
        const currVal = totals[ft] || 0;
        const prevVal = prevTotals ? (prevTotals[ft] || 0) : null;
        const apparent = prevVal !== null ? currVal - prevVal : null;
        const xf = xferByType[ft];
        const actual = apparent !== null ? apparent + xf.out - xf.in - xf.build : null;
        let rate = null;
        if (elapsedMin && elapsedMin > 0 && actual !== null) rate = ((actual / elapsedMin) * 60).toFixed(1);
        fluidBreakdown[ft] = { current: currVal, previous: prevVal, apparent: apparent, actual: actual, ratePerHour: rate, transfers: xf };
    });
    
    data.history.unshift({
        time: now.toISOString(),
        initials: profileData.initials || '',
        systemTotal: curr,
        apparentChange: sysApp,
        trueChange: sysActual,
        ratePerHour: sysRate,
        elapsedMin: elapsedMin,
        totals: {...totals},
        tankSnap: tankSnap,
        tankChanges: tankChanges,
        filterType: glFluidFilter || null,
        transfersByType: xferByType,
        transfersTotal: { out: xferTotalOut, in: xferTotalIn, build: xferTotalBuild },
        fluidBreakdown: fluidBreakdown
    });
    
    data.lastSystemTotal = curr;
    data.lastCheckTime = now.toISOString();
    data.jetsHour = 0;
    saveData(); render(); renderVolumeLog();
    
    // === Alert message ===
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Freshwater',other:'Other'};
    if (glFluidFilter) {
        const ft = glFluidFilter;
        const fName = fluidNames[ft] || ft;
        const fSurface = totals[ft] || 0;
        const prevTotals = data.history.length > 1 ? data.history[1].totals : null;
        const prevTypeTotal = prevTotals ? (prevTotals[ft] || 0) : null;
        const fApp = prevTypeTotal !== null ? fSurface - prevTypeTotal : null;
        const xf = xferByType[ft];
        const fActual = fApp !== null ? fApp + xf.out - xf.in - xf.build : null;
        let fRate = null;
        if (elapsedMin && elapsedMin > 0 && fActual !== null) fRate = ((fActual / elapsedMin) * 60).toFixed(1);
        
        let msg = fName + ' Check logged!\n' + fName + ' Surface: ' + fSurface + ' BBL';
        if (fApp !== null) msg += '\nApparent: ' + (fApp >= 0 ? '+' : '') + fApp + ' bbl';
        if (fActual !== null) msg += '\nActual G/L: ' + (fActual >= 0 ? '+' : '') + fActual + ' bbl';
        const netXfer = xf.out - xf.in - xf.build;
        if (xf.out || xf.in || xf.build) msg += '\nTransfers: ' + (netXfer >= 0 ? '+' : '') + netXfer + ' bbl';
        if (fRate !== null) msg += '\nRate: ' + (parseFloat(fRate) >= 0 ? '+' : '') + fRate + ' bbl/hr';
        alert(msg);
    } else {
        let msg = 'Check logged!\nSystem: ' + curr + ' BBL';
        if (sysApp !== null) msg += '\nApparent: ' + (sysApp >= 0 ? '+' : '') + sysApp + ' bbl';
        if (sysActual !== null) msg += '\nActual G/L: ' + (sysActual >= 0 ? '+' : '') + sysActual + ' bbl';
        if (sysRate !== null) msg += '\nRate: ' + (parseFloat(sysRate) >= 0 ? '+' : '') + sysRate + ' bbl/hr';
        // Per-fluid breakdown
        if (prevTotals) {
            const changedFluids = fluidTypes.filter(ft => fluidBreakdown[ft].apparent !== null && fluidBreakdown[ft].apparent !== 0);
            if (changedFluids.length) {
                msg += '\n\n--- Per Fluid ---';
                changedFluids.forEach(ft => {
                    const fb = fluidBreakdown[ft];
                    const name = fluidNames[ft] || ft;
                    msg += '\n' + name + ': ' + (fb.apparent >= 0 ? '+' : '') + fb.apparent;
                    if (fb.actual !== null && fb.actual !== fb.apparent) msg += ' (actual ' + (fb.actual >= 0 ? '+' : '') + fb.actual + ')';
                });
            }
        }
        alert(msg);
    }
}

function hasContentsDropdown(tank) { const t=returnTypes.find(x=>x.value===tank.type); return t&&t.hasContents; }
function getTankFillColor(color) {
    const colors = {
        brine10: {bg:'rgba(66,165,245,0.15)', fill:'rgba(66,165,245,0.40)'},
        brine119: {bg:'rgba(30,136,229,0.15)', fill:'rgba(30,136,229,0.40)'},
        aphron: {bg:'rgba(141,110,99,0.15)', fill:'rgba(141,110,99,0.42)'},
        recirc: {bg:'rgba(171,71,188,0.15)', fill:'rgba(171,71,188,0.40)'},
        freshwater: {bg:'rgba(38,166,154,0.15)', fill:'rgba(38,166,154,0.40)'},
        mud: {bg:'rgba(141,110,99,0.15)', fill:'rgba(141,110,99,0.42)'},
        mixed: {bg:'rgba(120,144,156,0.15)', fill:'rgba(120,144,156,0.40)'},
        trash: {bg:'rgba(239,83,80,0.15)', fill:'rgba(239,83,80,0.40)'},
        sandcat: {bg:'rgba(255,167,38,0.15)', fill:'rgba(255,167,38,0.40)'},
        processed: {bg:'rgba(171,71,188,0.15)', fill:'rgba(171,71,188,0.40)'},
        packer: {bg:'rgba(255,112,67,0.15)', fill:'rgba(255,112,67,0.40)'},
        other: {bg:'rgba(120,144,156,0.15)', fill:'rgba(120,144,156,0.40)'},
        return: {bg:'rgba(120,144,156,0.15)', fill:'rgba(120,144,156,0.40)'}
    };
    return colors[color] || colors.other;
}
function renderTankCard(tank,side) { const color=getColor(tank),badge=getBadgeText(tank); const maxBbl=tank.type==='sandcat'?185:500; const fillPct=Math.min(100,Math.round((tank.bbls/maxBbl)*100)); const fc=getTankFillColor(color); let dd=''; if(side==='return'&&hasContentsDropdown(tank)){dd='<div class="input-group contains-group"><label>Contains</label><select onchange="updateTank(\''+side+'\','+tank.id+',\'contents\',this.value)">'+contentsOptions.map(o=>'<option value="'+o.value+'"'+(tank.contents===o.value?' selected':'')+'>'+o.label+'</option>').join('')+'</select></div>';} let fullBtn=tank.type==='sandcat'?'<button class="full-btn" onclick="setSandcatFull('+tank.id+')">Full</button>':''; let nameClass='color-'+color; if(tank.type==='return'&&!tank.contents)nameClass='color-return'; 
/* Build top row: tank name only (update badge is positioned top-right) */
let topRow=''; 
topRow+='<span class="tank-name '+nameClass+'">'+tank.name+'</span>'; 
/* Update badge — positioned top-right, left of delete X */
let updateBadgeHtml='';
if(tank._updatedAt){const ut=new Date(tank._updatedAt);const ub=tank._updatedBy||'??';const uTime=ut.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});const isRemote=ub!==(profileData.initials||'');updateBadgeHtml='<span class="tank-update-badge'+(isRemote?' remote':'')+'"><span class="update-initials">'+ub+'</span><span class="update-time">'+uTime+'</span></span>';}
/* Build badge row: type badge + treated/untreated */
let badges=badge?'<span class="tank-badge badge-'+color+'">'+badge+'</span>':''; 
if(tank.type==='packer'){const tr=tank.treated;badges+='<span class="tank-badge '+(tr?'badge-treated':'badge-untreated')+'">'+(tr?'TREATED':'UNTREATED')+'</span>';} 
/* EST badge moves to inches input area */
let estOnInput=tank.estimated?'<span class="inches-est-badge">EST</span>':''; 
let inchesLabel='<div class="inches-label-row"><label>Inches</label>'+estOnInput+'</div>';
const keywords=tank.voiceKeywords||[]; const isVoiceWaiting=voiceIsListening&&voiceCurrentTank&&voiceCurrentTank.id===tank.id&&voiceCurrentSide===side&&voiceState==='WAITING_NUMBER'; const isVoiceDone=voiceDoneTankSide===side&&voiceDoneTankId===tank.id; const micClass=isVoiceWaiting?'voice-waiting':isVoiceDone?'voice-done':'inactive'; const micBtn='<div class="tank-mic-btn '+micClass+'"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></div>'; const bleClass=bleConnected&&bleActiveTankSide===side&&bleActiveTankId===tank.id?'ble-waiting':bleDoneTankSide===side&&bleDoneTankId===tank.id?'ble-done':'inactive'; const bleBtn='<div class="tank-ble-btn '+bleClass+'" onclick="toggleBleTank(\''+side+'\','+tank.id+')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg></div>'; const fillStyle='background:linear-gradient(to right, '+fc.fill+' '+fillPct+'%, '+fc.bg+' '+fillPct+'%)'; const showDelete=(!fbRoom||fbIsAdmin); return '<div class="tank-card border-'+color+'" style="'+fillStyle+'" data-side="'+side+'" data-id="'+tank.id+'">'+fullBtn+updateBadgeHtml+(showDelete?'<button class="delete-btn" onclick="deleteTank(\''+side+'\','+tank.id+')">×</button>':'')+'<div class="tank-header"><div class="tank-header-top">'+topRow+'</div>'+(badges?'<div class="tank-header-row">'+badges+'</div>':'')+'</div><div class="tank-inputs"><div class="input-group inches-group">'+inchesLabel+'<input type="number" step="0.25" class="'+(tank.estimated?'estimated':'')+'" value="'+tank.inches+'" oninput="updateTank(\''+side+'\','+tank.id+',\'inches\',this.value)"></div>'+dd+'<div class="bbl-mic-group"><div class="bbl-display"><div class="bbl-label">BBL</div><div class="bbl-value">'+tank.bbls+'</div></div>'+micBtn+bleBtn+'</div></div></div>'; }
function render() { 
    const pumpEl = document.getElementById('pump-tanks');
    const returnEl = document.getElementById('return-tanks');
    const filteredEl = document.getElementById('filtered-tanks');
    const sideToggle = document.getElementById('side-toggle');
    if (!pumpEl || !returnEl) {
        console.error('Tank containers not found, retrying in 100ms');
        setTimeout(render, 100);
        return;
    }
    
    // Fluid filter mode
    if (activeFluidFilter) {
        // Hide side toggle and normal containers, show filtered
        sideToggle.style.display = 'none';
        pumpEl.classList.remove('active');
        returnEl.classList.remove('active');
        filteredEl.classList.add('active');
        
        const matchPump = data.pumpTanks.filter(t => getTankFluidType(t, 'pump') === activeFluidFilter);
        const matchReturn = data.returnTanks.filter(t => getTankFluidType(t, 'return') === activeFluidFilter);
        
        let html = '';
        if (matchPump.length) {
            html += '<div class="filtered-side-label">Pump Side</div>';
            html += matchPump.map(t => renderTankCard(t, 'pump')).join('');
        }
        if (matchReturn.length) {
            html += '<div class="filtered-side-label">Return Side</div>';
            html += matchReturn.map(t => renderTankCard(t, 'return')).join('');
        }
        if (!matchPump.length && !matchReturn.length) {
            html = '<div class="empty-state">No tanks with this fluid type</div>';
        }
        filteredEl.innerHTML = html;
    } else {
        // Normal pump/return mode
        sideToggle.style.display = '';
        filteredEl.classList.remove('active');
        filteredEl.innerHTML = '';
        // Restore active side
        pumpEl.classList.toggle('active', currentSide === 'pump');
        returnEl.classList.toggle('active', currentSide === 'return');
        pumpEl.innerHTML = data.pumpTanks.length === 0 ? '<div class="empty-state">No pump tanks</div>' : data.pumpTanks.map(t => renderTankCard(t, 'pump')).join(''); 
        returnEl.innerHTML = data.returnTanks.length === 0 ? '<div class="empty-state">No return tanks</div>' : data.returnTanks.map(t => renderTankCard(t, 'return')).join(''); 
    }
    
    // Also render both containers for non-filtered data (jet source dropdown, etc.)
    const totals=calculateTotals(); 
    const el = (id) => document.getElementById(id);
    if(el('total-brine')) el('total-brine').textContent=totals.brine; 
    if(el('total-packer')) el('total-packer').textContent=totals.packer; 
    if(el('total-mud')) el('total-mud').textContent=totals.mud; 
    if(el('total-recirc')) el('total-recirc').textContent=totals.recirc; 
    if(el('total-freshwater')) el('total-freshwater').textContent=totals.freshwater; 
    if(el('total-other')) el('total-other').textContent=totals.other; 
    if(el('system-total')) el('system-total').textContent=totals.system+' BBL'; 
    if(el('jetted-total')) el('jetted-total').textContent=data.jetsShift+' BBL'; 
    if(el('jets-hour')) el('jets-hour').textContent=data.jetsHour; 
    if(el('transfer-shift-total')) el('transfer-shift-total').textContent=data.jetsShift+' BBL';
    
    // Update filter button active states
    ['brine','packer','mud','recirc','freshwater','other'].forEach(type => {
        const btn = el('filter-' + type);
        if (btn) btn.classList.toggle('filter-active', activeFluidFilter === type);
        const xBtn = el('xfer-filter-' + type);
        if (xBtn) xBtn.classList.toggle('filter-active', xferFluidFilter === type);
    });
    
    renderGLTotals();
    renderXferTotals();
    // Monitor display — populate two-row stat boxes from last history entry
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
    const fluidBoxColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    const last = data.history[0];
    const capUser = document.getElementById('cap-user');
    const capFluid = document.getElementById('cap-fluid');
    const capSurface = document.getElementById('cap-surface');
    const capWellbore = document.getElementById('cap-wellbore');
    const capTotal = document.getElementById('cap-total');
    const capTime = document.getElementById('cap-time');
    const elapsedEl = document.getElementById('elapsed-time');
    const appEl = document.getElementById('apparent-change');
    const truEl = document.getElementById('true-change');
    const capTransfers = document.getElementById('cap-transfers');
    const rateEl = document.getElementById('rate-per-hour');
    
    if (last) {
        // Row 1: User / Fluid / Surface / Wellbore / Total
        if (capUser) { capUser.textContent = last.initials || '--'; capUser.style.color = last.initials ? '#66bb6a' : '#888'; }
        const ft = last.filterType || null;
        if (capFluid) {
            capFluid.textContent = ft ? (fluidNames[ft] || ft) : 'System';
            capFluid.style.color = ft ? (fluidBoxColors[ft] || '#e0e0e0') : '#e0e0e0';
        }
        const surface = ft && last.totals ? (last.totals[ft] || 0) : last.systemTotal;
        if (capSurface) { capSurface.textContent = surface; capSurface.className = 'gl-value neutral'; capSurface.style.color = '#e0e0e0'; }
        if (capWellbore) { capWellbore.textContent = '--'; }
        if (capTotal) { capTotal.textContent = surface; capTotal.className = 'gl-value neutral'; capTotal.style.color = '#e0e0e0'; }
        
        // Row 2: Time / Apparent / Actual / Transfers / Hourly
        if (capTime && data.lastCheckTime) {
            const lastTime = new Date(data.lastCheckTime);
            capTime.textContent = lastTime.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
            capTime.style.color = '#4fc3f7';
            const now = new Date(), elapsedMin = Math.round((now - lastTime) / 60000);
            if (elapsedEl) {
                if (elapsedMin < 60) elapsedEl.textContent = elapsedMin + ' min ago';
                else if (elapsedMin < 1440) elapsedEl.textContent = Math.floor(elapsedMin/60) + 'h ' + elapsedMin%60 + 'm ago';
                else elapsedEl.textContent = Math.floor(elapsedMin/1440) + 'd ago';
            }
        } else if (capTime) { capTime.textContent = '--'; capTime.style.color = '#888'; if (elapsedEl) elapsedEl.textContent = ''; }
        
        if (appEl && last.apparentChange !== null) { appEl.textContent = (last.apparentChange >= 0 ? '+' : '') + last.apparentChange; appEl.className = 'gl-value ' + (last.apparentChange > 0 ? 'gain' : last.apparentChange < 0 ? 'loss' : 'neutral'); } else if (appEl) { appEl.textContent = '--'; appEl.className = 'gl-value neutral'; }
        if (truEl && last.trueChange !== null) { truEl.textContent = (last.trueChange >= 0 ? '+' : '') + last.trueChange; truEl.className = 'gl-value ' + (last.trueChange > 0 ? 'gain' : last.trueChange < 0 ? 'loss' : 'neutral'); } else if (truEl) { truEl.textContent = '--'; truEl.className = 'gl-value neutral'; }
        
        // Transfers box
        if (capTransfers) {
            const xf = last.transfersTotal || { out: 0, in: 0, build: 0 };
            const parts = [];
            if (xf.out > 0) parts.push('<span style="color:#ef5350">-' + xf.out + '</span>');
            if (xf.in > 0) parts.push('<span style="color:#4caf50">+' + xf.in + '</span>');
            if (xf.build > 0) parts.push('<span style="color:#a1887f">+' + xf.build + '</span>');
            capTransfers.innerHTML = parts.length ? parts.join(' ') : '--';
            capTransfers.style.color = parts.length ? '' : '#888';
        }
        
        if (rateEl && last.ratePerHour !== null) { const r = parseFloat(last.ratePerHour); rateEl.textContent = (r >= 0 ? '+' : '') + last.ratePerHour; rateEl.className = 'gl-value ' + (r > 0 ? 'gain' : r < 0 ? 'loss' : 'neutral'); } else if (rateEl) { rateEl.textContent = '--'; rateEl.className = 'gl-value neutral'; }
    } else {
        // No history yet
        if (capUser) { capUser.textContent = '--'; capUser.style.color = '#888'; }
        if (capFluid) { capFluid.textContent = '--'; capFluid.style.color = '#888'; }
        if (capSurface) { capSurface.textContent = '--'; }
        if (capWellbore) { capWellbore.textContent = '--'; }
        if (capTotal) { capTotal.textContent = '--'; }
        if (capTime) { capTime.textContent = '--'; capTime.style.color = '#888'; }
        if (elapsedEl) elapsedEl.textContent = '';
        if (appEl) { appEl.textContent = '--'; appEl.className = 'gl-value neutral'; }
        if (truEl) { truEl.textContent = '--'; truEl.className = 'gl-value neutral'; }
        if (capTransfers) { capTransfers.textContent = '--'; capTransfers.style.color = '#888'; }
        if (rateEl) { rateEl.textContent = '--'; rateEl.className = 'gl-value neutral'; }
    }
    // Apply GL fluid filter if active
    if (glFluidFilter) renderGLFiltered();
    // Update GL filter button highlights
    ['brine','packer','mud','recirc','freshwater','other'].forEach(t => {
        const btn = document.getElementById('gl-filter-' + t);
        if (btn) btn.classList.toggle('filter-active', glFluidFilter === t);
    });
}

function renderGLTotals() {
    const totals = calculateTotals();
    const el = (id) => document.getElementById(id);
    if(el('gl-total-brine')) el('gl-total-brine').textContent = totals.brine;
    if(el('gl-total-packer')) el('gl-total-packer').textContent = totals.packer;
    if(el('gl-total-mud')) el('gl-total-mud').textContent = totals.mud;
    if(el('gl-total-recirc')) el('gl-total-recirc').textContent = totals.recirc;
    if(el('gl-total-freshwater')) el('gl-total-freshwater').textContent = totals.freshwater;
    if(el('gl-total-other')) el('gl-total-other').textContent = totals.other;
    if(el('gl-system-total')) el('gl-system-total').textContent = totals.system + ' BBL';
    if(el('gl-jetted-total')) el('gl-jetted-total').textContent = data.jetsShift + ' BBL';
}

function showTankReport() { const totals=calculateTotals(),now=new Date(); document.getElementById('tank-report-time').textContent=now.toLocaleDateString()+' '+now.toLocaleTimeString(); let html=''; if(data.pumpTanks.length){html+='<div class="report-section"><div class="report-section-title">Pump Side</div>';data.pumpTanks.forEach(t=>{html+='<div class="report-row"><span class="report-row-label">'+t.name+'</span><span class="report-row-value">'+t.inches+'" '+(t.estimated?'(est) ':'')+'= '+t.bbls+' BBL</span></div>';});html+='</div>';} if(data.returnTanks.length){html+='<div class="report-section"><div class="report-section-title">Return Side</div>';data.returnTanks.forEach(t=>{html+='<div class="report-row"><span class="report-row-label">'+t.name+(t.contents?' ['+t.contents+']':'')+'</span><span class="report-row-value">'+t.inches+'" '+(t.estimated?'(est) ':'')+'= '+t.bbls+' BBL</span></div>';});html+='</div>';} html+='<div class="report-section"><div class="report-section-title">Totals</div><div class="report-totals"><div class="report-total-item"><div class="report-total-label">Brine</div><div class="report-total-value" style="color:#42a5f5">'+totals.brine+'</div></div><div class="report-total-item"><div class="report-total-label">Packer</div><div class="report-total-value" style="color:#ff7043">'+totals.packer+'</div></div><div class="report-total-item"><div class="report-total-label">Mud</div><div class="report-total-value" style="color:#a1887f">'+totals.mud+'</div></div><div class="report-total-item"><div class="report-total-label">Recirc</div><div class="report-total-value" style="color:#ba68c8">'+totals.recirc+'</div></div><div class="report-total-item"><div class="report-total-label">Fresh</div><div class="report-total-value" style="color:#4db6ac">'+totals.freshwater+'</div></div><div class="report-total-item"><div class="report-total-label">Other</div><div class="report-total-value" style="color:#90a4ae">'+totals.other+'</div></div></div></div>'; html+='<div class="report-system-totals"><div class="report-system-box total"><div class="report-system-label">System Total</div><div class="report-system-value">'+totals.system+' BBL</div></div><div class="report-system-box jetted"><div class="report-system-label">Jetted (Shift)</div><div class="report-system-value">'+data.jetsShift+' BBL</div></div></div>'; html+='<div class="report-timestamp">'+now.toLocaleString()+'</div>'; document.getElementById('tank-report-content').innerHTML=html; document.getElementById('tank-report').classList.add('show'); }
function hideTankReport() { document.getElementById('tank-report').classList.remove('show'); }
function showTitrationReport() { const names={aphron:'Aphron',brine:'Brine',recirc:'Recirc',freshwater:'Freshwater'}; const locText = sampleLocation === 'out' ? 'Discharge (Out)' : 'Pump Side (In)'; const locColor = sampleLocation === 'out' ? '#ff7043' : '#42a5f5'; document.getElementById('tit-report-fluid').textContent=names[titData.fluidType]||titData.fluidType; const cl=document.getElementById('tit-chlorides').textContent,ha=document.getElementById('tit-hardness').textContent,ca=document.getElementById('tit-calcium').textContent,mg=document.getElementById('tit-magnesium').textContent; const surfaceVol=getSurfaceVolumeForFluid(titData.fluidType); let html='<div class="report-section"><div class="report-section-title">Sample Info</div><div class="report-row"><span class="report-row-label">Sample Location</span><span class="report-row-value" style="color:'+locColor+'">'+locText+'</span></div><div class="report-row"><span class="report-row-label">Fluid Type</span><span class="report-row-value">'+(names[titData.fluidType]||titData.fluidType)+'</span></div></div>'; html+='<div class="report-section"><div class="report-section-title">Basic Properties</div><div class="report-row"><span class="report-row-label">Viscosity</span><span class="report-row-value">'+(titData.viscosity||'--')+' sec</span></div><div class="report-row"><span class="report-row-label">Density</span><span class="report-row-value">'+(titData.density||'--')+' ppg</span></div><div class="report-row"><span class="report-row-label">pH</span><span class="report-row-value">'+(titData.ph||'--')+'</span></div><div class="report-row"><span class="report-row-label">PF</span><span class="report-row-value">'+(titData.pf||'--')+'</span></div><div class="report-row"><span class="report-row-label">MF</span><span class="report-row-value">'+(titData.mf||'--')+'</span></div></div>'; html+='<div class="report-section"><div class="report-section-title">Chemical Analysis</div><div class="report-row"><span class="report-row-label">Chlorides</span><span class="report-row-value">'+cl+' ppm</span></div><div class="report-row"><span class="report-row-label">Calcium</span><span class="report-row-value">'+ca+' ppm</span></div><div class="report-row"><span class="report-row-label">Total Hardness</span><span class="report-row-value">'+ha+' ppm</span></div><div class="report-row"><span class="report-row-label">Magnesium</span><span class="report-row-value">'+mg+' ppm</span></div></div>'; const pvText=document.getElementById('tit-pv').textContent; const ypText=document.getElementById('tit-yp').textContent; html+='<div class="report-section"><div class="report-section-title">Rheology</div><div class="report-row"><span class="report-row-label">600 RPM</span><span class="report-row-value">'+(titData.r600||'--')+'</span></div><div class="report-row"><span class="report-row-label">300 RPM</span><span class="report-row-value">'+(titData.r300||'--')+'</span></div><div class="report-row"><span class="report-row-label">200 RPM</span><span class="report-row-value">'+(titData.r200||'--')+'</span></div><div class="report-row"><span class="report-row-label">100 RPM</span><span class="report-row-value">'+(titData.r100||'--')+'</span></div><div class="report-row"><span class="report-row-label">6 RPM</span><span class="report-row-value">'+(titData.r6||'--')+'</span></div><div class="report-row"><span class="report-row-label">3 RPM</span><span class="report-row-value">'+(titData.r3||'--')+'</span></div><div class="report-row"><span class="report-row-label">PV</span><span class="report-row-value">'+pvText+' cP</span></div><div class="report-row"><span class="report-row-label">YP</span><span class="report-row-value">'+ypText+' lb/100ft²</span></div><div class="report-row"><span class="report-row-label">10-sec Gel</span><span class="report-row-value">'+(titData.gel10s||'--')+' lb/100ft²</span></div><div class="report-row"><span class="report-row-label">10-min Gel</span><span class="report-row-value">'+(titData.gel10m||'--')+' lb/100ft²</span></div></div>'; html+='<div class="report-section"><div class="report-section-title">Volume</div><div class="report-row"><span class="report-row-label">Surface Volume ('+names[titData.fluidType]+')</span><span class="report-row-value">'+surfaceVol+' bbl</span></div></div>'; html+='<div class="report-timestamp">'+new Date().toLocaleString()+'</div>'; document.getElementById('tit-report-content').innerHTML=html; document.getElementById('titration-report').classList.add('show'); }
function hideTitrationReport() { document.getElementById('titration-report').classList.remove('show'); }

// Titration log
let titrationLog = [];
let sampleLocation = 'in'; // 'in' = pump side, 'out' = discharge
function setSampleLocation(loc) {
    sampleLocation = loc;
    const inBtn = document.getElementById('sample-in-btn');
    const outBtn = document.getElementById('sample-out-btn');
    if(loc === 'in') {
        inBtn.style.background = '#1565c0'; inBtn.style.color = 'white';
        outBtn.style.background = 'transparent'; outBtn.style.color = 'rgba(255,255,255,0.4)';
    } else {
        outBtn.style.background = '#e65100'; outBtn.style.color = 'white';
        inBtn.style.background = 'transparent'; inBtn.style.color = 'rgba(255,255,255,0.4)';
    }
}
function loadTitrationLog() { const s = localStorage.getItem('ipsTitrationLog'); if(s) titrationLog = JSON.parse(s); }
function saveTitrationLog() { localStorage.setItem('ipsTitrationLog', JSON.stringify(titrationLog)); firebaseSaveTitrationLog(); }
function logTitration() {
    const names = {aphron:'Aphron',brine:'Brine',recirc:'Recirc',freshwater:'Fresh'};
    const hardness = document.getElementById('tit-hardness').textContent;
    const calcium = document.getElementById('tit-calcium').textContent;
    const magnesium = document.getElementById('tit-magnesium').textContent;
    const hasFullTitration = hardness !== '--' && calcium !== '--';
    const entry = {
        time: new Date().toISOString(),
        initials: profileData.initials || '',
        sampleLocation: sampleLocation,
        fluidType: titData.fluidType,
        fluidName: names[titData.fluidType] || titData.fluidType,
        viscosity: titData.viscosity,
        density: titData.density,
        ph: titData.ph,
        chlorides: document.getElementById('tit-chlorides').textContent,
        calcium: calcium,
        hardness: hardness,
        magnesium: magnesium,
        fullTitration: hasFullTitration,
        surfaceVol: getSurfaceVolumeForFluid(titData.fluidType),
        r600: titData.r600, r300: titData.r300, r200: titData.r200, r100: titData.r100, r6: titData.r6, r3: titData.r3,
        pv: document.getElementById('tit-pv').textContent,
        yp: document.getElementById('tit-yp').textContent,
        gel10s: titData.gel10s, gel10m: titData.gel10m
    };
    titrationLog.unshift(entry);
    saveTitrationLog();
    renderTitrationLog();
    alert('Titration logged!\n' + entry.fluidName + ' @ ' + new Date().toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) + (hasFullTitration ? ' (Full)' : ''));
}
function renderTitrationLog() {
    const el = document.getElementById('titration-log-content');
    if (!titrationLog || !titrationLog.length) {
        el.innerHTML = '<em style="color:#666">No titrations logged</em>';
        return;
    }
    const fluidColors = {aphron:'#a1887f',brine:'#42a5f5',recirc:'#ba68c8',freshwater:'#4db6ac',fresh:'#4db6ac'};
    el.innerHTML = titrationLog.slice(0, 20).map(log => {
        const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const fluidColor = fluidColors[log.fluidType] || '#ba68c8';
        const initials = log.initials ? '<span style="color:#66bb6a;font-weight:600">' + log.initials + '</span> &nbsp; ' : '';
        const locLabel = log.sampleLocation === 'out' ? '<span style="color:#ff7043;font-weight:600;font-size:9px;background:rgba(255,112,67,0.2);padding:1px 4px;border-radius:3px">OUT</span>' : '<span style="color:#42a5f5;font-weight:600;font-size:9px;background:rgba(66,165,245,0.2);padding:1px 4px;border-radius:3px">IN</span>';
        // Line 1: User / Time / Fluid / In or Out
        let line1 = initials + '<span style="color:#4fc3f7">' + t + '</span> &nbsp; <span style="color:' + fluidColor + '">' + log.fluidName + '</span> &nbsp; ' + locLabel;
        // Line 2: Weight / Viscosity / Chemistry
        let parts = [];
        if (log.density) parts.push('<span style="color:#ffa726">' + log.density + '#</span>');
        if (log.viscosity) parts.push('<span style="color:#888">' + log.viscosity + 's</span>');
        if (log.fullTitration) {
            parts.push('<span style="color:#42a5f5">Cl:' + log.chlorides + '</span>');
            parts.push('<span style="color:#26a69a">Ca:' + log.calcium + '</span>');
            parts.push('<span style="color:#ab47bc">H:' + log.hardness + '</span>');
            parts.push('<span style="color:#66bb6a">Mg:' + (log.magnesium || '--') + '</span>');
        }
        if (log.pv && log.pv !== '--') parts.push('<span style="color:#ef5350">PV:' + log.pv + '</span>');
        if (log.yp && log.yp !== '--') parts.push('<span style="color:#ffca28">YP:' + log.yp + '</span>');
        if (log.gel10s) parts.push('<span style="color:#78909c">G10s:' + log.gel10s + '</span>');
        if (log.gel10m) parts.push('<span style="color:#78909c">G10m:' + log.gel10m + '</span>');
        let line2 = parts.length ? parts.join(' &nbsp; ') : '<span style="color:#666">--</span>';
        return '<div style="padding:6px 0;border-bottom:1px solid #2d4a6f">' +
            '<div style="font-size:11px">' + line1 + '</div>' +
            '<div style="font-size:10px;padding-left:2px;margin-top:3px">' + line2 + '</div>' +
            '</div>';
    }).join('');
}
function resetTitrationLog() { if(confirm('Clear titration history?')) { titrationLog = []; saveTitrationLog(); renderTitrationLog(); } }

// Reset functions
function resetGainLoss() { 
    if(confirm('Reset gain/loss data?\n\nThis will clear the last check time, history, and jets this hour.')) { 
        data.lastSystemTotal = null; 
        data.lastCheckTime = null; 
        data.jetsHour = 0;
        data.history = []; 
        saveData(); 
        render(); 
    } 
}
function resetTransferLog() { if(confirm('Clear transfer log?')) { data.transferLog = []; saveData(); renderTransferLog(); } }

// Transfer log rendering
function renderTransferLog() {
    const el = document.getElementById('transfer-log-content');
    if (!data.transferLog || !data.transferLog.length) { 
        el.innerHTML = '<em style="color:#666">No transfers logged</em>'; 
        return; 
    }
    el.innerHTML = data.transferLog.slice(0, 50).map(log => {
        const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const initials = log.initials ? '<span style="color:#66bb6a;font-weight:600">' + log.initials + '</span> &nbsp; ' : '';
        if (log.type === 'build') {
            const batchInfo = log.batches > 1 ? log.batches + '×' + log.perBatch : log.volume;
            return '<div style="font-size:11px;padding:4px 0;border-bottom:1px solid #2d4a6f">' + initials + '<span style="color:#4fc3f7">' + t + '</span> &nbsp; <span style="color:#a1887f;font-weight:600">BUILD</span> &nbsp; ' + batchInfo + ' BBL &nbsp; → ' + log.tanks.join(', ') + '</div>';
        }
        const typeColor = log.type === 'out' ? '#ef5350' : '#4caf50';
        return '<div style="font-size:11px;padding:4px 0;border-bottom:1px solid #2d4a6f">' + initials + '<span style="color:#4fc3f7">' + t + '</span> &nbsp; <span style="color:' + typeColor + '">' + (log.type === 'out' ? 'OUT' : 'IN') + '</span> &nbsp; ' + log.volume + ' BBL &nbsp; ' + log.tanks.join(', ') + '</div>';
    }).join('');
}

function renderVolumeLog() {
    const el = document.getElementById('volume-log-content');
    if (!el) return;
    if (!data.history || !data.history.length) {
        el.innerHTML = '<em style="color:#666">No volume checks logged</em>';
        return;
    }
    const fluidLabels = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
    const fluidColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    
    let html = '<table style="width:100%;border-collapse:collapse;font-size:10px">';
    // Header row 1: User / Fluid / Surface / Wellbore / Total
    html += '<tr style="color:#555;font-size:8px;text-transform:uppercase">' +
        '<td style="padding:2px 2px" rowspan="2">User<br>Time</td>' +
        '<td style="padding:2px 2px">Fluid</td>' +
        '<td style="padding:2px 2px;text-align:right">Surface</td>' +
        '<td style="padding:2px 2px;text-align:right">Wellbore</td>' +
        '<td style="padding:2px 2px;text-align:right">Total</td></tr>';
    // Header row 2: Apparent / Actual / Transfers / Hourly
    html += '<tr style="color:#555;font-size:8px;text-transform:uppercase;border-bottom:1px solid #2d4a6f">' +
        '<td style="padding:0 2px 3px">Apparent</td>' +
        '<td style="padding:0 2px 3px;text-align:right">Actual</td>' +
        '<td style="padding:0 2px 3px;text-align:right">Transfers</td>' +
        '<td style="padding:0 2px 3px;text-align:right">Hourly</td></tr>';
    
    data.history.slice(0, 30).forEach((h, idx) => {
        const t = new Date(h.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const initials = h.initials || '';
        
        // Determine fluid type for this entry
        const ft = h.filterType || null;
        const fluidName = ft ? (fluidLabels[ft] || ft) : 'System';
        const fluidClr = ft ? (fluidColors[ft] || '#e0e0e0') : '#e0e0e0';
        
        // Surface = fluid type total (or system total)
        let surface = h.systemTotal;
        if (ft && h.totals && h.totals[ft] !== undefined) {
            surface = h.totals[ft];
        }
        
        const wellbore = '--';
        const total = surface;
        
        // === APPARENT: compare to previous entry's total for this type ===
        const prevEntry = (idx < data.history.length - 1) ? data.history[idx + 1] : null;
        let apparent = null, actual = null;
        
        if (ft) {
            const prevTypeTotal = prevEntry && prevEntry.totals ? (prevEntry.totals[ft] || 0) : null;
            if (prevTypeTotal !== null) {
                apparent = surface - prevTypeTotal;
                const xf = h.transfersByType && h.transfersByType[ft] 
                    ? h.transfersByType[ft] : { out: 0, in: 0, build: 0 };
                actual = apparent + xf.out - xf.in - xf.build;
            }
        } else {
            apparent = h.apparentChange;
            actual = h.trueChange;
        }
        
        // === TRANSFERS display ===
        let transferStr = '<span style="color:#888">--</span>';
        if (h.transfersByType || h.transfersTotal) {
            const xf = ft 
                ? (h.transfersByType && h.transfersByType[ft] ? h.transfersByType[ft] : null) 
                : h.transfersTotal;
            if (xf) {
                const parts = [];
                if (xf.out > 0) parts.push('<span style="color:#ef5350">OUT&nbsp;' + xf.out + '</span>');
                if (xf.in > 0) parts.push('<span style="color:#4caf50">IN&nbsp;' + xf.in + '</span>');
                if (xf.build > 0) parts.push('<span style="color:#a1887f">BLD&nbsp;' + xf.build + '</span>');
                if (parts.length) transferStr = parts.join('<br>');
            }
        } else if (h.jetsHour && h.jetsHour > 0) {
            transferStr = '<span style="color:#ef5350">OUT&nbsp;' + h.jetsHour + '</span>';
        }
        
        // === HOURLY RATE ===
        let hourly = '<span style="color:#888">--</span>';
        if (actual !== null && h.elapsedMin && h.elapsedMin > 0) {
            const r = ((actual / h.elapsedMin) * 60).toFixed(1);
            const rClr = parseFloat(r) > 0 ? '#4caf50' : parseFloat(r) < 0 ? '#ef5350' : '#888';
            hourly = '<span style="color:' + rClr + '">' + (parseFloat(r) >= 0 ? '+' : '') + r + '</span>';
        }
        
        const fmtGL = (v) => {
            if (v === null) return '<span style="color:#888">--</span>';
            const clr = v > 0 ? '#4caf50' : v < 0 ? '#ef5350' : '#888';
            return '<span style="color:' + clr + '">' + (v >= 0 ? '+' : '') + v + '</span>';
        };
        
        // ROW 1: [User+Time rowspan] / Fluid / Surface / Wellbore / Total
        html += '<tr style="border-top:1px solid #2d4a6f">' +
            '<td rowspan="2" style="padding:4px 2px;white-space:nowrap;vertical-align:middle">' +
                (initials ? '<div style="color:#66bb6a;font-weight:600;font-size:11px">' + initials + '</div>' : '') +
                '<div style="color:#4fc3f7;font-size:10px">' + t + '</div></td>' +
            '<td style="padding:3px 2px;color:' + fluidClr + ';font-weight:600">' + fluidName + '</td>' +
            '<td style="padding:3px 2px;text-align:right;color:#e0e0e0">' + surface + '</td>' +
            '<td style="padding:3px 2px;text-align:right;color:#555">' + wellbore + '</td>' +
            '<td style="padding:3px 2px;text-align:right;color:#e0e0e0;font-weight:600">' + total + '</td></tr>';
        
        // ROW 2: Apparent / Actual / Transfers / Hourly
        html += '<tr>' +
            '<td style="padding:0 2px 3px">' + fmtGL(apparent) + '</td>' +
            '<td style="padding:0 2px 3px;text-align:right">' + fmtGL(actual) + '</td>' +
            '<td style="padding:0 2px 3px;text-align:right;font-size:9px">' + transferStr + '</td>' +
            '<td style="padding:0 2px 3px;text-align:right">' + hourly + '</td></tr>';
        // ROW 3 (optional): Per-fluid breakdown for system captures
        if (!ft && h.fluidBreakdown) {
            const changed = Object.keys(h.fluidBreakdown).filter(f => h.fluidBreakdown[f].apparent !== null && h.fluidBreakdown[f].apparent !== 0);
            if (changed.length) {
                html += '<tr><td colspan="5" style="padding:1px 2px 4px;font-size:9px">' + changed.map(f => {
                    const fb = h.fluidBreakdown[f];
                    const c = fb.apparent > 0 ? '#4caf50' : fb.apparent < 0 ? '#ef5350' : '#888';
                    return '<span style="color:' + fluidColors[f] + '">' + (fluidLabels[f]||f) + '</span> <span style="color:' + c + '">' + (fb.apparent >= 0 ? '+' : '') + fb.apparent + '</span>';
                }).join(' &nbsp; ') + '</td></tr>';
            }
        }
    });
    html += '</table>';
    el.innerHTML = html;
}

function clearVolumeLog() {
    if (confirm('Clear volume log?')) {
        data.history = [];
        data.lastCheckTime = null;
        data.lastSystemTotal = null;
        saveData();
        render();
        renderVolumeLog();
    }
}

// Transfer Report
function showTransferReport() {
    const now = new Date();
    document.getElementById('transfer-report-time').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    let html = '<div class="report-section"><div class="report-section-title">Shift Summary</div>';
    html += '<div class="report-row"><span class="report-row-label">Total Jetted</span><span class="report-row-value" style="color:#ffa726">' + data.jetsShift + ' BBL</span></div>';
    html += '<div class="report-row"><span class="report-row-label">Jets This Hour</span><span class="report-row-value">' + data.jetsHour + ' BBL</span></div></div>';
    if (data.transferLog && data.transferLog.length) {
        html += '<div class="report-section"><div class="report-section-title">Transfer Log</div>';
        data.transferLog.forEach(log => {
            const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            if (log.type === 'build') {
                const batchInfo = log.batches > 1 ? log.batches + '×' + log.perBatch : log.volume;
                html += '<div class="report-row"><span class="report-row-label">' + t + ' - BUILD → ' + log.tanks.join(', ') + '</span><span class="report-row-value" style="color:#a1887f">+' + batchInfo + ' BBL</span></div>';
            } else {
                const typeColor = log.type === 'out' ? '#ef5350' : '#4caf50';
                html += '<div class="report-row"><span class="report-row-label">' + t + ' - ' + log.tanks.join(', ') + '</span><span class="report-row-value" style="color:' + typeColor + '">' + (log.type === 'out' ? '-' : '+') + log.volume + ' BBL</span></div>';
            }
        });
        html += '</div>';
    }
    html += '<div class="report-timestamp">' + now.toLocaleString() + '</div>';
    document.getElementById('transfer-report-content').innerHTML = html;
    document.getElementById('transfer-report').classList.add('show');
}
function hideTransferReport() { document.getElementById('transfer-report').classList.remove('show'); }

// Turnover Report
function showTurnoverReport() {
    const now = new Date();
    const totals = calculateTotals();
    document.getElementById('turnover-report-time').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    
    let html = '<div class="report-company">SHIFT TURNOVER</div>';
    
    // Tank Summary
    html += '<div class="report-section"><div class="report-section-title">Tank Volumes</div>';
    if(data.pumpTanks.length) {
        html += '<div style="font-size:10px;color:#4fc3f7;margin:8px 0 4px">Pump Side</div>';
        data.pumpTanks.forEach(t => { html += '<div class="report-row"><span class="report-row-label">' + t.name + '</span><span class="report-row-value">' + t.bbls + ' BBL</span></div>'; });
    }
    if(data.returnTanks.length) {
        html += '<div style="font-size:10px;color:#4fc3f7;margin:8px 0 4px">Return Side</div>';
        data.returnTanks.forEach(t => { html += '<div class="report-row"><span class="report-row-label">' + t.name + (t.contents ? ' [' + t.contents + ']' : '') + '</span><span class="report-row-value">' + t.bbls + ' BBL</span></div>'; });
    }
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;justify-content:space-around">';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Brine</div><div style="font-size:15px;font-weight:700;color:#42a5f5">' + totals.brine + '</div></div>';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Packer</div><div style="font-size:15px;font-weight:700;color:#ff7043">' + totals.packer + '</div></div>';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Mud</div><div style="font-size:15px;font-weight:700;color:#a1887f">' + totals.mud + '</div></div>';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Recirc</div><div style="font-size:15px;font-weight:700;color:#ba68c8">' + totals.recirc + '</div></div>';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Fresh</div><div style="font-size:15px;font-weight:700;color:#4db6ac">' + totals.freshwater + '</div></div>';
    html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">Other</div><div style="font-size:15px;font-weight:700;color:#90a4ae">' + totals.other + '</div></div>';
    html += '</div>';
    html += '<div style="display:flex;gap:10px;margin-top:10px">';
    html += '<div style="flex:1;background:#0d1b2a;padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">SYSTEM TOTAL</div><div style="font-size:18px;font-weight:700">' + totals.system + ' BBL</div></div>';
    html += '<div style="flex:1;background:#e65100;padding:10px;border-radius:6px;text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.8)">JETTED (SHIFT)</div><div style="font-size:18px;font-weight:700;color:white">' + data.jetsShift + ' BBL</div></div>';
    html += '</div></div>';
    
    // Injection Status
    html += '<div class="report-section"><div class="report-section-title">Chemical Injection</div>';
    html += '<div class="report-row"><span class="report-row-label">Pump Rate</span><span class="report-row-value">' + (injData.pumpRate || '--') + ' BPM</span></div>';
    if (injData.pumpRate && injData.frTreat) {
        const frTarget = PUMP_CHART[injData.pumpRate][parseFloat(injData.frTreat)];
        html += '<div class="report-row"><span class="report-row-label">Friction Reducer</span><span class="report-row-value" style="color:#66bb6a">' + TREAT_LABELS[parseFloat(injData.frTreat)] + '/10bbl → ' + frTarget.toFixed(3) + ' GPM</span></div>';
    }
    if (injData.pumpRate && injData.lubeTreat) {
        const lubeTarget = PUMP_CHART[injData.pumpRate][parseFloat(injData.lubeTreat)];
        html += '<div class="report-row"><span class="report-row-label">Pipe Lube</span><span class="report-row-value" style="color:#ffa726">' + TREAT_LABELS[parseFloat(injData.lubeTreat)] + '/10bbl → ' + lubeTarget.toFixed(3) + ' GPM</span></div>';
    }
    html += '</div>';
    
    // Transfer Log
    html += '<div class="report-section"><div class="report-section-title">Fluid Transfers</div>';
    if (data.transferLog && data.transferLog.length) {
        data.transferLog.slice(0, 10).forEach(log => {
            const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            if (log.type === 'build') {
                const batchInfo = log.batches > 1 ? log.batches + '×' + log.perBatch : log.volume;
                html += '<div class="report-row"><span class="report-row-label">' + t + ' BUILD → ' + log.tanks.join(', ') + '</span><span class="report-row-value" style="color:#a1887f">+' + batchInfo + ' BBL</span></div>';
            } else {
                const typeColor = log.type === 'out' ? '#ef5350' : '#4caf50';
                html += '<div class="report-row"><span class="report-row-label">' + t + ' - ' + log.tanks.join(', ') + '</span><span class="report-row-value" style="color:' + typeColor + '">' + (log.type === 'out' ? '-' : '+') + log.volume + ' BBL</span></div>';
            }
        });
    } else {
        html += '<div style="color:#666;font-size:12px;text-align:center;padding:10px">No transfers this shift</div>';
    }
    html += '</div>';
    
    // Gain/Loss - Volume Log
    html += '<div class="report-section"><div class="report-section-title">Volume Log</div>';
    if (data.history && data.history.length) {
        const fluidLabels = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
        data.history.slice(0, 10).forEach(h => {
            const t = new Date(h.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const changeColor = h.trueChange > 0 ? '#4caf50' : h.trueChange < 0 ? '#ef5350' : '#888';
            let tankInfo = '';
            if (h.tankChanges && h.tankChanges.length) {
                tankInfo = h.tankChanges.map(tc => {
                    const clr = tc.delta > 0 ? '#4caf50' : tc.delta < 0 ? '#ef5350' : '#888';
                    return '<span style="color:' + clr + '">' + tc.name + '</span>';
                }).join(', ');
            }
            let fluidInfo = '';
            if (h.tankChanges && h.tankChanges.length && h.totals) {
                const changedFluids = [...new Set(h.tankChanges.map(tc => tc.fluid).filter(Boolean))];
                if (changedFluids.length) {
                    fluidInfo = changedFluids.map(f => (fluidLabels[f]||f) + ' ' + (h.totals[f]!==undefined?h.totals[f]:'?')).join(', ');
                }
            }
            let rightSide = '';
            if (h.trueChange !== null) rightSide += '<span style="color:' + changeColor + '">' + (h.trueChange >= 0 ? '+' : '') + h.trueChange + '</span>';
            if (h.ratePerHour) rightSide += ' <span style="color:' + changeColor + '">(' + h.ratePerHour + '/hr)</span>';
            html += '<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
            html += '<div class="report-row"><span class="report-row-label">' + t + (tankInfo ? ' &nbsp;' + tankInfo : '') + '</span><span class="report-row-value">' + (rightSide || '--') + '</span></div>';
            if (fluidInfo) html += '<div style="font-size:10px;color:#888;padding-left:4px">' + fluidInfo + '</div>';
            html += '</div>';
        });
    } else {
        html += '<div style="color:#666;font-size:12px;text-align:center;padding:10px">No volume checks this shift</div>';
    }
    html += '</div>';
    
    // Titration Log
    html += '<div class="report-section"><div class="report-section-title">Titration Log</div>';
    if (titrationLog && titrationLog.length) {
        titrationLog.slice(0, 10).forEach(log => {
            const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            let details = '<span style="color:#ffa726">' + (log.density ? log.density + '#' : '') + '</span>';
            if (log.viscosity) details += ' <span style="color:#888">' + log.viscosity + 's</span>';
            const locBadge = log.sampleLocation === 'out' ? '<span style="color:#ff7043;font-size:9px;font-weight:600">OUT</span>' : '<span style="color:#42a5f5;font-size:9px;font-weight:600">IN</span>';
            html += '<div class="report-row"><span class="report-row-label">' + t + ' ' + locBadge + ' - ' + log.fluidName + '</span><span class="report-row-value">' + details + '</span></div>';
            if (log.fullTitration) {
                html += '<div style="font-size:10px;padding-left:4px;color:#888">';
                html += 'Cl: <span style="color:#42a5f5">' + log.chlorides + '</span> &nbsp; ';
                html += 'Ca: <span style="color:#26a69a">' + log.calcium + '</span> &nbsp; ';
                html += 'H: <span style="color:#ab47bc">' + log.hardness + '</span> &nbsp; ';
                html += 'Mg: <span style="color:#66bb6a">' + (log.magnesium || '--') + '</span>';
                html += '</div>';
            }
        });
    } else {
        html += '<div style="color:#666;font-size:12px;text-align:center;padding:10px">No titrations this shift</div>';
    }
    html += '</div>';
    
    html += '<div class="report-timestamp">Generated: ' + now.toLocaleString() + '</div>';
    document.getElementById('turnover-report-content').innerHTML = html;
    // Restore any previously entered notes
    const notesEl = document.getElementById('turnover-notes');
    if (notesEl && notesEl._savedValue) notesEl.value = notesEl._savedValue;
    document.getElementById('turnover-report').classList.add('show');
}
function hideTurnoverReport() { 
    // Save notes value so it persists if reopened
    const notesEl = document.getElementById('turnover-notes');
    if (notesEl) notesEl._savedValue = notesEl.value;
    document.getElementById('turnover-report').classList.remove('show'); 
}
function sendTurnoverReport() {
    const content = document.getElementById('turnover-report-content');
    const btn = document.querySelector('#turnover-report [onclick="sendTurnoverReport()"]');
    const origText = btn.textContent;
    btn.textContent = '⏳ Generating...';
    btn.disabled = true;
    
    // Create a wrapper div with proper background for the screenshot
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position:absolute;left:-9999px;top:0;width:400px;background:#1b2838;padding:16px;color:#e0e0e0;font-family:-apple-system,BlinkMacSystemFont,sans-serif';
    // Add header
    const header = document.createElement('div');
    header.style.cssText = 'text-align:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #2d4a6f';
    header.innerHTML = '<div style="font-size:16px;font-weight:700;color:#4fc3f7">SHIFT TURNOVER REPORT</div><div style="font-size:11px;color:#888;margin-top:4px">' + new Date().toLocaleString() + '</div>';
    wrapper.appendChild(header);
    // Clone content
    const clone = content.cloneNode(true);
    wrapper.appendChild(clone);
    // Add turnover notes if entered
    const notesVal = (document.getElementById('turnover-notes') || {}).value || '';
    if (notesVal.trim()) {
        const notesDiv = document.createElement('div');
        notesDiv.style.cssText = 'margin-top:10px;padding:10px;background:#0d1b2a;border:1px solid #2d4a6f;border-radius:6px';
        notesDiv.innerHTML = '<div style="font-size:10px;color:#4fc3f7;text-transform:uppercase;font-weight:600;margin-bottom:6px">Turnover Notes</div><div style="font-size:12px;color:#e0e0e0;white-space:pre-wrap">' + notesVal.replace(/</g,'&lt;') + '</div>';
        wrapper.appendChild(notesDiv);
    }
    // Add footer
    const footer = document.createElement('div');
    footer.style.cssText = 'text-align:center;margin-top:12px;padding-top:8px;border-top:1px solid #2d4a6f;font-size:9px;color:#666';
    footer.textContent = 'IPS Fluid Tracker — ' + (profileData.name || 'Report');
    wrapper.appendChild(footer);
    document.body.appendChild(wrapper);
    
    html2canvas(wrapper, {
        backgroundColor: '#1b2838',
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        document.body.removeChild(wrapper);
        canvas.toBlob(blob => {
            const file = new File([blob], 'shift-turnover-' + Date.now() + '.png', { type: 'image/png' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    title: 'Shift Turnover Report',
                    files: [file]
                }).then(() => {
                    hideTurnoverReport();
                }).catch(() => {
                    // Share cancelled, fallback to download
                    downloadImage(canvas);
                    hideTurnoverReport();
                });
            } else {
                // No share API, download directly
                downloadImage(canvas);
                hideTurnoverReport();
            }
            btn.textContent = origText;
            btn.disabled = false;
        }, 'image/png');
    }).catch(err => {
        console.error('Screenshot failed:', err);
        document.body.removeChild(wrapper);
        btn.textContent = origText;
        btn.disabled = false;
        // Fallback to text share
        sendTurnoverReportText();
    });
}

function downloadImage(canvas) {
    const link = document.createElement('a');
    link.download = 'shift-turnover-' + Date.now() + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    alert('Report image saved!');
}

function sendTurnoverReportText() {
    // Fallback text version
    const totals = calculateTotals();
    const now = new Date();
    let text = '📋 SHIFT TURNOVER REPORT\n';
    text += now.toLocaleString() + '\n\n';
    text += '=== TANK VOLUMES ===\n';
    if(data.pumpTanks.length) { text += 'PUMP SIDE:\n'; data.pumpTanks.forEach(t => { text += '  ' + t.name + ': ' + t.bbls + ' BBL\n'; }); }
    if(data.returnTanks.length) { text += 'RETURN SIDE:\n'; data.returnTanks.forEach(t => { text += '  ' + t.name + (t.contents ? ' ['+t.contents+']' : '') + ': ' + t.bbls + ' BBL\n'; }); }
    text += '\nSYSTEM TOTAL: ' + totals.system + ' BBL\n';
    text += 'JETTED (SHIFT): ' + data.jetsShift + ' BBL\n\n';
    text += '=== INJECTION ===\n';
    text += 'Pump Rate: ' + (injData.pumpRate || '--') + ' BPM\n';
    if(injData.pumpRate && injData.frTreat) { const fr = PUMP_CHART[injData.pumpRate][parseFloat(injData.frTreat)]; text += 'FR: ' + TREAT_LABELS[parseFloat(injData.frTreat)] + '/10bbl → ' + fr.toFixed(3) + ' GPM\n'; }
    if(injData.pumpRate && injData.lubeTreat) { const lb = PUMP_CHART[injData.pumpRate][parseFloat(injData.lubeTreat)]; text += 'Lube: ' + TREAT_LABELS[parseFloat(injData.lubeTreat)] + '/10bbl → ' + lb.toFixed(3) + ' GPM\n'; }
    if(data.history && data.history.length) {
        text += '\n=== VOLUME LOG ===\n';
        const fluidLabels = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
        data.history.slice(0, 10).forEach(h => {
            const t = new Date(h.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            let tanks = '';
            if (h.tankChanges && h.tankChanges.length) { tanks = ' [' + h.tankChanges.map(tc => tc.name).join(', ') + ']'; }
            text += t + ':' + tanks + ' True ' + (h.trueChange!==null ? ((h.trueChange >= 0 ? '+' : '') + h.trueChange + ' bbl') : '--') + (h.ratePerHour ? ' (' + h.ratePerHour + '/hr)' : '') + '\n';
        });
    }
    if(titrationLog && titrationLog.length) {
        text += '\n=== TITRATION LOG ===\n';
        titrationLog.slice(0, 10).forEach(log => {
            const t = new Date(log.time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            text += t + ' [' + (log.sampleLocation === 'out' ? 'OUT' : 'IN') + '] ' + log.fluidName + ': ' + (log.density ? log.density + '#' : '') + (log.viscosity ? ' ' + log.viscosity + 's' : '');
            if (log.fullTitration) { text += ' Cl:' + log.chlorides + ' Ca:' + log.calcium + ' H:' + log.hardness + ' Mg:' + (log.magnesium || '--'); }
            text += '\n';
        });
    }
    if(navigator.share) {
        navigator.share({ title: 'Shift Turnover', text: text }).catch(() => {});
    } else {
        navigator.clipboard.writeText(text).then(() => alert('Report copied to clipboard!')).catch(() => alert('Could not copy report'));
    }
    hideTurnoverReport();
}

// Start New Shift
function showMonitorReport() {
    const now = new Date();
    const totals = calculateTotals();
    const fluidLabels = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
    const fluidColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    document.getElementById('monitor-report-time').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    
    let html = '<div class="report-company">VOLUME MONITOR LOG</div>';
    
    // Current totals summary
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;justify-content:space-around">';
    ['brine','packer','mud','recirc','freshwater','other'].forEach(ft => {
        if (totals[ft] > 0) html += '<div style="text-align:center;padding:6px 8px;border-radius:6px;min-width:48px;background:#0d1b2a"><div style="font-size:8px;color:#888;text-transform:uppercase;font-weight:600">' + fluidLabels[ft] + '</div><div style="font-size:15px;font-weight:700;color:' + fluidColors[ft] + '">' + totals[ft] + '</div></div>';
    });
    html += '</div>';
    html += '<div style="display:flex;gap:10px;margin-bottom:12px">';
    html += '<div style="flex:1;background:#0d1b2a;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:#888">SYSTEM TOTAL</div><div style="font-size:16px;font-weight:700">' + totals.system + ' BBL</div></div>';
    html += '<div style="flex:1;background:#e65100;padding:8px;border-radius:6px;text-align:center"><div style="font-size:9px;color:rgba(255,255,255,0.8)">JETTED (SHIFT)</div><div style="font-size:16px;font-weight:700;color:white">' + data.jetsShift + ' BBL</div></div>';
    html += '</div>';
    
    // Volume log table — mirrors exactly what's on the monitor tab
    html += '<div class="report-section"><div class="report-section-title">Volume Log</div>';
    if (data.history && data.history.length) {
        html += '<table style="width:100%;border-collapse:collapse;font-size:10px">';
        html += '<tr style="color:#555;font-size:8px;text-transform:uppercase"><td style="padding:2px" rowspan="2">User<br>Time</td><td style="padding:2px">Fluid</td><td style="padding:2px;text-align:right">Surface</td><td style="padding:2px;text-align:right">Wellbore</td><td style="padding:2px;text-align:right">Total</td></tr>';
        html += '<tr style="color:#555;font-size:8px;text-transform:uppercase;border-bottom:1px solid #2d4a6f"><td style="padding:0 2px 3px">Apparent</td><td style="padding:0 2px 3px;text-align:right">Actual</td><td style="padding:0 2px 3px;text-align:right">Transfers</td><td style="padding:0 2px 3px;text-align:right">Hourly</td></tr>';
        
        const fmtGL = (v) => { if(v===null) return '<span style="color:#888">--</span>'; const c=v>0?'#4caf50':v<0?'#ef5350':'#888'; return '<span style="color:'+c+'">'+(v>=0?'+':'')+v+'</span>'; };
        
        data.history.forEach((h, idx) => {
            const t = new Date(h.time).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
            const ft = h.filterType || null;
            const fluidName = ft ? (fluidLabels[ft]||ft) : 'System';
            const fluidClr = ft ? (fluidColors[ft]||'#e0e0e0') : '#e0e0e0';
            let surface = h.systemTotal;
            if (ft && h.totals && h.totals[ft] !== undefined) surface = h.totals[ft];
            
            const prevEntry = (idx < data.history.length - 1) ? data.history[idx + 1] : null;
            let apparent = null, actual = null;
            if (ft) {
                const prevT = prevEntry && prevEntry.totals ? (prevEntry.totals[ft]||0) : null;
                if (prevT !== null) { apparent = surface - prevT; const xf = h.transfersByType && h.transfersByType[ft] ? h.transfersByType[ft] : {out:0,in:0,build:0}; actual = apparent + xf.out - xf.in - xf.build; }
            } else { apparent = h.apparentChange; actual = h.trueChange; }
            
            let transferStr = '<span style="color:#888">--</span>';
            if (h.transfersByType || h.transfersTotal) {
                const xf = ft ? (h.transfersByType && h.transfersByType[ft] ? h.transfersByType[ft] : null) : h.transfersTotal;
                if (xf) { const p=[]; if(xf.out>0)p.push('<span style="color:#ef5350">OUT '+xf.out+'</span>'); if(xf.in>0)p.push('<span style="color:#4caf50">IN '+xf.in+'</span>'); if(xf.build>0)p.push('<span style="color:#a1887f">BLD '+xf.build+'</span>'); if(p.length)transferStr=p.join('<br>'); }
            }
            let hourly = '<span style="color:#888">--</span>';
            if (actual !== null && h.elapsedMin && h.elapsedMin > 0) { const r=((actual/h.elapsedMin)*60).toFixed(1); const rc=parseFloat(r)>0?'#4caf50':parseFloat(r)<0?'#ef5350':'#888'; hourly='<span style="color:'+rc+'">'+(parseFloat(r)>=0?'+':'')+r+'</span>'; }
            
            // Per-fluid breakdown row (if system capture and fluidBreakdown exists)
            let breakdownRow = '';
            if (!ft && h.fluidBreakdown) {
                const changed = Object.keys(h.fluidBreakdown).filter(f => h.fluidBreakdown[f].apparent !== null && h.fluidBreakdown[f].apparent !== 0);
                if (changed.length) {
                    breakdownRow = '<tr><td colspan="5" style="padding:2px 2px 4px;font-size:9px">' + changed.map(f => {
                        const fb = h.fluidBreakdown[f];
                        const c = fb.apparent > 0 ? '#4caf50' : fb.apparent < 0 ? '#ef5350' : '#888';
                        return '<span style="color:' + (fluidColors[f]||'#888') + '">' + (fluidLabels[f]||f) + '</span> <span style="color:' + c + '">' + (fb.apparent >= 0 ? '+' : '') + fb.apparent + '</span>';
                    }).join(' &nbsp; ') + '</td></tr>';
                }
            }
            
            html += '<tr style="border-top:1px solid #2d4a6f"><td rowspan="2" style="padding:4px 2px;white-space:nowrap;vertical-align:middle">' + (h.initials?'<div style="color:#66bb6a;font-weight:600;font-size:11px">'+h.initials+'</div>':'') + '<div style="color:#4fc3f7;font-size:10px">'+t+'</div></td><td style="padding:3px 2px;color:'+fluidClr+';font-weight:600">'+fluidName+'</td><td style="padding:3px 2px;text-align:right;color:#e0e0e0">'+surface+'</td><td style="padding:3px 2px;text-align:right;color:#555">--</td><td style="padding:3px 2px;text-align:right;color:#e0e0e0;font-weight:600">'+surface+'</td></tr>';
            html += '<tr><td style="padding:0 2px 3px">'+fmtGL(apparent)+'</td><td style="padding:0 2px 3px;text-align:right">'+fmtGL(actual)+'</td><td style="padding:0 2px 3px;text-align:right;font-size:9px">'+transferStr+'</td><td style="padding:0 2px 3px;text-align:right">'+hourly+'</td></tr>';
            html += breakdownRow;
        });
        html += '</table>';
    } else {
        html += '<div style="color:#666;font-size:12px;text-align:center;padding:10px">No volume checks logged</div>';
    }
    html += '</div>';
    
    html += '<div class="report-timestamp">Generated: ' + now.toLocaleString() + '</div>';
    document.getElementById('monitor-report-content').innerHTML = html;
    document.getElementById('monitor-report').classList.add('show');
}
function hideMonitorReport() { document.getElementById('monitor-report').classList.remove('show'); }
function sendMonitorReport() {
    const content = document.getElementById('monitor-report-content');
    const btn = document.querySelector('#monitor-report [onclick="sendMonitorReport()"]');
    const origText = btn.textContent;
    btn.textContent = '⏳ Generating...';
    btn.disabled = true;
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position:absolute;left:-9999px;top:0;width:400px;background:#1b2838;padding:16px;color:#e0e0e0;font-family:-apple-system,BlinkMacSystemFont,sans-serif';
    const header = document.createElement('div');
    header.style.cssText = 'text-align:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #2d4a6f';
    header.innerHTML = '<div style="font-size:16px;font-weight:700;color:#4fc3f7">VOLUME MONITOR REPORT</div><div style="font-size:11px;color:#888;margin-top:4px">' + (profileData.wellName||'') + ' — ' + new Date().toLocaleString() + '</div>';
    wrapper.appendChild(header);
    wrapper.appendChild(content.cloneNode(true));
    const footer = document.createElement('div');
    footer.style.cssText = 'text-align:center;margin-top:12px;padding-top:8px;border-top:1px solid #2d4a6f;font-size:9px;color:#666';
    footer.textContent = 'IPS Fluid Tracker — ' + (profileData.name || 'Report');
    wrapper.appendChild(footer);
    document.body.appendChild(wrapper);
    html2canvas(wrapper, { backgroundColor:'#1b2838', scale:2, useCORS:true, logging:false }).then(canvas => {
        document.body.removeChild(wrapper);
        canvas.toBlob(blob => {
            const file = new File([blob], 'volume-monitor-' + Date.now() + '.png', {type:'image/png'});
            if (navigator.canShare && navigator.canShare({files:[file]})) {
                navigator.share({title:'Volume Monitor Report',files:[file]}).then(()=>hideMonitorReport()).catch(()=>{downloadMonitorImage(canvas);hideMonitorReport();});
            } else { downloadMonitorImage(canvas); hideMonitorReport(); }
            btn.textContent = origText; btn.disabled = false;
        }, 'image/png');
    }).catch(err => { console.error('Screenshot failed:',err); document.body.removeChild(wrapper); btn.textContent=origText; btn.disabled=false; alert('Could not generate report image'); });
}
function downloadMonitorImage(canvas) { const a=document.createElement('a'); a.download='volume-monitor-'+Date.now()+'.png'; a.href=canvas.toDataURL('image/png'); a.click(); alert('Report image saved!'); }

// Start New Shift
function startNewShift() {
    if (!confirm('Start New Shift?\n\nThis will reset:\n• Gain/Loss log\n• Jets this hour\n• Shift jetted total\n• Transfer log\n• Injection log\n\nTank volumes and titration data will be preserved.')) return;
    
    data.lastSystemTotal = null;
    data.lastCheckTime = null;
    data.jetsHour = 0;
    data.jetsShift = 0;
    data.history = [];
    data.transferLog = [];
    injData.history = [];
    
    saveData();
    saveInjData();
    render();
    renderInjHist();
    renderTransferLog();
    renderVolumeLog();
    
    alert('New shift started!\n\nAll shift-specific data has been cleared.');
}

// Auto-calculate surface volume for titration report
function getSurfaceVolumeForFluid(fluidType) {
    const totals = calculateTotals();
    switch(fluidType) {
        case 'aphron': return totals.mud;
        case 'brine': return totals.brine;
        case 'recirc': return totals.recirc;
        case 'freshwater': return totals.freshwater;
        default: return totals.system;
    }
}

// ============ VOICE ENTRY SYSTEM ============
let voiceAudioCtx = null;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let voiceRecognition = null;
let voiceIsListening = false;
let voiceState = 'IDLE'; // IDLE, LISTENING, TANK_HEARD, WAITING_NUMBER, CONFIRMING
let voiceCurrentTank = null;
let voiceCurrentSide = null;
let voicePendingInches = null;
let voicePendingBbls = null;
let voiceConfirmTimeout = null;
let voiceSpeaking = false;
let voiceDoneTankSide = null, voiceDoneTankId = null;

// Keyword modal state
let voiceEditingTankId = null;
let voiceEditingSide = null;
let voiceKeywordRecognition = null;
let voiceIsRecordingKeyword = false;

function getVoiceAudioContext() {
    if (!voiceAudioCtx) voiceAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return voiceAudioCtx;
}

function voicePlayTone(frequency, duration, type = 'sine') {
    const ctx = getVoiceAudioContext();
    if (ctx.state === 'suspended') return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = frequency;
    osc.type = type;
    gain.gain.setValueAtTime(0.5, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + duration);
}

function voicePlayDing() { voicePlayTone(880, 0.2); }
function voicePlaySuccess() { voicePlayTone(880, 0.15); setTimeout(() => voicePlayTone(1100, 0.2), 150); }
function voicePlayError() { voicePlayTone(330, 0.3, 'square'); }

function voiceSpeak(text) {
    if ('speechSynthesis' in window) {
        // Pause recognition while speaking to avoid conflict
        voiceSpeaking = true;
        if (voiceRecognition && voiceIsListening) try { voiceRecognition.stop(); } catch(e) {}
        speechSynthesis.cancel();
        setTimeout(() => {
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 1.0; msg.pitch = 1; msg.volume = 1;
            const voices = speechSynthesis.getVoices();
            if (voices.length) { const ev = voices.find(v => v.lang.startsWith('en')); if (ev) msg.voice = ev; }
            msg.onend = () => {
                voiceSpeaking = false;
                if (voiceIsListening && voiceRecognition) {
                    setTimeout(() => { try { voiceRecognition.start(); } catch(e) {} }, 200);
                }
            };
            speechSynthesis.speak(msg);
            const fallback = text.length * 80 + 1500;
            setTimeout(() => {
                voiceSpeaking = false;
                if (voiceIsListening && voiceRecognition) {
                    try { voiceRecognition.start(); } catch(e) {}
                }
            }, fallback);
        }, 50);
    }
}

function voiceSpeakAndThen(text, callback) {
    if ('speechSynthesis' in window) {
        voiceSpeaking = true;
        if (voiceRecognition && voiceIsListening) try { voiceRecognition.stop(); } catch(e) {}
        speechSynthesis.cancel();
        setTimeout(() => {
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 1.0; msg.pitch = 1; msg.volume = 1;
            const voices = speechSynthesis.getVoices();
            if (voices.length) { const ev = voices.find(v => v.lang.startsWith('en')); if (ev) msg.voice = ev; }
            msg.onend = () => {
                voiceSpeaking = false;
                if (voiceIsListening && voiceRecognition) {
                    setTimeout(() => {
                        try { voiceRecognition.start(); } catch(e) {}
                        setTimeout(callback, 200);
                    }, 200);
                } else {
                    setTimeout(callback, 300);
                }
            };
            const fallback = text.length * 80 + 1500;
            setTimeout(() => { 
                if (voiceState === 'WAITING_NUMBER' && voiceSpeaking) {
                    voiceSpeaking = false;
                    if (voiceIsListening && voiceRecognition) {
                        try { voiceRecognition.start(); } catch(e) {}
                    }
                    callback(); 
                }
            }, fallback);
            speechSynthesis.speak(msg);
        }, 50);
    } else { setTimeout(callback, 500); }
}

if ('speechSynthesis' in window) { speechSynthesis.getVoices(); speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices(); }

function toggleVoiceMaster() {
    const ctx = getVoiceAudioContext();
    if (ctx.state === 'suspended') ctx.resume().then(() => voicePlayTone(440, 0.05));
    if (voiceIsListening) stopVoiceListening(); else startVoiceListening();
}

function startVoiceListening() {
    if (!SpeechRecognition) { alert('Speech recognition not supported'); return; }
    voiceIsListening = true;
    voiceState = 'LISTENING';
    voiceCurrentTank = null;
    
    // Request wake lock to keep screen on
    requestWakeLock();
    
    document.getElementById('voice-master-btn').className = 'voice-master-btn active';
    updateVoiceStatus('Listening...', 'Say a tank keyword');
    document.getElementById('voice-status').classList.add('show');
    
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = false;
    voiceRecognition.lang = 'en-US';
    
    voiceRecognition.onresult = (event) => {
        const last = event.results[event.results.length - 1];
        if (last.isFinal) processVoiceInput(last[0].transcript.toLowerCase().trim());
    };
    voiceRecognition.onend = () => { if (voiceIsListening && !voiceSpeaking) try { voiceRecognition.start(); } catch(e) {} };
    voiceRecognition.onerror = (e) => { if (voiceIsListening && !voiceSpeaking && e.error !== 'aborted') setTimeout(() => { try { voiceRecognition.start(); } catch(e) {} }, 100); };
    
    try { voiceRecognition.start(); } catch(e) {}
    setTimeout(() => voicePlayDing(), 100);
}

function stopVoiceListening() {
    voiceIsListening = false;
    voiceState = 'IDLE';
    voiceCurrentTank = null;
    if (voiceConfirmTimeout) clearTimeout(voiceConfirmTimeout);
    
    // Release wake lock
    releaseWakeLock();
    
    document.getElementById('voice-master-btn').className = 'voice-master-btn';
    document.getElementById('voice-status').classList.remove('show');
    
    if (voiceRecognition) try { voiceRecognition.stop(); } catch(e) {}
}

// Convert tank name for speech (# -> pound)
function speakableName(name) {
    return name.replace(/#/g, ' pound').replace(/\s+/g, ' ').trim();
}

function updateVoiceStatus(main, sub) {
    document.getElementById('voice-status-main').textContent = main;
    document.getElementById('voice-status-sub').textContent = sub;
}

// Wake lock to keep screen on while listening
let wakeLock = null;
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake lock acquired');
        }
    } catch (e) {
        console.log('Wake lock failed:', e);
    }
}
function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Wake lock released');
    }
}

function processVoiceInput(text) {
    console.log('Voice heard:', text, 'State:', voiceState);
    
    // Check for "mic off" command FIRST (before cancel check)
    if (text.includes('mic off') || text.includes('microphone off') || text.includes('stop listening')) {
        stopVoiceListening();
        voiceSpeak('Microphone off');
        return;
    }
    
    // Cancel anytime (but not "stop listening")
    if ((text.includes('cancel') || text.includes('nevermind')) || 
        (text.includes('stop') && !text.includes('stop listening'))) {
        if (voiceConfirmTimeout) clearTimeout(voiceConfirmTimeout);
        voicePlayError();
        voiceState = 'LISTENING';
        voiceCurrentTank = null;
        updateVoiceStatus('Cancelled', 'Say a tank keyword');
        document.getElementById('voice-master-btn').className = 'voice-master-btn active';
        voiceSpeak('Cancelled');
        clearTankHighlights();
        render();
        return;
    }
    
    if (voiceState === 'LISTENING') {
        // Build list of all tanks with their keywords
        const allTanks = [
            ...data.pumpTanks.map(t => ({...t, side: 'pump'})),
            ...data.returnTanks.map(t => ({...t, side: 'return'}))
        ];
        
        // Build flat list of all keyword-tank pairs, then sort by keyword length (longest first)
        const keywordMatches = [];
        for (const tank of allTanks) {
            const keywords = tank.voiceKeywords || [];
            for (const kw of keywords) {
                keywordMatches.push({ keyword: kw.toLowerCase(), tank: tank });
            }
        }
        // Sort by keyword length descending - longer keywords checked first
        keywordMatches.sort((a, b) => b.keyword.length - a.keyword.length);
        
        // Now check for matches (longer/more specific keywords get priority)
        for (const match of keywordMatches) {
            if (text.includes(match.keyword)) {
                voiceCurrentTank = match.tank;
                voiceCurrentSide = match.tank.side;
                voiceState = 'WAITING_NUMBER';
                render();
                document.getElementById('voice-master-btn').className = 'voice-master-btn heard';
                updateVoiceStatus(match.tank.name, 'Say the inches');
                // Speak tank name then beep - no waiting
                voiceSpeak(speakableName(match.tank.name));
                setTimeout(() => { if (voiceState === 'WAITING_NUMBER') voicePlayDing(); }, 800);
                return;
            }
        }
    } else if (voiceState === 'WAITING_NUMBER') {
        if (text.includes('no') || text.includes('nope') || text.includes('wrong')) {
            voicePlayError();
            voiceState = 'LISTENING';
            voiceCurrentTank = null;
            updateVoiceStatus('Cancelled', 'Say a tank keyword');
            document.getElementById('voice-master-btn').className = 'voice-master-btn active';
            voiceSpeak('Cancelled');
            clearTankHighlights();
            render();
            return;
        }
        
        // Check for "full" keyword on sandcat tank (185 BBL = 41 inches)
        if (text.includes('full') && voiceCurrentTank && voiceCurrentTank.type === 'sandcat') {
            voicePendingInches = 41;
            voicePendingBbls = 185;
            updateVoiceStatus(`Full = 185 BBL`, speakableName(voiceCurrentTank.name));
            voiceSpeak(`Full, 185 barrels`);
            setTimeout(() => { voiceConfirmEntry(); }, 900);
            return;
        }
        
        const num = extractVoiceNumber(text);
        if (num !== null && num >= 0 && num <= 96) {
            voicePendingInches = num;
            voicePendingBbls = STICK_CHART[num] || 0;
            updateVoiceStatus(`${voicePendingInches}" = ${voicePendingBbls} BBL`, speakableName(voiceCurrentTank.name));
            voiceSpeak(`${voicePendingInches}, ${voicePendingBbls} barrels`);
            setTimeout(() => { voiceConfirmEntry(); }, 900);
        }
    }
}

function extractVoiceNumber(text) {
    const wordToNum = {
        'zero':0,'one':1,'won':1,'two':2,'to':2,'too':2,'three':3,'four':4,'for':4,
        'five':5,'six':6,'seven':7,'eight':8,'ate':8,'nine':9,'ten':10,
        'eleven':11,'twelve':12,'thirteen':13,'fourteen':14,'fifteen':15,
        'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20,
        'thirty':30,'forty':40,'fourty':40,'fifty':50,'sixty':60,'seventy':70,'eighty':80,'ninety':90
    };
    const numMatch = text.match(/\d+/);
    if (numMatch) return parseInt(numMatch[0]);
    let total = 0, found = false;
    text.replace(/-/g,' ').split(/\s+/).forEach(w => {
        const n = wordToNum[w.replace(/[^a-z]/g,'')];
        if (n !== undefined) { found = true; total += n; }
    });
    return found ? total : null;
}

function voiceConfirmEntry() {
    if (!voiceCurrentTank || voicePendingInches === null) return;
    
    // Update the actual tank
    const tanks = voiceCurrentSide === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === voiceCurrentTank.id);
    if (tank) {
        tank.inches = voicePendingInches;
        tank.bbls = voicePendingBbls;
        tank.estimated = false;
        tank.lastStrapTime = new Date().toISOString();
        tank.lastStrapBy = profileData.initials || '';
        // Flash green on completed tank mic icon
        voiceDoneTankSide = voiceCurrentSide;
        voiceDoneTankId = voiceCurrentTank.id;
        saveData();
        render();
        // Clear green after 2 seconds
        setTimeout(() => { voiceDoneTankSide = null; voiceDoneTankId = null; render(); }, 2000);
    }
    
    voicePlaySuccess(); // double beep
    updateVoiceStatus('✓ Entered!', `${voiceCurrentTank.name}: ${voicePendingInches}" = ${voicePendingBbls} BBL`);
    document.getElementById('voice-master-btn').className = 'voice-master-btn active';
    
    setTimeout(() => {
        if (voiceIsListening) {
            voiceState = 'LISTENING';
            voiceCurrentTank = null;
            voicePendingInches = null;
            voicePendingBbls = null;
            updateVoiceStatus('Listening...', 'Say a tank keyword');
            clearTankHighlights();
        }
    }, 1500);
}

function highlightTankCard(side, id) {
    // No card highlight - mic icon states handle feedback
}

function clearTankHighlights() {
    // No card highlight to clear
}

// Voice Keyword Modal
function openVoiceKeywordModal(side, tankId) {
    if (voiceIsListening) stopVoiceListening();
    voiceEditingSide = side;
    voiceEditingTankId = tankId;
    const tanks = side === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === tankId);
    if (!tank) return;
    
    document.getElementById('voice-modal-tank-name').textContent = tank.name;
    document.getElementById('voice-keyword-input').value = '';
    renderVoiceKeywordList();
    document.getElementById('voice-keyword-modal').classList.add('show');
}

function closeVoiceKeywordModal() {
    if (voiceIsRecordingKeyword) stopVoiceKeywordRecord();
    document.getElementById('voice-keyword-modal').classList.remove('show');
    voiceEditingTankId = null;
    voiceEditingSide = null;
    render();
    // If manager is open, refresh it
    if (document.getElementById('voice-keywords-manager').classList.contains('show')) renderVoiceKmList();
}

function openVoiceKeywordsManager() {
    if (voiceIsListening) stopVoiceListening();
    renderVoiceKmList();
    document.getElementById('voice-keywords-manager').classList.add('show');
}

function closeVoiceKeywordsManager() {
    document.getElementById('voice-keywords-manager').classList.remove('show');
}

function renderVoiceKmList() {
    const el = document.getElementById('voice-km-list');
    let html = '';
    const renderSection = (tanks, side, title) => {
        if (!tanks.length) return;
        html += '<div style="font-size:11px;color:#4fc3f7;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin:12px 0 6px">' + title + '</div>';
        tanks.forEach(t => {
            const kws = t.voiceKeywords || [];
            const kwText = kws.length ? kws.map(k => '<span style="background:#1b2838;padding:2px 8px;border-radius:4px;font-size:11px;color:#66bb6a">' + k + '</span>').join(' ') : '<span style="color:#666;font-size:12px">No keywords</span>';
            html += '<div style="background:#1b2838;border-radius:6px;padding:10px 12px;margin-bottom:6px;cursor:pointer" onclick="closeVoiceKeywordsManager();openVoiceKeywordModal(\'' + side + '\',' + t.id + ')">';
            html += '<div style="font-size:14px;font-weight:600;color:#e0e0e0;margin-bottom:4px">' + t.name + '</div>';
            html += '<div style="display:flex;flex-wrap:wrap;gap:4px">' + kwText + '</div>';
            html += '</div>';
        });
    };
    renderSection(data.pumpTanks, 'pump', 'Pump Side');
    renderSection(data.returnTanks, 'return', 'Return Side');
    el.innerHTML = html;
}

function renderVoiceKeywordList() {
    const tanks = voiceEditingSide === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === voiceEditingTankId);
    const container = document.getElementById('voice-keyword-list');
    if (!tank) return;
    
    const keywords = tank.voiceKeywords || [];
    if (!keywords.length) {
        container.innerHTML = '<div style="color:#666;font-size:13px;text-align:center;padding:12px">No keywords yet</div>';
        return;
    }
    container.innerHTML = keywords.map((kw, i) => 
        `<div class="voice-keyword-item"><span>${kw}</span><button onclick="removeVoiceKeyword(${i})">×</button></div>`
    ).join('');
}

function addVoiceKeywordFromInput() {
    const input = document.getElementById('voice-keyword-input');
    const keyword = input.value.trim().toLowerCase();
    if (!keyword || !voiceEditingTankId) return;
    
    const tanks = voiceEditingSide === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === voiceEditingTankId);
    if (!tank) return;
    
    if (!tank.voiceKeywords) tank.voiceKeywords = [];
    if (!tank.voiceKeywords.includes(keyword)) {
        tank.voiceKeywords.push(keyword);
        saveData();
        voicePlayDing();
    }
    input.value = '';
    renderVoiceKeywordList();
}

function removeVoiceKeyword(index) {
    const tanks = voiceEditingSide === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === voiceEditingTankId);
    if (!tank || !tank.voiceKeywords) return;
    tank.voiceKeywords.splice(index, 1);
    saveData();
    renderVoiceKeywordList();
}

function toggleVoiceKeywordRecord() {
    if (voiceIsRecordingKeyword) stopVoiceKeywordRecord(); else startVoiceKeywordRecord();
}

function startVoiceKeywordRecord() {
    if (!SpeechRecognition) return;
    const ctx = getVoiceAudioContext();
    if (ctx.state === 'suspended') ctx.resume();
    
    voiceKeywordRecognition = new SpeechRecognition();
    voiceKeywordRecognition.continuous = false;
    voiceKeywordRecognition.interimResults = false;
    voiceKeywordRecognition.lang = 'en-US';
    
    voiceKeywordRecognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase().trim();
        if (transcript && voiceEditingTankId) {
            const tanks = voiceEditingSide === 'pump' ? data.pumpTanks : data.returnTanks;
            const tank = tanks.find(t => t.id === voiceEditingTankId);
            if (tank) {
                if (!tank.voiceKeywords) tank.voiceKeywords = [];
                if (!tank.voiceKeywords.includes(transcript)) {
                    tank.voiceKeywords.push(transcript);
                    saveData();
                    voicePlayDing();
                }
                renderVoiceKeywordList();
            }
        }
        stopVoiceKeywordRecord();
    };
    voiceKeywordRecognition.onerror = () => stopVoiceKeywordRecord();
    voiceKeywordRecognition.onend = () => stopVoiceKeywordRecord();
    
    voiceIsRecordingKeyword = true;
    document.getElementById('voice-record-btn').classList.add('recording');
    document.getElementById('voice-record-label').textContent = 'Listening...';
    voiceKeywordRecognition.start();
}

function stopVoiceKeywordRecord() {
    voiceIsRecordingKeyword = false;
    document.getElementById('voice-record-btn').classList.remove('recording');
    document.getElementById('voice-record-label').textContent = 'Record Keyword';
    if (voiceKeywordRecognition) { try { voiceKeywordRecognition.stop(); } catch(e) {} voiceKeywordRecognition = null; }
}

// ==================== BLUETOOTH (BLE) ====================
// Bosch Blaze GLM165-27CG / GLM 50-27 CG Protocol
// Service:        02a6c0d0-0451-4000-b000-fb3210111989
// Characteristic: 02a6c0d1-0451-4000-b000-fb3210111989 (INDICATE, WRITE)
// Logging cmd:    C0 55 02 01 00 1A (enables auto-transmit on physical measure)
// Response:       20 bytes — bytes 7-10 = IEEE-754 LE float (meters)
const BOSCH_SERVICE_UUID = '02a6c0d0-0451-4000-b000-fb3210111989';
const BOSCH_CHAR_UUID    = '02a6c0d1-0451-4000-b000-fb3210111989';
const BLE_LOG_CMD = new Uint8Array([0xC0, 0x55, 0x02, 0x01, 0x00, 0x1A]);

let bleDevice = null, bleCharacteristic = null, bleConnected = false;
let bleActiveTankSide = null, bleActiveTankId = null;
let bleDoneTankSide = null, bleDoneTankId = null;
let bleMasterActive = false;
let bleOffsetInches = 108; // Default: 9 feet (tank lip to 0" mark)

function loadBleOffset() {
    const s = localStorage.getItem('ipsBleOffset');
    if (s) bleOffsetInches = parseFloat(s) || 108;
    const inp = document.getElementById('ble-offset-input');
    if (inp) { inp.value = bleOffsetInches; updateOffsetDisplay(); }
}
function saveBleOffset() {
    const inp = document.getElementById('ble-offset-input');
    bleOffsetInches = parseFloat(inp.value) || 108;
    localStorage.setItem('ipsBleOffset', bleOffsetInches);
    updateOffsetDisplay();
}
function updateOffsetDisplay() {
    const ft = document.getElementById('ble-offset-ft');
    if (ft) ft.textContent = '= ' + (bleOffsetInches / 12).toFixed(1) + ' ft';
}

function updateBleStatus(main, sub) {
    const m = document.getElementById('ble-status-main');
    const s = document.getElementById('ble-status-sub');
    if (m) m.textContent = main;
    if (s) s.textContent = sub;
}

function updateBleMasterBtn() {
    const btn = document.getElementById('ble-master-btn');
    if (!btn) return;
    if (bleMasterActive && bleConnected) {
        btn.className = 'ble-master-btn active';
    } else if (bleMasterActive) {
        btn.className = 'ble-master-btn heard'; // connecting state
    } else {
        btn.className = 'ble-master-btn';
    }
}

async function toggleBleMaster() {
    if (bleMasterActive) {
        // Turn off
        bleMasterActive = false;
        bleActiveTankSide = null;
        bleActiveTankId = null;
        document.getElementById('ble-status').classList.remove('show');
        updateBleMasterBtn();
        render();
        return;
    }
    
    // Turn on
    bleMasterActive = true;
    updateBleMasterBtn();
    document.getElementById('ble-status').classList.add('show');
    updateBleStatus('Connecting...', 'Select your laser');
    
    if (!bleConnected) {
        const ok = await connectBle();
        if (!ok) {
            bleMasterActive = false;
            document.getElementById('ble-status').classList.remove('show');
            updateBleMasterBtn();
            return;
        }
    }
    
    // Connected — assign first visible tank
    const visibleTanks = getFilteredTanks();
    if (visibleTanks.length) {
        bleActiveTankSide = visibleTanks[0].side;
        bleActiveTankId = visibleTanks[0].tank.id;
        updateBleStatus(visibleTanks[0].tank.name, 'Shoot laser to measure');
        updateBleMasterBtn();
        render();
        scrollToActiveBle();
    } else {
        updateBleStatus('No tanks', 'Add tanks first');
    }
}

// Per-tank icon toggle still works for manual selection
async function toggleBleTank(side, tankId) {
    if (bleActiveTankSide === side && bleActiveTankId === tankId) {
        bleActiveTankSide = null; bleActiveTankId = null;
        if (bleMasterActive) updateBleStatus('Paused', 'Tap a tank or shoot laser');
        render();
        return;
    }
    if (!bleConnected) {
        bleMasterActive = true;
        updateBleMasterBtn();
        document.getElementById('ble-status').classList.add('show');
        updateBleStatus('Connecting...', 'Select your laser');
        const ok = await connectBle();
        if (!ok) {
            bleMasterActive = false;
            document.getElementById('ble-status').classList.remove('show');
            updateBleMasterBtn();
            return;
        }
    }
    bleMasterActive = true;
    bleActiveTankSide = side;
    bleActiveTankId = tankId;
    const tanks = side === 'pump' ? data.pumpTanks : data.returnTanks;
    const tank = tanks.find(t => t.id === tankId);
    if (tank) updateBleStatus(tank.name, 'Shoot laser to measure');
    updateBleMasterBtn();
    document.getElementById('ble-status').classList.add('show');
    render();
}

async function connectBle() {
    if (!navigator.bluetooth) {
        alert('Bluetooth laser not supported on this browser.\n\niPhone/Safari does not support Web Bluetooth.\n\nOptions:\n• Install "Bluefy" browser (free) from the App Store and open this app there\n• Enter inches manually');
        return false;
    }
    try {
        // Force focus back to window — helps Android Chrome render BT picker devices
        window.focus();
        await new Promise(r => setTimeout(r, 300));
        
        let device = null;
        device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [BOSCH_SERVICE_UUID]
        });
        bleDevice = device;
        bleDevice.addEventListener('gattserverdisconnected', onBleDisconnect);
        updateBleStatus('Pairing...', 'Connecting to ' + (device.name || 'device'));
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(BOSCH_SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(BOSCH_CHAR_UUID);
        await bleCharacteristic.startNotifications();
        bleCharacteristic.addEventListener('characteristicvaluechanged', handleBleMeasurement);
        try { await bleCharacteristic.writeValue(BLE_LOG_CMD); } catch(e) { console.log('Log cmd write:', e); }
        bleConnected = true;
        updateBleMasterBtn();
        render();
        return true;
    } catch(e) {
        console.log('BLE connect error:', e);
        if (e.name !== 'NotFoundError') {
            if (!navigator.bluetooth) {
                alert('Bluetooth laser not supported on this browser.\n\niPhone/Safari does not support Web Bluetooth.\n\nOptions:\n• Install "Bluefy" browser (free) from the App Store and open this app there\n• Enter inches manually');
            } else {
                alert('Bluetooth connection failed: ' + e.message);
            }
        }
        return false;
    }
}

function onBleDisconnect() {
    bleConnected = false; bleCharacteristic = null; bleDevice = null;
    bleActiveTankSide = null; bleActiveTankId = null;
    bleDoneTankSide = null; bleDoneTankId = null;
    bleMasterActive = false;
    document.getElementById('ble-status').classList.remove('show');
    updateBleMasterBtn();
    render();
}

function handleBleMeasurement(event) {
    const val = event.target.value;
    const len = val.byteLength;
    if (len < 20) return;
    if (val.getUint8(0) !== 0xC0 || val.getUint8(1) !== 0x55) return;
    if (val.getUint8(3) !== 0x06) return;
    const meters = val.getFloat32(7, true);
    if (meters <= 0.01 || meters > 50) return;
    const rawInches = meters * 39.3701;
    const adjustedInches = Math.max(0, Math.round((bleOffsetInches - rawInches) * 4) / 4);

    if (bleActiveTankSide && bleActiveTankId) {
        const tanks = bleActiveTankSide === 'pump' ? data.pumpTanks : data.returnTanks;
        const tank = tanks.find(t => t.id === bleActiveTankId);
        if (tank) {
            tank.inches = adjustedInches;
            tank.bbls = inchesToBbl(adjustedInches);
            tank.estimated = false;
            tank.lastStrapTime = new Date().toISOString();
            tank.lastStrapBy = profileData.initials || '';
            tank._updatedAt = new Date().toISOString();
            tank._updatedBy = profileData.initials || '';
            bleDoneTankSide = bleActiveTankSide;
            bleDoneTankId = bleActiveTankId;
            
            updateBleStatus('✓ ' + tank.name + ': ' + adjustedInches + '" = ' + tank.bbls + ' BBL', 'Advancing...');
            
            autoAdvanceBle();
            // Save locally first, render immediately, then sync to Firebase
            localStorage.setItem('ipsTrackerV3', JSON.stringify(data));
            render();
            firebaseSaveTanks();
            scrollToActiveBle();
            // Clear done state after animation completes so future renders don't re-apply
            setTimeout(() => { bleDoneTankSide = null; bleDoneTankId = null; }, 2000);
        }
    }
}

function autoAdvanceBle() {
    const visibleTanks = getFilteredTanks();
    if (!visibleTanks.length) return;
    const currentIdx = visibleTanks.findIndex(t => t.tank.id === bleActiveTankId && t.side === bleActiveTankSide);
    if (currentIdx >= 0 && currentIdx < visibleTanks.length - 1) {
        const next = visibleTanks[currentIdx + 1];
        bleActiveTankSide = next.side; bleActiveTankId = next.tank.id;
        updateBleStatus(next.tank.name, 'Shoot laser to measure');
    } else {
        // Last tank — done
        bleActiveTankSide = null; bleActiveTankId = null;
        updateBleStatus('✓ All done!', 'All visible tanks measured');
        setTimeout(() => {
            if (bleMasterActive && !bleActiveTankId) {
                bleMasterActive = false;
                document.getElementById('ble-status').classList.remove('show');
                updateBleMasterBtn();
            }
        }, 3000);
    }
}

function scrollToActiveBle() {
    if (!bleActiveTankSide || !bleActiveTankId) return;
    setTimeout(() => {
        // Look in both normal and filtered containers
        const containers = ['pump-tanks', 'return-tanks', 'filtered-tanks'];
        for (const cid of containers) {
            const container = document.getElementById(cid);
            if (!container) continue;
            const card = container.querySelector('.tank-card[data-side="' + bleActiveTankSide + '"][data-id="' + bleActiveTankId + '"]');
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                break;
            }
        }
    }, 100);
}

function getFilteredTanks() {
    const all = [];
    if (activeFluidFilter) {
        data.pumpTanks.filter(t => getTankFluidType(t, 'pump') === activeFluidFilter).forEach(t => all.push({ tank: t, side: 'pump' }));
        data.returnTanks.filter(t => getTankFluidType(t, 'return') === activeFluidFilter).forEach(t => all.push({ tank: t, side: 'return' }));
    } else {
        data.pumpTanks.forEach(t => all.push({ tank: t, side: 'pump' }));
        data.returnTanks.forEach(t => all.push({ tank: t, side: 'return' }));
    }
    return all;
}

// ==================== FLUID TYPE FILTER ====================
let activeFluidFilter = null;

function getTankFluidType(tank, side) {
    if (side === 'pump') {
        if (tank.type === 'brine10' || tank.type === 'brine119') return 'brine';
        if (tank.type === 'packer') return 'packer';
        if (tank.type === 'aphron') return 'mud';
        if (tank.type === 'recirc') return 'recirc';
        if (tank.type === 'freshwater') return 'freshwater';
        return 'other';
    } else {
        const f = tank.contents || '';
        if (f === 'brine') return 'brine';
        if (f === 'mud') return 'mud';
        if (f === 'recirc') return 'recirc';
        if (f === 'freshwater') return 'freshwater';
        return 'other';
    }
}

function setFluidFilter(type) {
    activeFluidFilter = activeFluidFilter === type ? null : type;
    render();
}

let glFluidFilter = null;

function setGLFluidFilter(type) {
    glFluidFilter = glFluidFilter === type ? null : type;
    // Update button highlights
    ['brine','packer','mud','recirc','freshwater','other'].forEach(t => {
        const btn = document.getElementById('gl-filter-' + t);
        if (btn) btn.classList.toggle('filter-active', glFluidFilter === t);
    });
    // Update label
    const label = document.getElementById('gl-filter-label');
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Freshwater',other:'Other'};
    const fluidLabelColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    if (label) {
        if (glFluidFilter) {
            const fName = fluidNames[glFluidFilter] || glFluidFilter;
            const fClr = fluidLabelColors[glFluidFilter] || '#e0e0e0';
            label.innerHTML = 'Capture <span style="color:' + fClr + '">' + fName + '</span> Only';
        } else {
            label.innerHTML = 'Capture <span style="color:#e0e0e0">System</span>';
        }
    }
    // Re-render the GL display from last check with filter applied
    renderGLFiltered();
}

function renderGLFiltered() {
    const last = data.history[0];
    const appEl = document.getElementById('apparent-change');
    const truEl = document.getElementById('true-change');
    const rateEl = document.getElementById('rate-per-hour');
    const capFluid = document.getElementById('cap-fluid');
    const capSurface = document.getElementById('cap-surface');
    const capTotal = document.getElementById('cap-total');
    const capTransfers = document.getElementById('cap-transfers');
    
    if (!last) return;
    
    const fluidNames = {brine:'Brine',packer:'Packer',mud:'Mud',recirc:'Recirc',freshwater:'Fresh',other:'Other'};
    const fluidBoxColors = {brine:'#42a5f5',packer:'#ff7043',mud:'#a1887f',recirc:'#ba68c8',freshwater:'#4db6ac',other:'#90a4ae'};
    
    const fmtVal = (el, val) => {
        if (!el) return;
        if (val === null) { el.textContent = '--'; el.className = 'gl-value neutral'; return; }
        el.textContent = (val >= 0 ? '+' : '') + val;
        el.className = 'gl-value ' + (val > 0 ? 'gain' : val < 0 ? 'loss' : 'neutral');
    };
    const fmtRate = (el, val) => {
        if (!el) return;
        if (val === null) { el.textContent = '--'; el.className = 'gl-value neutral'; return; }
        const r = parseFloat(val);
        el.textContent = (r >= 0 ? '+' : '') + val;
        el.className = 'gl-value ' + (r > 0 ? 'gain' : r < 0 ? 'loss' : 'neutral');
    };
    
    if (glFluidFilter) {
        // Update Fluid box to show selected type
        if (capFluid) { capFluid.textContent = fluidNames[glFluidFilter] || glFluidFilter; capFluid.style.color = fluidBoxColors[glFluidFilter] || '#e0e0e0'; }
        
        // Surface/Total for this type
        const currTypeTotal = last.totals ? (last.totals[glFluidFilter] || 0) : null;
        if (capSurface) { capSurface.textContent = currTypeTotal !== null ? currTypeTotal : '--'; capSurface.style.color = '#e0e0e0'; }
        if (capTotal) { capTotal.textContent = currTypeTotal !== null ? currTypeTotal : '--'; capTotal.style.color = '#e0e0e0'; }
        
        // Transfers for this type
        if (capTransfers) {
            const xf = last.transfersByType && last.transfersByType[glFluidFilter] ? last.transfersByType[glFluidFilter] : { out: 0, in: 0, build: 0 };
            const parts = [];
            if (xf.out > 0) parts.push('<span style="color:#ef5350">-' + xf.out + '</span>');
            if (xf.in > 0) parts.push('<span style="color:#4caf50">+' + xf.in + '</span>');
            if (xf.build > 0) parts.push('<span style="color:#a1887f">+' + xf.build + '</span>');
            capTransfers.innerHTML = parts.length ? parts.join(' ') : '--';
            capTransfers.style.color = parts.length ? '' : '#888';
        }
        
        // Apparent / Actual / Hourly
        const prevEntry = data.history.length > 1 ? data.history[1] : null;
        const prevTypeTotal = prevEntry && prevEntry.totals ? (prevEntry.totals[glFluidFilter] || 0) : null;
        
        if (prevTypeTotal !== null && currTypeTotal !== null) {
            const fApp = currTypeTotal - prevTypeTotal;
            const xf = last.transfersByType && last.transfersByType[glFluidFilter] ? last.transfersByType[glFluidFilter] : { out: 0, in: 0, build: 0 };
            const fActual = fApp + xf.out - xf.in - xf.build;
            
            fmtVal(appEl, fApp);
            fmtVal(truEl, fActual);
            
            if (last.elapsedMin && last.elapsedMin > 0) {
                fmtRate(rateEl, ((fActual / last.elapsedMin) * 60).toFixed(1));
            } else {
                fmtRate(rateEl, null);
            }
        } else {
            fmtVal(appEl, null); fmtVal(truEl, null); fmtRate(rateEl, null);
        }
    } else {
        // No filter — show system values
        if (capFluid) { capFluid.textContent = last.filterType ? (fluidNames[last.filterType] || last.filterType) : 'System'; capFluid.style.color = last.filterType ? (fluidBoxColors[last.filterType] || '#e0e0e0') : '#e0e0e0'; }
        const surface = last.filterType && last.totals ? (last.totals[last.filterType] || 0) : last.systemTotal;
        if (capSurface) { capSurface.textContent = surface; capSurface.style.color = '#e0e0e0'; }
        if (capTotal) { capTotal.textContent = surface; capTotal.style.color = '#e0e0e0'; }
        
        // System transfers
        if (capTransfers) {
            const xf = last.transfersTotal || { out: 0, in: 0, build: 0 };
            const parts = [];
            if (xf.out > 0) parts.push('<span style="color:#ef5350">-' + xf.out + '</span>');
            if (xf.in > 0) parts.push('<span style="color:#4caf50">+' + xf.in + '</span>');
            if (xf.build > 0) parts.push('<span style="color:#a1887f">+' + xf.build + '</span>');
            capTransfers.innerHTML = parts.length ? parts.join(' ') : '--';
            capTransfers.style.color = parts.length ? '' : '#888';
        }
        
        fmtVal(appEl, last.apparentChange);
        fmtVal(truEl, last.trueChange);
        fmtRate(rateEl, last.ratePerHour);
    }
}

// ========== WELL DATA CAPTURE ==========
let chatFeedHistory = JSON.parse(localStorage.getItem('ips_chat_feed_history') || '[]');
let chatFeedCurrentTab = 'paste';
let chatFeedImageData = null;

function openChatFeed() {
    document.getElementById('chat-feed-overlay').classList.add('show');
    renderChatFeedHistory();
}

function closeChatFeed() {
    document.getElementById('chat-feed-overlay').classList.remove('show');
}
function switchChatFeedTab(tab) {
    chatFeedCurrentTab = tab;
    document.getElementById('cf-tab-paste').className = 'chat-feed-tab' + (tab === 'paste' ? ' active' : '');
    document.getElementById('cf-tab-image').className = 'chat-feed-tab' + (tab === 'image' ? ' active' : '');
    document.getElementById('cf-paste-area').style.display = tab === 'paste' ? 'block' : 'none';
    document.getElementById('cf-image-area').style.display = tab === 'image' ? 'block' : 'none';
}

function handleChatFeedImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        chatFeedImageData = e.target.result;
        document.getElementById('cf-preview-img').src = chatFeedImageData;
        document.getElementById('cf-image-preview').style.display = 'block';
        document.getElementById('cf-upload-zone').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

function parseDrillingReport(text) {
    // Normalize Unicode: replace non-breaking spaces, zero-width chars, smart quotes, etc.
    text = text.replace(/[\u00A0\u2000-\u200F\u2028\u2029\u202F\u205F\u3000\uFEFF]/g, ' ');
    text = text.replace(/[\u2018\u2019\u201C\u201D]/g, '"');
    text = text.replace(/\u2013|\u2014/g, '-');
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    
    // Field mapping with flexible regex patterns — allow colon, equals, space, or dash as separator
    const sep = '[:\\s=\\-]+';
    const fieldPatterns = [
        { key: 'plug', label: 'Plug', pattern: new RegExp('^plug' + sep + '(.+)', 'i') },
        { key: 'jnt', label: 'JNT', pattern: new RegExp('^jn?t' + sep + '(.+)', 'i') },
        { key: 'depth', label: 'Depth', pattern: new RegExp('^depth' + sep + '(.+)', 'i') },
        { key: 'time', label: 'Time', pattern: new RegExp('^time' + sep + '(.+)', 'i') },
        { key: 'drill', label: 'Drill Time', pattern: new RegExp('^drill(?:\\s*time)?' + sep + '(.+)', 'i') },
        { key: 'washTime', label: 'Wash Time', pattern: new RegExp('^wash\\s*time' + sep + '(.+)', 'i') },
        { key: 'rihWt', label: 'RIH Wt', pattern: new RegExp('^rih\\s*w(?:t|eight)' + sep + '(.+)', 'i') },
        { key: 'nw', label: 'Nw', pattern: new RegExp('^nw' + sep + '(.+)', 'i') },
        { key: 'puWt', label: 'P/U Wt', pattern: new RegExp('^p[/\\\\]?u\\s*w(?:t|eight)' + sep + '(.+)', 'i') },
        { key: 'torqueOff', label: 'Torque Off', pattern: new RegExp('^torque\\s*off' + sep + '(.+)', 'i') },
        { key: 'torqueOn', label: 'Torque On', pattern: new RegExp('^torque\\s*on' + sep + '(.+)', 'i') },
        { key: 'rpm', label: 'RPM', pattern: new RegExp('^rpm' + sep + '(.+)', 'i') },
        { key: 'wob', label: 'WOB', pattern: new RegExp('^wob\\s+(.+)', 'i') },
        { key: 'circ', label: 'CIRC', pattern: new RegExp('^circ' + sep + '(.+)', 'i') },
        { key: 'pr', label: 'PR', pattern: new RegExp('^pr' + sep + '(.+)', 'i') },
        { key: 'mp', label: 'MP', pattern: new RegExp('^mp' + sep + '(.+)', 'i') },
        { key: 'rr', label: 'RR', pattern: new RegExp('^rr' + sep + '(.+)', 'i') },
        { key: 'chkSize', label: 'Chk Size', pattern: new RegExp('^chk\\s*(?:size)?' + sep + '(.+)', 'i') },
        { key: 'mudWt', label: 'Mud Wt In/Out', pattern: new RegExp('^mud\\s*w(?:t|eight)\\.?\\s*(?:in[/\\\\]?out)?' + sep + '(.+)', 'i') },
        { key: 'mudVisc', label: 'Mud Visc In/Out', pattern: new RegExp('^mud\\s*visc\\.?\\s*(?:in[/\\\\]?out)?' + sep + '(.+)', 'i') },
        { key: 'chlorides', label: 'Chlorides In/Out', pattern: new RegExp('^chlorides?\\s*(?:in[/\\\\]?out)?' + sep + '(.+)', 'i') },
        { key: 'marker', label: 'Marker Sent', pattern: new RegExp('^marker\\s*(?:sent)?' + sep + '(.*)', 'i') },
        { key: 'surfaceTime', label: 'Surface Time', pattern: new RegExp('^surface\\s*time' + sep + '(.*)', 'i') },
        { key: 'interval', label: 'Int', pattern: new RegExp('^int' + sep + '(.*)', 'i') },
        { key: 'stalls', label: 'Stalls', pattern: new RegExp('^stalls?' + sep + '(.*)', 'i') },
        { key: 'fr', label: 'FR', pattern: new RegExp('^fr' + sep + '(.*)', 'i') },
        { key: 'pop', label: 'POP', pattern: new RegExp('^pop' + sep + '(.*)', 'i') },
        { key: 'sand', label: 'Sand', pattern: new RegExp('^sand' + sep + '(.+)', 'i') },
        { key: 'gas', label: 'Gas', pattern: new RegExp('^gas' + sep + '(.*)', 'i') },
        { key: 'eta', label: 'ETA', pattern: new RegExp('^eta' + sep + '(.+)', 'i') },
        { key: 'comments', label: 'Comments', pattern: new RegExp('^comments?' + sep + '(.*)', 'i') },
    ];
    
    const records = [];
    let currentRecord = null;
    
    for (const line of lines) {
        // Check if this line starts a new plug record
        const plugMatch = line.match(/^plug[\s:=\-]+(.+)/i);
        if (plugMatch) {
            if (currentRecord && Object.keys(currentRecord.fields).length > 0) {
                records.push(currentRecord);
            }
            currentRecord = { fields: {}, raw: [] };
        }
        
        if (!currentRecord) {
            currentRecord = { fields: {}, raw: [] };
        }
        
        currentRecord.raw.push(line);
        
        // Try to match each field
        let matched = false;
        for (const fp of fieldPatterns) {
            const m = line.match(fp.pattern);
            if (m) {
                currentRecord.fields[fp.key] = { label: fp.label, value: m[1].trim() || '—' };
                matched = true;
                break;
            }
        }
        
        // Handle "WOB 2k" style (no colon)
        if (!matched) {
            const wobNoColon = line.match(/^wob\s+(.+)/i);
            if (wobNoColon) {
                currentRecord.fields['wob'] = { label: 'WOB', value: wobNoColon[1].trim() };
            }
        }
    }
    
    // Push last record
    if (currentRecord && Object.keys(currentRecord.fields).length > 0) {
        records.push(currentRecord);
    }
    
    return records;
}

function applyChatFeedToApp(record) {
    const f = record.fields;
    const synced = [];
    
    // Helper: parse numeric, strip commas and "k" suffix for weights (klb)
    function parseWeight(val) {
        if (!val) return null;
        val = val.toString().replace(/,/g, '').trim();
        const m = val.match(/^([\d.]+)\s*k/i);
        if (m) return parseFloat(m[1]);
        return parseFloat(val) || null;
    }
    
    // Helper: parse numeric, strip commas
    function parseNum(val) {
        if (!val) return null;
        val = val.toString().replace(/,/g, '').trim();
        const m = val.match(/^([\d.]+)/);
        return m ? parseFloat(m[1]) : null;
    }
    
    // Helper: parse chlorides with "k" meaning thousands of ppm
    function parseChlorides(val) {
        if (!val) return null;
        val = val.toString().replace(/,/g, '').trim();
        const m = val.match(/^([\d.]+)\s*k/i);
        if (m) return parseFloat(m[1]) * 1000;
        return parseFloat(val) || null;
    }
    
    // Helper: parse in/out values like "6.6/6.6" or "5k / 10k"
    function parseInOut(val) {
        if (!val) return { inVal: null, outVal: null };
        const parts = val.split('/').map(s => s.trim());
        return { inVal: parts[0] || null, outVal: parts[1] || null };
    }
    
    // Helper: set a field value and track it
    function setField(id, value) {
        const el = document.getElementById(id);
        if (el && value !== null && value !== undefined && value !== '') {
            el.value = value;
            synced.push(id);
        }
    }
    
    // --- PLUG INFO ---
    // Plug: "40 of 91" → plug-num=40, plug-total=91
    if (f.plug) {
        const pm = f.plug.value.match(/(\d+)\s*(?:of|\/)\s*(\d+)/i);
        if (pm) {
            setField('plug-num', pm[1]);
            setField('plug-total', pm[2]);
        } else {
            const n = parseNum(f.plug.value);
            if (n) setField('plug-num', n);
        }
    }
    
    // JNT: "616/ 28 ft out" or "362/ 4 out" → plug-jnt=616, plug-jnt-out=28
    if (f.jnt) {
        const jm = f.jnt.value.match(/([\d,]+)\s*\/\s*([\d.]+)/);
        if (jm) {
            setField('plug-jnt', jm[1].replace(/,/g, ''));
            setField('plug-jnt-out', jm[2]);
        } else {
            const n = parseNum(f.jnt.value);
            if (n) setField('plug-jnt', n);
        }
    }
    
    // Depth: "19,312" → 19312
    if (f.depth) {
        const d = parseNum(f.depth.value);
        if (d) setField('plug-depth', d);
    }
    
    // Time: "11:47" → plug-time (input type=time expects HH:MM)
    if (f.time) {
        const tv = f.time.value.trim();
        const tm = tv.match(/^(\d{1,2}):(\d{2})/);
        if (tm) {
            const hh = tm[1].padStart(2, '0');
            setField('plug-time', hh + ':' + tm[2]);
        }
    }
    
    // --- TIMING ---
    if (f.drill) {
        const d = parseNum(f.drill.value);
        if (d) setField('plug-drill-time', d);
    }
    if (f.washTime) {
        const w = parseNum(f.washTime.value);
        if (w) setField('plug-wash-time', w);
    }
    if (f.eta) {
        const ev = f.eta.value.trim();
        const em = ev.match(/^(\d{1,2}):(\d{2})/);
        if (em) {
            const hh = em[1].padStart(2, '0');
            setField('plug-eta', hh + ':' + em[2]);
        }
    }
    
    // --- STRING WEIGHTS (stored as klb, "48k" → 48) ---
    if (f.rihWt) { const v = parseWeight(f.rihWt.value); if (v) setField('plug-rih-wt', v); }
    if (f.nw) { const v = parseWeight(f.nw.value); if (v) setField('plug-neutral-wt', v); }
    if (f.puWt) { const v = parseWeight(f.puWt.value); if (v) setField('plug-pu-wt', v); }
    
    // --- DRILLING PARAMETERS ---
    if (f.torqueOff) { const v = parseNum(f.torqueOff.value); if (v) setField('plug-torque-off', v); }
    if (f.torqueOn) { const v = parseNum(f.torqueOn.value); if (v) setField('plug-torque-on', v); }
    if (f.rpm) { const v = parseNum(f.rpm.value); if (v) setField('plug-rpm', v); }
    if (f.wob) { const v = parseWeight(f.wob.value); if (v) setField('plug-wob', v); }
    
    // --- PRESSURES & RATES ---
    if (f.circ) { const v = parseNum(f.circ.value); if (v) setField('plug-circ', v); }
    if (f.pr) { const v = parseNum(f.pr.value); if (v) setField('plug-pr', v); }
    if (f.mp) { const v = parseNum(f.mp.value); if (v) setField('plug-mp', v); }
    if (f.rr) { const v = parseNum(f.rr.value); if (v) setField('plug-rr', v); }
    if (f.chkSize) { setField('plug-choke', f.chkSize.value); }
    
    // --- FLUID PROPERTIES (In/Out split) ---
    if (f.mudWt) {
        const io = parseInOut(f.mudWt.value);
        if (io.inVal) { const v = parseNum(io.inVal); if (v) setField('plug-mw-in', v); }
        if (io.outVal) { const v = parseNum(io.outVal); if (v) setField('plug-mw-out', v); }
    }
    if (f.mudVisc) {
        const io = parseInOut(f.mudVisc.value);
        if (io.inVal) { const v = parseNum(io.inVal); if (v) setField('plug-mv-in', v); }
        if (io.outVal) { const v = parseNum(io.outVal); if (v) setField('plug-mv-out', v); }
    }
    if (f.chlorides) {
        const io = parseInOut(f.chlorides.value);
        if (io.inVal) { const v = parseChlorides(io.inVal); if (v) setField('plug-cl-in', v); }
        if (io.outVal) { const v = parseChlorides(io.outVal); if (v) setField('plug-cl-out', v); }
    }
    
    // --- MARKER & RETURNS ---
    if (f.marker) { 
        const mv = f.marker.value.trim();
        if (mv && mv !== '—') {
            const mm = mv.match(/^(\d{1,2}):(\d{2})/);
            if (mm) setField('plug-marker-sent', mm[1].padStart(2,'0') + ':' + mm[2]);
        }
    }
    if (f.surfaceTime) {
        const sv = f.surfaceTime.value.trim();
        if (sv && sv !== '—') {
            const sm = sv.match(/^(\d{1,2}):(\d{2})/);
            if (sm) setField('plug-surface-time', sm[1].padStart(2,'0') + ':' + sm[2]);
        }
    }
    
    // --- SHOWS / OTHER ---
    if (f.sand && f.sand.value && f.sand.value !== '—') {
        const sandSel = document.getElementById('plug-sand');
        if (sandSel) {
            const sv = f.sand.value.toLowerCase().trim();
            for (const opt of sandSel.options) {
                if (opt.value === sv) { sandSel.value = sv; synced.push('plug-sand'); break; }
            }
        }
    }
    if (f.gas && f.gas.value && f.gas.value !== '—') {
        const gasSel = document.getElementById('plug-gas');
        if (gasSel) {
            const gv = f.gas.value.toLowerCase().trim();
            for (const opt of gasSel.options) {
                if (opt.value === gv) { gasSel.value = gv; synced.push('plug-gas'); break; }
            }
        }
    }
    if (f.interval && f.interval.value && f.interval.value !== '—') setField('plug-int', f.interval.value);
    if (f.stalls && f.stalls.value && f.stalls.value !== '—') setField('plug-stalls', f.stalls.value);
    if (f.fr && f.fr.value && f.fr.value !== '—') setField('plug-fr', f.fr.value);
    if (f.pop && f.pop.value && f.pop.value !== '—') setField('plug-pop', f.pop.value);
    if (f.comments && f.comments.value && f.comments.value !== '—') setField('plug-comments', f.comments.value);
    
    // --- Trigger plug tab updates ---
    if (synced.length > 0) {
        updatePlugHeader();
        savePlugData();
    }
    
    // --- INJECTION TAB: Sync pump rate ---
    if (f.pr) {
        const prNum = parseFloat(f.pr.value);
        if (!isNaN(prNum) && prNum >= 1 && prNum <= 8) {
            const sel = document.getElementById('pump-rate-select');
            const options = Array.from(sel.options).map(o => parseFloat(o.value)).filter(v => !isNaN(v));
            let closest = options[0], minDiff = Math.abs(prNum - closest);
            for (const opt of options) {
                const diff = Math.abs(prNum - opt);
                if (diff < minDiff) { closest = opt; minDiff = diff; }
            }
            if (minDiff <= 0.25) {
                sel.value = closest.toString();
                updatePumpRate();
            }
        }
    }
    
    return synced;
}

function processChatFeed() {
    let text = '';
    
    if (chatFeedCurrentTab === 'paste') {
        text = document.getElementById('cf-text-input').value.trim();
        if (!text) { alert('Paste some chat text first'); return; }
    } else {
        if (!chatFeedImageData) { alert('Upload a screenshot first'); return; }
        // For image mode, show a message that OCR needs AI API
        // For now, prompt user to manually transcribe or use paste mode
        alert('Screenshot processing requires an AI vision API (coming soon).\n\nFor now, copy the text from the chat and use Paste mode.');
        switchChatFeedTab('paste');
        return;
    }
    
    const records = parseDrillingReport(text);
    
    if (records.length === 0) {
        document.getElementById('cf-results-container').innerHTML = `
            <div class="chat-feed-results">
                <div style="padding:20px;text-align:center;color:#ef5350;">
                    <div style="font-size:28px;margin-bottom:8px">⚠️</div>
                    <div style="font-size:13px;font-weight:600">No data extracted</div>
                    <div style="font-size:11px;color:#888;margin-top:4px">Check that the text matches a drilling report format</div>
                </div>
            </div>`;
        return;
    }
    
    // Save to history
    const entry = {
        id: Date.now(),
        timestamp: new Date().toLocaleString(),
        records: records,
        source: chatFeedCurrentTab
    };
    chatFeedHistory.unshift(entry);
    if (chatFeedHistory.length > 50) chatFeedHistory = chatFeedHistory.slice(0, 50);
    localStorage.setItem('ips_chat_feed_history', JSON.stringify(chatFeedHistory));
    
    // Render results
    renderChatFeedResults(records, 'cf-results-container', true);
    renderChatFeedHistory();
    updateChatFeedBadge();
    
    // === AUTO-SYNC: Push extracted data into Plugs tab and Injection tab ===
    const latestRecord = records[records.length - 1]; // use most recent plug
    if (latestRecord) {
        const synced = applyChatFeedToApp(latestRecord);
        if (synced.length > 0) {
            const btn = document.getElementById('cf-process-btn');
            const origText = btn.innerHTML;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Extracted — ' + synced.length + ' fields synced';
            btn.style.background = '#2e7d32';
            setTimeout(() => { btn.innerHTML = origText; btn.style.background = ''; }, 3000);
        }
    }
    
    // Clear input
    document.getElementById('cf-text-input').value = '';
}

function renderChatFeedResults(records, containerId, isNew) {
    const container = document.getElementById(containerId);
    let html = '<div class="chat-feed-results">';
    html += '<div class="chat-feed-results-header">';
    html += '<span class="chat-feed-results-title">' + (isNew ? '✓ Extracted' : 'Saved') + '</span>';
    html += '<span class="chat-feed-results-count">' + records.length + ' record' + (records.length !== 1 ? 's' : '') + '</span>';
    html += '</div><div class="chat-feed-results-body">';
    
    for (const rec of records) {
        const f = rec.fields;
        const plugLabel = f.plug ? f.plug.value : 'Unknown';
        const depthLabel = f.depth ? f.depth.value : '';
        const timeLabel = f.time ? f.time.value : '';
        
        html += '<div class="chat-feed-record">';
        html += '<div class="chat-feed-record-header">';
        html += '<span class="chat-feed-record-plug">Plug ' + plugLabel + '</span>';
        html += '<span class="chat-feed-record-depth">' + (depthLabel ? depthLabel + ' ft' : '') + '</span>';
        if (timeLabel) html += '<span class="chat-feed-record-time">' + timeLabel + '</span>';
        html += '</div>';
        
        // Drilling params grid
        const drillingKeys = ['jnt','drill','washTime','rihWt','nw','puWt','torqueOff','torqueOn','rpm','wob','circ','pr','mp','rr','chkSize','eta'];
        const drillingFields = drillingKeys.filter(k => f[k] && f[k].value && f[k].value !== '—');
        
        if (drillingFields.length > 0) {
            html += '<div class="chat-feed-field-grid">';
            for (const k of drillingFields) {
                html += '<div class="chat-feed-field"><span class="chat-feed-field-label">' + f[k].label + '</span><span class="chat-feed-field-value">' + f[k].value + '</span></div>';
            }
            html += '</div>';
        }
        
        // Mud properties section
        const mudKeys = ['mudWt','mudVisc','chlorides'];
        const mudFields = mudKeys.filter(k => f[k] && f[k].value && f[k].value !== '—');
        if (mudFields.length > 0) {
            html += '<div class="chat-feed-mud-section">';
            html += '<div class="chat-feed-mud-title">Mud Properties</div>';
            html += '<div class="chat-feed-field-grid">';
            for (const k of mudFields) {
                html += '<div class="chat-feed-field"><span class="chat-feed-field-label">' + f[k].label + '</span><span class="chat-feed-field-value">' + f[k].value + '</span></div>';
            }
            html += '</div></div>';
        }
        
        // Shows
        const showKeys = ['sand','gas','stalls','fr','pop','marker','surfaceTime','interval','comments'];
        const showFields = showKeys.filter(k => f[k] && f[k].value && f[k].value !== '—');
        if (showFields.length > 0) {
            html += '<div style="margin-top:6px">';
            for (const k of showFields) {
                const color = (k === 'sand' || k === 'gas') ? '#ffa726' : '#888';
                html += '<span style="display:inline-block;font-size:10px;background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:3px;margin:2px;color:' + color + '">' + f[k].label + ': ' + f[k].value + '</span>';
            }
            html += '</div>';
        }
        
        html += '</div>';
    }
    
    html += '</div></div>';
    container.innerHTML = html;
}

function renderChatFeedHistory() {
    const section = document.getElementById('cf-history-section');
    const container = document.getElementById('cf-history-results');
    
    if (chatFeedHistory.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    let html = '';
    
    for (const entry of chatFeedHistory.slice(0, 10)) {
        const totalRecs = entry.records.length;
        const firstPlug = entry.records[0]?.fields?.plug?.value || '?';
        const lastPlug = entry.records[totalRecs - 1]?.fields?.plug?.value || '?';
        
        html += '<div class="chat-feed-record" style="cursor:pointer" onclick="expandChatFeedHistoryEntry(' + entry.id + ')">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center">';
        html += '<div>';
        html += '<div style="font-size:13px;font-weight:600;color:#e0e0e0">' + totalRecs + ' record' + (totalRecs !== 1 ? 's' : '') + ' — Plug ' + (totalRecs > 1 ? firstPlug + ' to ' + lastPlug : firstPlug) + '</div>';
        html += '<div style="font-size:10px;color:#888">' + entry.timestamp + '</div>';
        html += '</div>';
        html += '<span style="color:#4fc3f7;font-size:16px">›</span>';
        html += '</div>';
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function expandChatFeedHistoryEntry(id) {
    const entry = chatFeedHistory.find(e => e.id === id);
    if (!entry) return;
    renderChatFeedResults(entry.records, 'cf-results-container', false);
}

function clearChatFeedHistory() {
    if (!confirm('Clear extraction log?')) return;
    chatFeedHistory = [];
    localStorage.setItem('ips_chat_feed_history', JSON.stringify(chatFeedHistory));
    renderChatFeedHistory();
    document.getElementById('cf-results-container').innerHTML = '';
    updateChatFeedBadge();
}

function updateChatFeedBadge() {
    const badge = document.getElementById('chat-feed-badge');
    const btn = document.getElementById('chat-feed-btn');
    const count = chatFeedHistory.length;
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.add('show');
        btn.classList.add('has-data');
    } else {
        badge.classList.remove('show');
        btn.classList.remove('has-data');
    }
}

// Init badge on load
setTimeout(updateChatFeedBadge, 100);

function inviteUserToRoom() {
    if (!profileData.wellName) {
        alert('Set a well name first to create a room.');
        return;
    }
    const baseUrl = window.location.origin + window.location.pathname;
    const inviteUrl = baseUrl + '?well=' + encodeURIComponent(profileData.wellName);
    const shareText = '📋 Join my IPS Tracker room for ' + profileData.wellName + '\n\nTap the link to auto-connect:\n' + inviteUrl;
    
    if (navigator.share) {
        navigator.share({
            title: 'IPS Tracker - Join Room',
            text: shareText,
            url: inviteUrl
        }).catch(() => {
            // Share cancelled, copy to clipboard
            navigator.clipboard.writeText(inviteUrl).then(() => alert('Invite link copied to clipboard!')).catch(() => alert('Invite link:\n' + inviteUrl));
        });
    } else {
        navigator.clipboard.writeText(inviteUrl).then(() => alert('Invite link copied to clipboard!')).catch(() => alert('Invite link:\n' + inviteUrl));
    }
}

function initApp() {
    console.log('initApp called, data:', data.pumpTanks.length, 'pump tanks,', data.returnTanks.length, 'return tanks');
    loadProfile();
    loadData();
    // Migrate: Rename "Return Tank" → "Settling Tank"
    let migrated = false;
    (data.returnTanks || []).forEach(t => {
        if (t.name && t.name.startsWith('Return Tank')) {
            t.name = t.name.replace('Return Tank', 'Settling Tank');
            migrated = true;
        }
    });
    if (migrated) saveData();
    loadBleOffset();
    console.log('After loadData:', data.pumpTanks.length, 'pump tanks,', data.returnTanks.length, 'return tanks');
    loadInjUI();
    renderTransferLog();
    renderVolumeLog();
    loadTitrationLog();
    renderTitrationLog();
    loadPlugData();
    renderPlugLog();
    loadVolData();
    console.log('About to render, pump-tanks element:', document.getElementById('pump-tanks'));
    render();
    
    // Initialize Firebase and auto-join room if well name is set
    // Check URL for invite room parameter
    const urlParams = new URLSearchParams(window.location.search);
    const inviteRoom = urlParams.get('room');
    const inviteWell = urlParams.get('well');
    if (inviteWell && inviteWell !== profileData.wellName) {
        profileData.wellName = inviteWell;
        localStorage.setItem('ipsProfile', JSON.stringify(profileData));
        document.getElementById('profile-well-input').value = inviteWell;
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
    }
    if (firebaseInit() && profileData.wellName) {
        firebaseJoinRoom(profileData.wellName);
    }
}

// Multiple fallbacks to ensure init runs
let initRun = false;
function safeInit() {
    if (initRun) return;
    initRun = true;
    initApp();
}

if (document.readyState === 'complete') {
    safeInit();
} else if (document.readyState === 'interactive') {
    safeInit();
} else {
    document.addEventListener('DOMContentLoaded', safeInit);
}
window.addEventListener('load', safeInit);

// Register service worker for PWA fullscreen
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>

    <!-- ========== UNIVERSAL LOG EDIT MODAL ========== -->
    <div class="modal" id="log-edit-modal">
        <div class="log-edit-overlay" onclick="hideLogEditModal()"></div>
        <div class="log-edit-panel">
            <div class="log-edit-header">
                <span class="log-edit-title" id="log-edit-title">Edit Log</span>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="log-edit-clear-btn" id="log-edit-clear-btn" onclick="logEditClearAll()">Clear All</button>
                    <button class="log-edit-close-btn" onclick="hideLogEditModal()">✕</button>
                </div>
            </div>
            <div class="log-edit-body" id="log-edit-body"></div>
        </div>
    </div>
</body>
</html>
